!function(){function t(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function e(t){return{left:function(e,r,n,i){for(arguments.length<3&&(n=0),arguments.length<4&&(i=e.length);n<i;){var o=n+i>>>1;t(e[o],r)<0?n=o+1:i=o}return n},right:function(e,r,n,i){for(arguments.length<3&&(n=0),arguments.length<4&&(i=e.length);n<i;){var o=n+i>>>1;t(e[o],r)>0?i=o:n=o+1}return n}}}_.float=parseFloat,_.gcd=function(t){if(2===t.length){for(var e,r=t[0],n=t[1];n>0;)e=n,n=r%n,r=e;return r}var i,o=t[0],s=t.length;for(i=1;i<s;i++)o=_.gcd([o,t[i]]);return o},_.lcm=function(t){if(2===t.length){var e=t[0],r=t[1];return e*(r/_.gcd([e,r]))}var n,i=t[0],o=t.length;for(n=1;n<o;n++)i=_.lcm([i,t[n]]);return i},_.format=function(){var t=_.toArray(arguments);return t.shift().replace(/{(\d+)}/g,function(e,r){return void 0!==t[r]?t[r]:e})},_.insert=function(t,e,r){return Array.prototype.splice.apply(t,[e,0].concat(r)),t},_.move=function(t,e,r){for(var n=t.length;e<0;)e+=n;for(;r<0;)r+=n;if(r>=n)for(var i=r-n;1+i--;)t.push(void 0);return t.splice(r,0,t.splice(e,1)[0]),t},_.permute=function(t,e){return _.isFunction(e)?_.reduce(t,function(t,r,n){return t[e(n,r)]=r,t},[]):_.isArray(e)?_.reduce(e,function(r,n,i){return r[i]=t[e[i]],r},[]):t},_.bisector=function(r){return e(1===r.length?function(e,n){return t(r(e),n)}:r)},_.ascendingKey=function(t){return"function"==typeof t?function(e,r){return t(e)<t(r)?-1:t(e)>t(r)?1:t(e)>=t(r)?0:NaN}:function(e,r){return e[t]<r[t]?-1:e[t]>r[t]?1:e[t]>=r[t]?0:NaN}},_.isIE=function(){var t=global.navigator,e=(t&&t.userAgent||"").toLowerCase(),r=e.indexOf("MSIE ");return!!(r>0||e.match(/Trident.*rv\:11\./))&&parseInt(e.substring(r+5,e.indexOf(".",r)))}}(),function(){var t="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")(),e=navigator;t.Graph=function(t){Graph.BOOTSTRAPS.push(t)},Graph.BOOTSTRAPS=[],Graph.VERSION="1.0.0",Graph.AUTHOR="Kreasindo Cipta Teknologi",Graph.cached={},Graph.config={base:"../",locale:"id",dom:"light",svg:{version:"1.1"},xmlns:{svg:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",html:"http://www.w3.org/1999/xhtml"},font:{family:"Segoe UI",size:"12px",line:1},resizer:{image:"resize-control.png",size:17},rotator:{image:"rotator.png",size:21}},Graph.setup=function(t,e){var r,n,i=["icons","string","styles"];if(_.isPlainObject(t))for(r in t)n=t[r],-1!==i.indexOf(r)?_.extend(Graph[r],n):_.isPlainObject(n)?_.extend(Graph.config[r],n):Graph.config[r]=n;else-1!==i.indexOf(t)?_.extend(Graph[t],e):_.isPlainObject(e)?_.extend(Graph.config[t],e):Graph.config[t]=e},Graph.string={ID_VECTOR:"graph-vector-id",ID_SHAPE:"graph-shape-id",ID_LINK:"graph-link-id",ID_PORT:"graph-port-id"},Graph.styles={VECTOR:"graph-elem",PAPER:"graph-paper",VIEWPORT:"graph-viewport",SHAPE:"graph-shape",SHAPE_BLOCK:"comp-block",SHAPE_LABEL:"comp-label",SHAPE_HEADER:"comp-header",SHAPE_CHILD:"comp-child",SHAPE_DRAG:"shape-draggable",LINK_HEAD:"graph-link-head",LINK_TAIL:"graph-link-tail"
},Graph.icons={ZOOM_IN:'<i class="ion-android-add"></i>',ZOOM_OUT:'<i class="ion-android-remove"></i>',ZOOM_RESET:'<i class="ion-pinpoint"></i>',SHAPE:'<i class="bpmn-icon-start-event-none"></i>',SHAPE_LANE:'<i class="bpmn-icon-participant"></i>',SHAPE_LINK:'<i class="ion-android-share-alt"></i>',SHAPE_ACTION:'<i class="bpmn-icon-task"></i>',SHAPE_ROUTER:'<i class="bpmn-icon-gateway-none"></i>',LANE_ABOVE:'<i class="bpmn-icon-lane-insert-above"></i>',LANE_BELOW:'<i class="bpmn-icon-lane-insert-below"></i>',CONFIG:'<i class="bpmn-icon-screw-wrench"></i>',LINK:'<i class="bpmn-icon-connection-multi"></i>',TRASH:'<i class="bpmn-icon-trash"></i>',SEND_TO_BACK:'<i class="font-icon-send-back"></i>',SEND_TO_FRONT:'<i class="font-icon-bring-front"></i>',MOVE_UP:'<i class="ion-android-arrow-up"></i>',MOVE_DOWN:'<i class="ion-android-arrow-down"></i>',ROUTER_OR:'<i class="bpmn-icon-gateway-or"></i>',ROUTER_XOR:'<i class="bpmn-icon-gateway-xor"></i>',ROUTER_NONE:'<i class="bpmn-icon-gateway-none"></i>',ROUTER_PARALLEL:'<i class="bpmn-icon-gateway-parallel"></i>'},Graph.doc=function(){},Graph.global=function(){},Graph.isHTML=function(t){return t instanceof HTMLElement},Graph.isSVG=function(t){return t instanceof SVGElement},Graph.isElement=function(t){return t instanceof Graph.dom.Element},Graph.isMac=function(){return/mac/i.test(e.platform)},Graph.ns=function(e){var r=Graph.lookup("Graph","ns",e);if(r.clazz)return r.clazz;var n,i,o=_.split(e,"."),s=t,a=o.length;for(i=0;i<a;i++)n=o[i],s[n]=s[n]||{},s=s[n];return _.isFunction(s)&&(r.clazz=s),s},Graph.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},Graph.hash=function(t){var e,r,n=2166136261;for(e=0,r=t.length;e<r;e++)n^=t.charCodeAt(e),n+=(n<<1)+(n<<4)+(n<<7)+(n<<8)+(n<<24);return("0000000"+(n>>>0).toString(16)).substr(-8)},Graph.create=function(t,e){},Graph.factory=function(t,e){return e=[t].concat(e),new(Function.prototype.bind.apply(t,e))},Graph.expand=function(t,e,r){var n=t.constructor.prototype,i=e.constructor.prototype;r=_.defaultTo(e),_.forOwn(i,function(t,e){_.isFunction(t)&&_.isUndefined(n[e])&&function(t,e){n[t]=_.bind(e,r)}(e,t)})},Graph.extend=function(t,e){return _.isPlainObject(t)&&(e=t,t=Graph.lang.Class),t.extend(e)},Graph.mixin=function(t,e){this.extend(t,e,t)},Graph.lookup=function(t,e){var r,n,i=_.toArray(arguments);return t=i.shift(),e=_.join(i,"|"),r=Graph.cached[t]=Graph.cached[t]||{},n="Regex.event"==t?null:100,r[e]?r[e].credit=n:r[e]={credit:n,remove:function(t,e){return function(){delete Graph.cached[t][e]}}(t,e)},_.debounce(function(t){_.forOwn(r,function(e,n){n!=t&&null!==r[n].credit&&--r[n].credit<=0&&delete r[n]})})(e),r[e]},Graph.memoize=function(t){return function e(){var r=_.toArray(arguments),n=_.join(r,"â€"),i=e.cache=e.cache||{},o=e.saved=e.saved||[];if(!_.isUndefined(i[n])){for(var s=0,a=o.length;s<a;s++)if(o[s]==n){o.push(o.splice(s,1)[0]);break}return i[n]}
return o.length>=1e3&&delete i[o.shift()],o.push(n),i[n]=t.apply(this,r),i[n]}},Graph.defer=function(){return $.Deferred()},Graph.when=$.when,Graph.paper=function(t,e,r){return Graph.factory(Graph.svg.Paper,[t,e,r])},Graph.svg=function(t){var e,r=_.toArray(arguments);return t=r.shift(),e=Graph.factory(Graph.svg[_.capitalize(t)],r),r=null,e},Graph.shape=function(t,e){var r,n,i;return i=t.lastIndexOf("."),t=t.substr(0,i)+"."+_.capitalize(t.substr(i+1)),r=Graph.ns("Graph.shape."+t),n=Graph.factory(r,e),i=t=r=null,n},Graph.layout=function(t){},Graph.router=function(t){},Graph.link=function(t){},Graph.plugin=function(t){},Graph.diagram=function(t,e){var r;return r=Graph.diagram.type[_.capitalize(t)],Graph.factory(r,[e])},Graph.diagram.type={},Graph.diagram.util={},Graph.diagram.pallet={},Graph.pallet=function(t,e){var r;return r=Graph.diagram.pallet[_.capitalize(t)],Graph.factory(r,[e])},Graph.topic={subscribers:{},publish:function(t,e,r){var n=Graph.topic.subscribers,i=n[t]||[];_.forEach(i,function(t){t&&t.call(null,e,r)})},subscribe:function(t,e){if(_.isPlainObject(t)){var r=[];return _.forOwn(t,function(t,e){!function(t,e){var n=Graph.topic.subscribe(t,e);r.push({topic:t,sub:n})}(e,t)}),{unsubscribe:function(t){return function(e){if(e){var r=_.find(t,function(t){return t.topic==e});r&&r.sub.unsubscribe()}else _.forEach(t,function(t){t.sub.unsubscribe()})}}(r)}}var n=Graph.topic.subscribers;return n[t]=n[t]||[],n[t].push(e),{unsubscribe:function(t,e){return function(){Graph.topic.unsubscribe(t,e)}}(t,e)}},unsubscribe:function(t,e){for(var r=Graph.topic.subscribers,n=r[t]||[],i=n.length-1;i>=0;i--)n[i]===e&&n.splice(i,1)}},Graph.message=function(t,e){e=_.defaultTo(e,"info"),Graph.topic.publish("graph:message",{type:e,message:t})},t.graphConfig&&Graph.setup(t.graphConfig),Graph._=function(t){return t},Graph.ns("Graph.lang"),Graph.ns("Graph.collection"),Graph.ns("Graph.registry"),Graph.ns("Graph.data"),Graph.ns("Graph.popup"),Graph.ns("Graph.shape.activity"),Graph.ns("Graph.shape.common")}(),function(){var t=/(\-?[0-9.]+)\s*,\s*(\-?[0-9.]+)/g,t=/(\-?[0-9.]+)\s*,\s*(\-?[0-9.]+)/g,e=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],r=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472];Graph.util={deg:function(t){return Math.round(180*t/Math.PI%360*1e3)/1e3},rad:function(t){return t%360*Math.PI/180},angle:function(t,e){var r=t.x-e.x,n=t.y-e.y;return r||n?(180+180*Math.atan2(-n,-r)/Math.PI+360)%360:0},theta:function(t,e){var r,n,i=-(e.y-t.y),o=e.x-t.x;return r=0==i.toFixed(10)&&0==o.toFixed(10)?0:Math.atan2(i,o),r<0&&(r=2*Math.PI+r),n=180*r/Math.PI,n=n%360+(n<0?360:0)},taxicab:function(t,e){var r=t.x-e.x,n=t.y-e.y;return r*r+n*n},hypo:function(t,e){return Math.sqrt(t*t+e*e)},sign:function(t){return t<0?-1:1},quadrant:function(t,e){return t>=0&&e>=0?1:t>=0&&e<0?4:t<0&&e<0?3:2},gradient:function(t,e){return e.x==t.x?e.y>t.y?1/0:-1/0:e.y==t.y?e.x>t.x?0:-0:(e.y-t.y)/(e.x-t.x)},snapValue:function(t,e,r){
if(r=_.defaultTo(r,10),_.isArray(e)){for(var n=e.length;n--;)if(Math.abs(e[n]-t)<=r)return e[n]}else{e=+e;var i=t%e;if(i<r)return t-i;if(i>t-r)return t-i+e}return t},pointbox:function(t,e,r){_.isPlainObject(t)&&(r=e,e=t.y,t=t.x),r=r||0;var n=t-r,i=e-r,o=t+r,s=e+r;return{x:n,y:i,x2:o,y2:s,width:o-n,height:s-i}},pointAlign:function(t,e,r){return!(!t||!e)&&(r=r||2,Math.abs(t.x-e.x)<=r?"h":Math.abs(t.y-e.y)<=r&&"v")},pointDistance:function(t,e){return t&&e?Graph.util.hypo(t.x-e.x,t.y-e.y):-1},isPointEquals:function(t,e){return t.x==e.x&&t.y==e.y},isPointOnLine:function(t,e,r){if(!t||!e||!r)return!1;var n=(e.x-t.x)*(r.y-t.y)-(e.y-t.y)*(r.x-t.x),i=Graph.util.pointDistance(t,e);return Math.abs(n/i)<2},polar2point:function(t,e,r){var n,i,o;return _.isUndefined(r)&&(r=Graph.point(0,0)),n=Math.abs(t*Math.cos(e)),i=Math.abs(t*Math.sin(e)),o=Graph.util.deg(e),o<90?i=-i:o<180?(n=-n,i=-i):o<270&&(n=-n),Graph.point(r.props.x+n,r.props.y+i)},isBoxContainsPoint:function(t,e){return e.x>=t.x&&e.x<=t.x2&&e.y>=t.y&&e.y<=t.y2},isBoxIntersect:function(t,e){var r=Graph.util.isBoxContainsPoint;return r(e,{x:t.x,y:t.y})||r(e,{x:t.x2,y:t.y})||r(e,{x:t.x,y:t.y2})||r(e,{x:t.x2,y:t.y2})||r(t,{x:e.x,y:e.y})||r(t,{x:e.x2,y:e.y})||r(t,{x:e.x,y:e.y2})||r(t,{x:e.x2,y:e.y2})||(t.x<e.x2&&t.x>e.x||e.x<t.x2&&e.x>t.x)&&(t.y<e.y2&&t.y>e.y||e.y<t.y2&&e.y>t.y)},boxOrientation:function(t,e,r,n){r=_.defaultTo(r,0),n=_.defaultTo(n,r);var i=t.y2+n<=e.y,o=t.x-r>=e.x2,s=t.y-n>=e.y2,a=t.x2+r<=e.x,p=i?"top":s?"bottom":null,h=a?"left":o?"right":null;return h&&p?p+"-"+h:h||p||"intersect"},expandBox:function(t,e,r){return e=_.defaultTo(e,0),r=_.defaultTo(r,0),t.x-=e,t.x2+=e,t.y-=r,t.y2+=r,t.width=t.x2-t.x,t.height=t.y2-t.y,t},groupBox:function(t){var e=[],r=[],n=[],i=[];return t.length?(_.forEach(t,function(t){e.push(t.x),r.push(t.y),n.push(t.x+t.width),i.push(t.y+t.height)}),e=_.min(e),r=_.min(r),n=_.max(n),i=_.max(i),{x:e,y:r,x2:n,y2:i,width:n-e,height:i-r}):{x:0,y:0,x2:0,y2:0,width:0,height:0}},midpoint:function(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}},movepoint:function(t,e,r){var n=Graph.util.rad(Graph.util.theta(e,t)),i=Math.cos(n)*r,o=-Math.sin(n)*r;return t.x+=i,t.y+=o,t},lineBendpoints:function(t,e,r){var n,i,o=[],s=t.x,a=t.y,p=e.x,h=e.y;return r=r||"h:h","h:v"==r?o=[{x:p,y:a}]:"v:h"==r?o=[{x:s,y:h}]:"h:h"==r?(n=Math.round((p-s)/2+s),o=[{x:n,y:a},{x:n,y:h}]):"v:v"==r?(i=Math.round((h-a)/2+a),o=[{x:s,y:i},{x:p,y:i}]):o=[],o},lineIntersection:function(t,e,r,n,i,o,s,a){if(Math.max(t,r)<Math.min(i,s)||Math.min(t,r)>Math.max(i,s)||Math.max(e,n)<Math.min(o,a)||Math.min(e,n)>Math.max(o,a))return null;var p=(t*n-e*r)*(i-s)-(t-r)*(i*a-o*s),h=(t*n-e*r)*(o-a)-(e-n)*(i*a-o*s),c=(t-r)*(o-a)-(e-n)*(i-s);if(!c)return null;var l=p/c,u=h/c,d=+l.toFixed(2),f=+u.toFixed(2)
;return d<+Math.min(t,r).toFixed(2)||d>+Math.max(t,r).toFixed(2)||d<+Math.min(i,s).toFixed(2)||d>+Math.max(i,s).toFixed(2)||f<+Math.min(e,n).toFixed(2)||f>+Math.max(e,n).toFixed(2)||f<+Math.min(o,a).toFixed(2)||f>+Math.max(o,a).toFixed(2)?null:{x:l,y:u}},perpendicular:function(t,e,r){var n,i,o,s;n=Graph.util.gradient(t,e),i=0===n?0:-1/n,o=Math.atan(i);var s=r*Math.cos(o),a=(t.x+e.x)/2,p=(t.y+e.y)/2,h=p-a*i,c=a+s;return{from:{x:a,y:p},to:{x:c,y:i*c+h}}},points2path:function(t){var e=_.map(t,function(t,e){return[0===e?"M":"L",t.x,t.y]});return Graph.util.segments2path(e)},path2points:function(t){var e=Graph.util.path2segments(t);return _.map(e,function(t,e){return"M"==t[0]||"L"==t[0]?{x:t[1],y:t[2]}:{x:t[5],y:t[6]}})},segments2path:function(t){return _.join(t||[],",").replace(/,?([achlmqrstvxz]),?/gi,"$1")},path2segments:function(t){if(!t)return[];var e=Graph.lookup("Graph.util","path2segments",t),r={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},n=[];return e.segments?_.cloneDeep(e.segments):(t.replace(/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,function(t,e,i){var o=[],s=e.toLowerCase();if(i.replace(/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,function(t,e){e&&o.push(+e)}),"m"==s&&o.length>2&&(n.push(_.concat([e],o.splice(0,2))),s="l",e="m"==e?"l":"L"),"r"==s)n.push(_.concat([e],o));else for(;o.length>=r[s]&&(n.push(_.concat([e],o.splice(0,r[s]))),r[s]););}),e.segments=_.cloneDeep(n),n)},polygon2dots:function(e){var r=[];return e.replace(t,function(t,e,n){r.push([_.float(e),_.float(n)])}),r},polygon2path:function(t){var e=Graph.util.polygon2dots(t);if(!e.length)return"M0,0";for(var t="M"+e[0][0]+","+e[0][1],r=1,n=e.length;r<n;r++)t+="L"+e[r][0]+","+e[r][1]+",";return t=t.substring(0,t.length-1),t+="Z"},transform2segments:Graph.memoize(function(t){var e={matrix:!0,translate:!0,rotate:!0,scale:!0,skewX:!0,skewY:!0};t+="";var r=[],n=t.match(/((matrix|translate|rotate|scale|skewX|skewY)*\((\-?\d+\.?\d*e?\-?\d*[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+\))+/g);return n&&_.forEach(n,function(t){var n=t.match(/[\w\.\-]+/g),i=n.shift()
;e[i]&&(n=_.map(n,function(t){return+t}),r.push([i].concat(n)))}),r}),curvebox:Graph.memoize(function(t,e,r,n,i,o,s,a){var p=_.join(arguments,"_"),h=Graph.lookup("Graph.util","curvebox",p);if(p=null,h.curvebox)return h.curvebox;for(var c,l,u,d,f,g,y,v,m=[],x=[[],[]],b=0;b<2;++b)if(0==b?(l=6*t-12*r+6*i,c=-3*t+9*r-9*i+3*s,u=3*r-3*t):(l=6*e-12*n+6*o,c=-3*e+9*n-9*o+3*a,u=3*n-3*e),Math.abs(c)<1e-12){if(Math.abs(l)<1e-12)continue;0<(d=-u/l)&&d<1&&m.push(d)}else y=l*l-4*u*c,v=Math.sqrt(y),y<0||(f=(-l+v)/(2*c),0<f&&f<1&&m.push(f),0<(g=(-l-v)/(2*c))&&g<1&&m.push(g));for(var G,w=m.length,k=w;w--;)d=m[w],G=1-d,x[0][w]=G*G*G*t+3*G*G*d*r+3*G*d*d*i+d*d*d*s,x[1][w]=G*G*G*e+3*G*G*d*n+3*G*d*d*o+d*d*d*a;return x[0][k]=t,x[1][k]=e,x[0][k+1]=s,x[1][k+1]=a,x[0].length=x[1].length=k+2,h.curvebox={min:{x:Math.min.apply(0,x[0]),y:Math.min.apply(0,x[1])},max:{x:Math.max.apply(0,x[0]),y:Math.max.apply(0,x[1])}},h.curvebox}),curveLength:function(t,n,i,o,s,a,p,h,c){c=_.defaultTo(c,1),c=c>1?1:c<0?0:c;for(var l=c/2,u=0,d=0;d<12;d++){var f=l*e[d]+l,g=Graph.util.curvePolynom(f,t,i,s,p),y=Graph.util.curvePolynom(f,n,o,a,h),v=g*g+y*y;u+=r[d]*Math.sqrt(v)}return l*u},curvePolynom:function(t,e,r,n,i){return t*(t*(-3*e+9*r-9*n+3*i)+6*e-12*r+6*n)-3*e+3*r},curveInterval:function(t,e,r,n,i,o,s,a,p){if(!(p<0||Graph.util.curveLength(t,e,r,n,i,o,s,a)<p)){var h,c=.5,l=1-c;for(h=Graph.util.curveLength(t,e,r,n,i,o,s,a,l);Math.abs(h-p)>.01;)c/=2,l+=(h<p?1:-1)*c,h=Graph.util.curveLength(t,e,r,n,i,o,s,a,l);return l}},pointAtInterval:function(t,e,r,n,i,o,s,a,p){var h=1-p,c=Math.pow(h,3),l=Math.pow(h,2),u=p*p,d=u*p,f=c*t+3*l*p*r+3*h*p*p*i+d*s,g=c*e+3*l*p*n+3*h*p*p*o+d*a,y=t+2*p*(r-t)+u*(i-2*r+t),v=e+2*p*(n-e)+u*(o-2*n+e),m=r+2*p*(i-r)+u*(s-2*i+r),x=n+2*p*(o-n)+u*(a-2*o+n),b=h*t+p*r,G=h*e+p*n,_=h*i+p*s,w=h*o+p*a,k=90-180*Math.atan2(y-m,v-x)/Math.PI;return k=90-180*Math.atan2(m-y,x-v)/Math.PI,{x:f,y:g,m:{x:y,y:v},n:{x:m,y:x},start:{x:b,y:G},end:{x:_,y:w},alpha:k}},curveIntersection:function(t,e,r){var n=Graph.util.curvebox.apply(null,t),i=Graph.util.curvebox.apply(null,e),o=0,s=[],a={x:n.min.x,y:n.min.y,x2:n.max.x,y2:n.max.y},p={x:i.min.x,y:i.min.y,x2:i.max.x,y2:i.max.y};if(!Graph.util.isBoxIntersect(a,p))return r?0:[];var h,c,l,u,d=Graph.util.curveLength.apply(null,t),f=Graph.util.curveLength.apply(null,e),g=~~(d/10),y=~~(f/10),v=[],m=[],x={};for(h=0;h<g+1;h++)l=h/g,u=Graph.util.pointAtInterval.apply(null,t.concat([l])),v.push({x:u.x,y:u.y,t:l});for(h=0;h<y+1;h++)l=h/y,u=Graph.util.pointAtInterval.apply(null,e.concat([l])),m.push({x:u.x,y:u.y,t:l});for(h=0;h<g;h++)for(c=0;c<y;c++){var b=v[h],G=v[h+1],_=m[c],w=m[c+1],k=Math.abs(G.x-b.x)<.001?"y":"x",C=Math.abs(w.x-_.x)<.001?"y":"x",S=Graph.util.lineIntersection(b.x,b.y,G.x,G.y,_.x,_.y,w.x,w.y);if(S){if(x[S.x.toFixed(4)]==S.y.toFixed(4))continue;x[S.x.toFixed(4)]=S.y.toFixed(4);var T=b.t+Math.abs((S[k]-b[k])/(G[k]-b[k]))*(G.t-b.t),E=_.t+Math.abs((S[C]-_[C])/(w[C]-_[C]))*(w.t-_.t);T>=0&&T<=1.001&&E>=0&&E<=1.001&&(o++,s.push({x:S.x,y:S.y,t1:T,t2:E}))}
}return r?o:s},convexSegment:function(t,e,r,n){if(!e||!r||!t)return null;var i=Graph.util.pointDistance(t,e),o=Graph.util.pointDistance(t,r);if(n=n||10,i>n&&o>n){var s,a=Graph.util.movepoint({x:t.x,y:t.y},e,-n/2),p=Graph.util.movepoint({x:t.x,y:t.y},r,-n/2),h=Graph.util.pointAlign(e,r,n/2);return"h"==h?s={x:t.x-n,y:t.y}:(a.y=e.y,p.y=r.y,s={x:t.x,y:t.y-n}),[["L",a.x,a.y],["Q",s.x,s.y,p.x,p.y]]}return null},smoothSegment:function(t,e,r,n){if(!e||!r||!t)return null;var i=Graph.util.pointDistance(t,e),o=Graph.util.pointDistance(t,r);if(n=n||6,i>n&&o>n){var s=Graph.util.movepoint({x:t.x,y:t.y},e,-n),a=Graph.util.movepoint({x:t.x,y:t.y},r,-n);return[["L",s.x,s.y],["Q",t.x,t.y,a.x,a.y]]}return null}}}(),function(){function t(t,e,r,n,i){var o=e.split(/\./),s=o.shift();n=_.defaultTo(n,!1),i=_.defaultTo(i,1500),t.listeners[s]=t.listeners[s]||[],t.listeners[s].push({eventType:e,priority:i,original:r,handler:_.bind(r,t),once:n})}function e(t,e,r){var n,i,o=e.split(/\./),s=o.shift(),a=t.listeners[s]||[];i=Graph.lookup("Regex.event",e),i.rgex?n=i.rgex:(n=new RegExp(_.escapeRegExp(e),"i"),i.rgex=n);for(var p=a.length-1;p>=0;p--)n.test(a[p].eventType)&&(r?r===a[p].original&&a.splice(p,1):a.splice(p,1));a.length||delete t.listeners[s]}var r=Graph.lang.Class=function(){};r.options={},r.prototype.constructor=r,r.prototype.toString=function(){return"Graph.lang.Class"},r.extend=function(r){var n,i,o,s,a,p;return n=this.prototype,i=Object.create(n),p={},_.forOwn(r,function(t,e){_.isFunction(t)?(i[e]=t,"constructor"==e&&(o=t)):p[e]=t}),o||(o=n.constructor),a=function(){if(!this.__initialized__){this.__initialized__=!0,this.listeners={};var t,e,r=this.superclass;for(e in p)this[e]=_.cloneDeep(p[e]);for(;r;){if(t=r.options)for(e in t)void 0!==this[e]?this[e]=_.merge(_.cloneDeep(t[e]),this[e]):this[e]=_.cloneDeep(t[e]);r=r.prototype.superclass}}o&&o.apply(this,arguments)},s=o.toString().match(/(function)?([^\{=]+)/),s="function"+s[2],a.toString=function(){return s},a.extend=n.constructor.extend,a.options=p,a.prototype=i,a.prototype.constructor=a,a.prototype.superclass=n.constructor,a.prototype.on=function(e,r,n,i){if(_.isPlainObject(e)){var o,s;for(o in e)s=e[o],_.isFunction(s)?t(this,o,s):t(this,o,s.handler,s.once,s.priority)}else t(this,e,r,n,i);return this},a.prototype.one=function(e,r){if(_.isPlainObject(e)){var n,i;for(n in e)i=e[n],_.isFunction(i)?t(this,n,i,!0):t(this,n,i.handler,!0,i.priority)}else t(this,e,r,!0);return this},a.prototype.off=function(t,r){var n=t.split(/\s/);if(n.length>1)for(var i=0,o=n.length;i<o;i++)e(this,n[i]);else e(this,t,r);return this},a.prototype.fire=function(t,e){var r,n,i,o,s,a,p,h,c=[],l=[];e=e||{},_.isString(t)?r=new Graph.lang.Event(t,e):(r=t,r.originalData=e,t=r.originalType||r.type),r.publisher=this,c.push(r),n=t.split(/\./),i=n.shift(),o=(this.listeners[i]||[]).slice();var a=Graph.lookup("Regex.event",t);if(a.rgex?s=a.rgex:(s=new RegExp(_.escapeRegExp(t),"i"),a.rgex=s),o.length)for(h=0,
p=o.length;h<p;h++)i==o[h].eventType?(o[h].once&&l.push(o[h]),o[h].handler.apply(o[h].handler,c)):s.test(o[h].eventType)&&(o[h].once&&l.push(o[h]),o[h].handler.apply(o[h].handler,c));if(l.length)for(h=0,p=l.length;h<p;h++)this.off(l[h].eventType,l[h].original)},a}}(),function(){var t=Graph.lang.Error=function(t){this.message=t;var e=new Error;this.stack=e.stack,e=null};t.options={message:""},t.extend=Graph.lang.Class.extend,t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t.prototype.name="Graph.lang.Error",t.prototype.message="",Graph.error=function(t){return new Graph.lang.Error(t)},Graph.isError=function(t){return t instanceof Graph.lang.Error}}(),function(t,e){var r=Graph.lang.Event=function(t,e){this.type=t,this.originalData=null,this.cancelBubble=!1,this.defaultPrevented=!1,this.propagationStopped=!1,this.immediatePropagationStopped=!1,this.init(e)};r.options={type:null,originalData:null,cancelBubble:!1,defaultPrevented:!1,propagationStopped:!1,immediatePropagationStopped:!1},r.extend=Graph.lang.Class.extend,r.prototype.constructor=r,r.prototype.init=function(e){e&&(this.originalData=e,t.assign(this,e||{}))},r.prototype.stopPropagation=function(){this.cancelBubble=this.propagationStopped=!0},r.prototype.stopImmediatePropagation=function(){this.immediatePropagationStopped=this.propagationStopped=!0},r.prototype.preventDefault=function(){this.defaultPrevented=!0},r.prototype.toString=function(){return"Graph.lang.Event"},Graph.event=function(t,e){return new Graph.lang.Event(t,e)},Graph.isEvent=function(t){return t instanceof Graph.lang.Event},Graph.event.ESC=27,Graph.event.ENTER=13,Graph.event.DELETE=46,Graph.event.SHIFT=16,Graph.event.CTRL=17,Graph.event.CMD=91,Graph.event.C=67,Graph.event.V=86,Graph.event.fix=function(t){return e.event.fix(t)},Graph.event.target=function(t){var e=t.originalEvent||t,r=e.target;if("shadow"==Graph.config.dom){var n=e.path||e.composedPath&&e.composedPath();n&&(r=n[0])}return r},Graph.event.original=function(t){return t.originalEvent||t},Graph.event.position=function(t){return{x:t.clientX,y:t.clientY}},Graph.event.relative=function(t,e){var r=Graph.event.position(t),n=e.matrix().clone().invert(),i={x:n.x(r.x,r.y),y:n.y(r.x,r.y)};return n=null,i},Graph.event.isNavigation=function(e){var r=[Graph.event.ENTER,Graph.event.DELETE,Graph.event.SHIFT,Graph.event.CTRL,Graph.event.CMD,Graph.event.ESC],n=e.keyCode;return-1!==t.indexOf(r,n)},Graph.event.isPrimaryButton=function(t){return!Graph.event.original(t).button},Graph.event.hasPrimaryModifier=function(t){if(!Graph.event.isPrimaryButton(t))return!1;var e=Graph.event.original(t);return Graph.isMac()?e.metaKey:e.ctrlKey},Graph.event.hasSecondaryModifier=function(t){var e=Graph.event.original(t);return Graph.event.isPrimaryButton(t)&&e.shiftKey}}(_,jQuery),function(){function t(t,e){return e*Math.round(t/e)}var e=Graph.lang.Point=function(t,e){var r;this.props={x:0,y:0},_.isPlainObject(t)?(r=t,t=r.x,e=r.y):_.isString(t)&&(r=_.split(_.trim(t),","),
t=_.toNumber(r[0]),e=_.toNumber(r[1])),this.props.x=t,this.props.y=e};e.options={props:{x:0,y:0}},e.extend=Graph.lang.Class.extend,e.prototype=Object.create(Graph.lang.Class.prototype),e.prototype.constructor=e,e.prototype.superclass=Graph.lang.Class,e.prototype.x=function(t){return _.isUndefined(t)?this.props.x:(this.props.x=t,this)},e.prototype.y=function(t){return _.isUndefined(t)?this.props.y:(this.props.y=t,this)},e.prototype.distance=function(t){var e=this.props.x-t.props.x,r=this.props.y-t.props.y;return Math.sqrt(Math.pow(r,2)+Math.pow(e,2))},e.prototype.manhattan=function(t){return Math.abs(t.props.x-this.props.x)+Math.abs(t.props.y-this.props.y)},e.prototype.angle=function(t){return Graph.util.angle(a.toJson(),t.toJson())},e.prototype.triangle=function(t,e){return this.angle(e)-t.angle(e)},e.prototype.theta=function(t){return Graph.util.theta(this.toJson(),t.toJson())},e.prototype.difference=function(t){return new Graph.lang.Point(this.props.x-t.props.x,this.props.y-t.props.y)},e.prototype.alignment=function(t){return Graph.util.pointAlign(this.toJson(),t.toJson())},e.prototype.bbox=function(){var t=this.props.x,e=this.props.y;return Graph.bbox({x:t,y:e,x2:t,y2:e,width:0,height:0})},e.prototype.bearing=function(t){var e=new Graph.lang.Line(this,t),r=e.bearing();return e=null,r},e.prototype.snap=function(e,r){return r=_.defaultTo(r,e),this.props.x=t(this.props.x,e),this.props.y=t(this.props.y,r),this},e.prototype.move=function(t,e){var r=Graph.util.rad(t.theta(this));return this.expand(Math.cos(r)*e,-Math.sin(r)*e),this},e.prototype.expand=function(t,e){return this.props.x+=t,this.props.y+=e,this},e.prototype.round=function(t){return this.props.x=t?this.props.x.toFixed(t):Math.round(this.props.x),this.props.y=t?this.props.y.toFixed(t):Math.round(this.props.y),this},e.prototype.equals=function(t){return this.props.x==t.props.x&&this.props.y==t.props.y},e.prototype.rotate=function(t,e){e instanceof Graph.lang.Point&&(e=e.toJson());var r=Math.PI/180*t,n=Math.sin(r),i=Math.cos(r),o=this.props.x,s=this.props.y,a=e.x,p=e.y;this.props.x=i*(o-a)+n*(s-p)+a,this.props.y=i*(s-p)-n*(o-a)+p},e.prototype.transform=function(t){var e=this.props.x,r=this.props.y;return this.props.x=t.x(e,r),this.props.y=t.y(e,r),this},e.prototype.polar=function(){},e.prototype.adhereToBox=function(t){return t.contains(this)?this:(this.props.x=Math.min(Math.max(this.props.x,t.props.x),t.props.x+t.props.width),this.props.y=Math.min(Math.max(this.props.y,t.props.y),t.props.y+t.props.height),this)},e.prototype.stringify=function(t){return t=_.defaultTo(t,","),this.props.x+t+this.props.y},e.prototype.toString=function(){return"Graph.lang.Point"},e.prototype.toValue=function(){return this.stringify()},e.prototype.toJson=function(){return{x:this.props.x,y:this.props.y}},e.prototype.clone=function(){return new e(this.props.x,this.props.y)},Graph.isPoint=function(t){return t instanceof Graph.lang.Point},Graph.point=function(t,e){return new Graph.lang.Point(t,e)}}(),function(){
var t=Graph.lang.Line=function(t,e){var r=_.toArray(arguments);this.props={start:{x:0,y:0},end:{x:0,y:0}},4===r.length?(_.assign(this.props.start,{x:r[0],y:r[1]}),_.assign(this.props.end,{x:r[2],y:r[3]})):(this.props.start=r[0].toJson(),this.props.end=r[1].toJson())};t.options={props:{start:{x:0,y:0},end:{x:0,y:0}}},t.extend=Graph.lang.Class.extend,t.prototype.constructor=t,t.prototype.start=function(){return Graph.point(this.props.start.x,this.props.start.y)},t.prototype.end=function(){return Graph.point(this.props.end.x,this.props.end.y)},t.prototype.bearing=function(){var t=["NE","E","SE","S","SW","W","NW","N"],e=this.props.start.x,r=this.props.start.y,n=this.props.end.x,i=this.props.end.y,o=Graph.util.rad(r),s=Graph.util.rad(i),a=e,p=n,h=Graph.util.rad(p-a),c=Math.sin(h)*Math.cos(s),l=Math.cos(o)*Math.sin(s)-Math.sin(o)*Math.cos(s)*Math.cos(h);return index=Graph.util.deg(Math.atan2(c,l))-22.5,index<0&&(index+=360),index=parseInt(index/45),t[index]},t.prototype.intersect=function(t){return null!==this.intersection(t)},t.prototype.intersection=function(t,e){var r=this.props.start.x,n=this.props.start.y,i=this.props.end.x,o=this.props.end.y,s=t.props.start.x,a=t.props.start.y,p=t.props.end.x,h=t.props.end.y,c=Graph.util.lineIntersection(r,n,i,o,s,a,p,h);return c?e?c:Graph.point(c.x,c.y):c},t.prototype.toString=function(){return"Graph.lang.Line"},Graph.line=function(t){var e=_.toArray(arguments);return Graph.factory(Graph.lang.Line,e)},Graph.isLine=function(t){return t instanceof Graph.lang.Line}}(),function(){var t=Graph.lang.Curve=function(t){if(this.segments=_.isString(t)?Graph.util.path2segments(t):_.cloneDeep(t),"M"!=this.segments[0][0]&&this.segments.unshift(["M",this.segments[0][1],this.segments[0][2]]),1===this.segments.length&&"M"===this.segments[0][0]){var e=this.segments[0][1],r=this.segments[0][2];this.segments.push(["C",e,r,e,r,e,r])}};t.options={segments:[]},t.extend=Graph.lang.Class.extend,t.prototype.constructor=t,t.prototype.segments=[],t.prototype.x=function(){return this.segments[1][5]},t.prototype.y=function(){return this.segments[1][6]},t.prototype.length=function(t){var e=this.segments[0].slice(1).concat(this.segments[1].slice(1)).concat([t]);return Graph.util.curveLength.apply(null,e)},t.prototype.t=function(t){var e=this.segments[0].slice(1).concat(this.segments[1].slice(1)).concat([t]);return Graph.util.curveInterval.apply(null,e)},t.prototype.pointAt=function(t,e){var r=this.segments[0].slice(1).concat(this.segments[1].slice(1)).concat([t]),n=Graph.util.pointAtInterval.apply(null,r);if(e)return n;var i=Graph.point(n.x,n.y);return n.x=n.y=void 0,_.extend(i,n)},t.prototype.intersection=function(t,e){var r=this.segments[0].slice(1).concat(this.segments[1].slice(1)),n=t.segments[0].slice(1).concat(t.segments[1].slice(1)),i=Graph.util.curveIntersection(r,n);return e?i:_.map(i,function(t){return Graph.point(t.x,t.y)})},t.prototype.intersectnum=function(t){
var e=this.segments[0].slice(1).concat(this.segments[1].slice(1)),r=t.segments[0].slice(1).concat(t.segments[1].slice(1));return Graph.util.curveIntersection(e,r,!0)},t.prototype.bbox=function(){var t=[this.segments[0][1],this.segments[0][2]].concat(this.segments[1].slice(1)),e=Graph.util.curvebox.apply(null,t);return Graph.bbox({x:e.min.x,y:e.min.y,x2:e.max.x,y2:e.max.y,width:e.max.x-e.min.x,height:e.max.y-e.min.y})},t.prototype.clone=function(){var t=_.cloneDeep(this.segments);return new Graph.lang.Curve(t)},t.prototype.toValue=function(){return Graph.util.segments2path(this.segments)},t.prototype.toString=function(){return"Graph.lang.Curve"},Graph.curve=function(t){return new Graph.lang.Curve(t)},Graph.isCurve=function(t){return t instanceof Graph.lang.Curve}}(),function(){var t=Graph.lang.BBox=function(t){this.props=_.extend({x:0,y:0,x2:0,y2:0,width:0,height:0},t||{})};t.options={props:{x:0,y:0,x2:0,y2:0,width:0,height:0}},t.extend=Graph.lang.Class.extend,t.prototype=Object.create(Graph.lang.Class.prototype),t.prototype.constructor=t,t.prototype.superclass=Graph.lang.Class,t.prototype.shape=function(){var t=this.props;return new Graph.lang.Path([["M",t.x,t.y],["l",t.width,0],["l",0,t.height],["l",-t.width,0],["z"]])},t.prototype.origin=function(t){t=_.defaultTo(t,!1);var e=this.props.x,r=this.props.y;return t?{x:e,y:r}:Graph.point(e,r)},t.prototype.center=function(t){t=_.defaultTo(t,!1);var e=this.props.x+this.props.width/2,r=this.props.y+this.props.height/2;return t?{x:e,y:r}:Graph.point(e,r)},t.prototype.corner=function(t){t=_.defaultTo(t,!1);var e=this.props.x+this.props.width,r=this.props.y+this.props.height;return t?{x:e,y:r}:Graph.point(e,r)},t.prototype.width=function(){return this.props.width},t.prototype.height=function(){return this.props.height},t.prototype.clone=function(){var e=_.extend({},this.props);return new t(e)},t.prototype.contains=function(t){var e,r=!0,n=this.props,i=[];if(Graph.isPoint(t))i=[[t.props.x,t.props.y]];else if(Graph.isVector(t))i=t.vertices(!0);else if(Graph.isBBox(t))i=[[t.props.x,t.props.y],[t.props.x2,t.props.y2]];else{var o=_.toArray(arguments);2===o.length&&(i=[o])}if(i.length)for(var s=i.length;s--&&(e=i[s],r=e[0]>=n.x&&e[0]<=n.x2&&e[1]>=n.y&&e[1]<=n.y2););return r},t.prototype.expand=function(t,e,r,n){var i,o;return _.isUndefined(e)?(i=Math.abs(t),t=-i,e=-i,r=2*i,n=2*i):(i=Math.abs(t),o=Math.abs(e),t=-i,e=-o,r=2*i,n=2*o),this.props.x+=t,this.props.y+=e,this.props.width+=r,this.props.height+=n,this},t.prototype.translate=function(t,e){return this.props.x+=t,this.props.y+=e,this.props.x2+=t,this.props.y2+=e,this},t.prototype.transform=function(t){var e=this.props.x,r=this.props.y;return this.props.x=t.x(e,r),this.props.y=t.y(e,r),e=this.props.x2,r=this.props.y2,this.props.x2=t.x(e,r),this.props.y2=t.y(e,r),this.props.width=this.props.x2-this.props.x,this.props.height=this.props.y2-this.props.y,this},t.prototype.intersect=function(t){var e=this,r=e.props,n=t.toJson()
;return t.contains(r.x,r.y)||t.contains(r.x2,r.y)||t.contains(r.x,r.y2)||t.contains(r.x2,r.y2)||e.contains(n.x,n.y)||e.contains(n.x2,n.y)||e.contains(n.x,n.y2)||e.contains(n.x2,n.y2)||(r.x<n.x2&&r.x>n.x||n.x<r.x2&&n.x>r.x)&&(r.y<n.y2&&r.y>n.y||n.y<r.y2&&n.y>r.y)},t.prototype.sideNearestPoint=function(t){var e=t.props.x,r=t.props.y,n=this.props.x,i=this.props.y,o=this.props.width,s=this.props.height,a=e-n,p=n+o-e,h=r-i,c=i+s-r,l=a,u="left";return p<l&&(l=p,u="right"),h<l&&(l=h,u="top"),c<l&&(l=c,u="bottom"),u},t.prototype.pointNearestPoint=function(t){if(this.contains(t)){switch(this.sideNearestPoint(t)){case"right":return Graph.point(this.props.x+this.props.width,t.props.y);case"left":return Graph.point(this.props.x,t.props.y);case"bottom":return Graph.point(t.props.x,this.props.y+this.props.height);case"top":return Graph.point(t.props.x,this.props.y)}}return t.clone().adhereToBox(this)},t.prototype.toJson=function(){return _.clone(this.props)},t.prototype.toString=function(){return"Graph.lang.BBox"},t.prototype.toValue=function(){var t=this.props;return _.format("{0},{1} {2},{3} {4},{5} {6},{7}",t.x,t.y,t.x+t.width,t.y,t.x+t.width,t.y+t.height,t.x,t.y+t.height)},Graph.isBBox=function(t){return t instanceof Graph.lang.BBox},Graph.bbox=function(t){return new Graph.lang.BBox(t)}}(),function(){function t(t,e,o){var s,a,p={T:1,Q:1};if(!t)return["C",e.x,e.y,e.x,e.y,e.x,e.y];switch(!(t[0]in p)&&(e.qx=e.qy=null),t[0]){case"M":e.X=t[1],e.Y=t[2];break;case"A":t=["C"].concat(i.apply(0,[e.x,e.y].concat(t.slice(1))));break;case"S":"C"==o||"S"==o?(s=2*e.x-e.bx,a=2*e.y-e.by):(s=e.x,a=e.y),t=["C",s,a].concat(t.slice(1));break;case"T":"Q"==o||"T"==o?(e.qx=2*e.x-e.qx,e.qy=2*e.y-e.qy):(e.qx=e.x,e.qy=e.y),t=["C"].concat(n(e.x,e.y,e.qx,e.qy,t[1],t[2]));break;case"Q":e.qx=t[1],e.qy=t[2],t=["C"].concat(n(e.x,e.y,t[1],t[2],t[3],t[4]));break;case"L":t=["C"].concat(r(e.x,e.y,t[1],t[2]));break;case"H":t=["C"].concat(r(e.x,e.y,t[1],e.y));break;case"V":t=["C"].concat(r(e.x,e.y,e.x,t[1]));break;case"Z":t=["C"].concat(r(e.x,e.y,e.X,e.Y))}return t}function e(t,e){for(var r=[],n=_.defaultTo,i=0,o=t.length;o-2*!e>i;i+=2){var s=[{x:n(t[i-2],0),y:n(t[i-1],0)},{x:n(t[i],0),y:n(t[i+1],0)},{x:n(t[i+2],0),y:n(t[i+3],0)},{x:n(t[i+4],0),y:n(t[i+5],0)}];e?i?o-4==i?s[3]={x:n(t[0],0),y:n(t[1],0)}:o-2==i&&(s[2]={x:n(t[0],0),y:n(t[1],0)},s[3]={x:n(t[2],0),y:n(t[3],0)}):s[0]={x:n(t[o-2],0),y:n(t[o-1],0)}:o-4==i?s[3]=s[2]:i||(s[0]={x:n(t[i],0),y:n(t[i+1],0)}),r=[(-s[0].x+6*s[1].x+s[2].x)/6,(-s[0].y+6*s[1].y+s[2].y)/6,(s[1].x+6*s[2].x-s[3].x)/6,(s[1].y+6*s[2].y-s[3].y)/6,s[2].x,s[2].y]}return r}function r(t,e,r,n){return[t,e,r,n,r,n]}function n(t,e,r,n,i,o){return[1/3*t+2/3*r,1/3*e+2/3*n,1/3*i+2/3*r,1/3*o+2/3*n,i,o]}function i(t,e,r,n,o,s,a,p,h,c){var l,u=120*Math.PI/180,d=Math.PI/180*(+o||0),f=[],g=Graph.memoize(function(t,e,r){return{x:t*Math.cos(r)-e*Math.sin(r),y:t*Math.sin(r)+e*Math.cos(r)}});if(c)k=c[0],C=c[1],_=c[2],w=c[3];else{l=g(t,e,-d),t=l.x,e=l.y,l=g(p,h,-d),p=l.x,h=l.y
;var y=(Math.cos(Math.PI/180*o),Math.sin(Math.PI/180*o),(t-p)/2),v=(e-h)/2,m=y*y/(r*r)+v*v/(n*n);m>1&&(m=Math.sqrt(m),r*=m,n*=m);var x=r*r,b=n*n,G=(s==a?-1:1)*Math.sqrt(Math.abs((x*b-x*v*v-b*y*y)/(x*v*v+b*y*y))),_=G*r*v/n+(t+p)/2,w=G*-n*y/r+(e+h)/2,k=Math.asin(((e-w)/n).toFixed(9)),C=Math.asin(((h-w)/n).toFixed(9));k=t<_?Math.PI-k:k,C=p<_?Math.PI-C:C,k<0&&(k=2*Math.PI+k),C<0&&(C=2*Math.PI+C),a&&k>C&&(k-=2*Math.PI),!a&&C>k&&(C-=2*Math.PI)}var S=C-k;if(Math.abs(S)>u){var T=C,E=p,A=h;C=k+u*(a&&C>k?1:-1),p=_+r*Math.cos(C),h=w+n*Math.sin(C),f=i(p,h,r,n,o,0,a,E,A,[C,T,_,w])}S=C-k;var D=Math.cos(k),M=Math.sin(k),z=Math.cos(C),P=Math.sin(C),L=Math.tan(S/4),R=4/3*r*L,O=4/3*n*L,V=[t,e],B=[t+R*M,e-O*D],H=[p+R*P,h-O*z],I=[p,h];if(B[0]=2*V[0]-B[0],B[1]=2*V[1]-B[1],c)return[B,H,I].concat(f);f=[B,H,I].concat(f).join().split(",");for(var N=[],q=0,J=f.length;q<J;q++)N[q]=q%2?g(f[q-1],f[q],d).y:g(f[q],f[q+1],d).x;return N}function o(t,e,r){var n,i,o,s,a,p,h,c,l,u,d,f,g,y,v,m,x,b=t.curve().segments,G=b.length,_=e.curve().segments,w=_.length,k=r?0:[];for(v=0;v<G;v++)if(g=b[v],"M"==g[0])n=a=g[1],i=p=g[2];else for("C"==g[0]?(l=[["M",n,i],g],d=[n,i].concat(g.slice(1)),n=g[5],i=g[6]):(l=[["M",n,i],["C",n,i,a,p,a,a]],d=[n,i,n,i,a,p,a,p],n=a,i=p),m=0;m<w;m++)if(y=_[m],"M"==y[0])o=h=y[1],s=c=y[2];else if("C"==y[0]?(u=[["M",o,s],y],f=[o,s].concat(y.slice(1)),o=y[5],s=y[6]):(u=[["M",o,s],["C",o,s,h,c,h,c]],f=[o,s,o,s,h,c,h,c],o=h,s=c),r)k+=Graph.util.curveIntersection(d,f,!0);else{x=Graph.util.curveIntersection(d,f);for(var C=0,S=x.length;C<S;C++)x[C].segment1=v,x[C].segment2=m,x[C].bezier1=l,x[C].bezier2=u;k=k.concat(x)}return k}var s=Graph.lang.Path=function(t){var e=[];e=Graph.isPath(t)?_.cloneDeep(t.segments):_.isArray(t)?_.cloneDeep(t):_.cloneDeep(Graph.util.path2segments(t)),this.segments=e};s.options={segments:[]},s.extend=Graph.lang.Class.extend,s.prototype.constructor=s,s.prototype.command=function(){return Graph.util.segments2path(this.segments)},s.prototype.absolute=function(){if(!this.segments.length)return new s([["M",0,0]]);var t=Graph.lookup(this.toString(),"absolute",this.toValue()),r=this.segments;if(t.absolute)return t.absolute;var n=[],i=0,o=0,a=0,p=0,h=0;"M"==r[0][0]&&(i=+r[0][1],o=+r[0][2],a=i,p=o,h++,n[0]=["M",i,o]);for(var c,l,u,d=3==r.length&&"M"==r[0][0]&&"R"==r[1][0].toUpperCase()&&"Z"==r[2][0].toUpperCase(),f=h,g=r.length;f<g;f++){if(n.push(l=[]),u=r[f],u[0]!=_.toUpper(u[0]))switch(l[0]=_.toUpper(u[0]),l[0]){case"A":l[1]=u[1],l[2]=u[2],l[3]=u[3],l[4]=u[4],l[5]=u[5],l[6]=+(u[6]+i),l[7]=+(u[7]+o);break;case"V":l[1]=+u[1]+o;break;case"H":l[1]=+u[1]+i;break;case"R":c=_.concat([i,o],u.slice(1));for(var y=2,v=c.length;y<v;y++)c[y]=+c[y]+i,c[++y]=+c[y]+o;n.pop(),n=_.concat(n,[["C"].concat(e(c,d))]);break;case"M":a=+u[1]+i,p=+u[2]+o;default:for(var m=1,x=u.length;m<x;m++)l[m]=+u[m]+(m%2?i:o)}else if("R"==u[0])c=_.concat([i,o],u.slice(1)),n.pop(),n=_.concat(n,[["C"].concat(e(c,d))]),l=_.concat(["R"],u.slice(-2));else for(var b=0,G=u.length;b<G;b++)l[b]=u[b]
;switch(l[0]){case"Z":i=a,o=p;break;case"H":i=l[1];break;case"V":o=l[1];break;case"M":a=l[l.length-2],p=l[l.length-1];default:i=l[l.length-2],o=l[l.length-1]}}return t.absolute=n=new s(n),n},s.prototype.start=function(){return this.pointAt(0)},s.prototype.end=function(){return this.pointAt(this.length())},s.prototype.head=function(){},s.prototype.tail=function(){},s.prototype.relative=function(){var t=Graph.lookup(this.toString(),"relative",this.toValue()),e=this.segments;if(t.relative)return t.relative;var r=[],n=0,i=0,o=0,a=0,p=0;"M"==e[0][0]&&(n=e[0][1],i=e[0][2],o=n,a=i,p++,r.push(["M",n,i]));for(var h=p,c=e.length;h<c;h++){var l=r[h]=[],u=e[h];if(u[0]!=_.toLower(u[0]))switch(l[0]=_.toLower(u[0]),l[0]){case"a":l[1]=u[1],l[2]=u[2],l[3]=u[3],l[4]=u[4],l[5]=u[5],l[6]=+(u[6]-n).toFixed(3),l[7]=+(u[7]-i).toFixed(3);break;case"v":l[1]=+(u[1]-i).toFixed(3);break;case"m":o=u[1],a=u[2];default:for(var d=1,f=u.length;d<f;d++)l[d]=+(u[d]-(d%2?n:i)).toFixed(3)}else{l=res[h]=[],"m"==u[0]&&(o=u[1]+n,a=u[2]+i);for(var g=0,y=u.length;g<y;g++)res[h][g]=u[g]}var v=r[h].length;switch(r[h][0]){case"z":n=o,i=a;break;case"h":n+=+r[h][v-1];break;case"v":i+=+r[h][v-1];break;default:n+=+r[h][v-2],i+=+r[h][v-1]}}return t.relative=r=new s(r),r},s.prototype.curve=function(){var e=Graph.lookup(this.toString(),"curve",this.toValue());if(e.curve)return e.curve;for(var r=_.cloneDeep(this.absolute().segments),n={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},i=[],o="",a="",p=0,h=r.length;p<h;p++){r[p]&&(o=r[p][0]),"C"!=o&&(i[p]=o,p&&(a=i[p-1])),r[p]=t(r[p],n,a),"A"!=i[p]&&"C"==o&&(i[p]="C"),function(t,e){if(t[e].length>7){t[e].shift();for(var n=t[e];n.length;)i[e]="A",t.splice(e++,0,["C"].concat(n.splice(0,6)));t.splice(e,1),h=r.length}}(r,p);var c=r[p],l=c.length;n.x=c[l-2],n.y=c[l-1],n.bx=_.float(c[l-4])||n.x,n.by=_.float(c[l-3])||n.y}return e.curve=new s(r),e.curve},s.prototype.curve2curve=function(e){function r(t,e,r,o,s){t&&e&&"M"==t[s][0]&&"M"!=e[s][0]&&(e.splice(s,0,["M",o.x,o.y]),r.bx=0,r.by=0,r.x=t[s][1],r.y=t[s][2],d=_.max([n.length,i&&i.length||0]))}for(var n=_.cloneDeep(this.absolute().segments),i=_.cloneDeep(new s(e).absolute().segments),o={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},a={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},p=[],h=[],c="",l="",u=0,d=_.max([n.length,i.length]);u<d;u++){n[u]&&(c=n[u][0]),"C"!=c&&(p[u]=c,u&&(l=p[u-1])),n[u]=t(n[u],o,l),"A"!=p[u]&&"C"==c&&(p[u]="C"),function(t,e){if(t[e].length>7){t[e].shift();for(var r=t[e];r.length;)p[e]="A",h[e]="A",t.splice(e++,0,["C"].concat(r.splice(0,6)));t.splice(e,1),d=_.max([n.length,i.length])}}(n,u),i[u]&&(c=i[u][0]),"C"!=c&&(h[u]=c,u&&(l=h[u-1])),i[u]=t(i[u],attrs2,pcom),"A"!=h[u]&&"C"==c&&(h[u]="C"),fixArc2(i,u),r(n,i,o,a,u),r(i,n,a,o,u);var f=n[u],g=i[u],y=f.length,v=g.length;o.x=f[y-2],o.y=f[y-1],o.bx=_.float(f[y-4])||o.x,o.by=_.float(f[y-3])||o.y,a.bx=_.float(g[v-4])||a.x,a.by=_.float(g[v-3])||a.y,a.x=g[v-2],a.y=g[v-1]}return[new s(n),new s(i)]},s.prototype.bbox=function(){
if(!this.segments.length)return Graph.bbox({x:0,y:0,width:0,height:0,x2:0,y2:0});var t=Graph.lookup(this.toString(),"bbox",this.toValue());if(t.bbox)return t.bbox;for(var e,r=this.curve().segments,n=0,i=0,o=[],s=[],a=0,p=r.length;a<p;a++)if(e=r[a],"M"==e[0])n=e[1],i=e[2],o.push(n),s.push(i);else{var h=Graph.util.curvebox(n,i,e[1],e[2],e[3],e[4],e[5],e[6]);o=o.concat(h.min.x,h.max.x),s=s.concat(h.min.y,h.max.y),n=e[5],i=e[6]}var c=_.min(o),l=_.min(s),u=_.max(o),d=_.max(s),f=u-c,g=d-l,y={x:c,y:l,x2:u,y2:d,width:f,height:g,cx:c+f/2,cy:l+g/2};return t.bbox=Graph.bbox(y),t.bbox},s.prototype.transform=function(t){if(t){var e=Graph.lookup(this.toString(),"transform",this.toValue(),t.toValue());if(e.transform)return e.transform;var r,n,i,o,a,p,h,c=_.cloneDeep(this.curve().segments);for(i=0,o=c.length;i<o;i++)for(h=c[i],a=1,p=h.length;a<p;a+=2)r=t.x(h[a],h[a+1]),n=t.y(h[a],h[a+1]),h[a]=r,h[a+1]=n;return e.transform=new s(c),e.transform}},s.prototype.lengthAt=function(t){},s.prototype.pointAt=function(t,e){var r,n,i,o,s,a,p,h=this.curve().segments;e=_.defaultTo(e,!1),s=0;for(var c=0,l=h.length;c<l;c++)if(n=h[c],"M"==n[0])i=n[1],o=n[2];else{if(a=Graph.curve([["M",i,o],n]),p=a.length(),s+p>t)return r=a.pointAt(a.t(t-s),e),a=null,r;s+=p,i=n[5],o=n[6],a=null}return a=Graph.curve([["M",i,o],n]),r=a.pointAt(1,e),a=null,r},s.prototype.segmentAt=function(t){var e,r,n,i,o=this.curve().segments,s=-1,a=0;return _.forEach(o,function(o,p){if("M"==o[0])e=o[1],r=o[2];else{if(i=Graph.curve([["M",e,r],o]),e=i.x(),r=i.y(),(n=i.length())+a>t)return s=p,!1;a+=n,i=null}}),s},s.prototype.length=function(){var t,e,r,n,i,o=this.curve().segments;n=0;for(var s=0,a=o.length;s<a;s++)t=o[s],"M"==t[0]?(e=t[1],r=t[2]):(i=Graph.curve([["M",e,r],t]),n+=i.length(),e=t[5],r=t[6],i=null);return n},s.prototype.slice=function(t,e){var r,n,i,o,s,a,p,h,c=this.curve().segments,l={};a=0,n="";for(var u=0,d=c.length;u<d;u++)i=c[u],"M"==i[0]?(o=i[1],s=i[2]):(p=Graph.curve([["M",o,s],i]),h=p.length(),a+h>length&&(r=p.pointAt(p.t(length-a)),n+=["C"+r.start.x,r.start.y,r.m.x,r.m.y,r.props.x,r.props.y],l.start=Graph.path(n),n=["M"+r.props.x,r.props.y+"C"+r.n.x,r.n.y,r.end.x,r.end.y,i[5],i[6]].join()),a+=h,o=i[5],s=i[6],p=null),n+=i.shift()+i;return l.end=Graph.path(n),l},s.prototype.vertices=function(){var t=Graph.lookup(this.toString(),"vertices",this.toValue());if(t.vertices)return t.vertices;var e=this.segments,r=[];return _.forEach(e,function(t){var e,n,i=t.length;"Z"!=t[0]&&("M"==t[0]?(e=t[1],n=t[2]):(e=t[i-2],n=t[i-1]),r.push(Graph.point(e,n)))}),t.vertices=r,t.vertices},s.prototype.addVertext=function(t){var e,r,n,i,o=this.isSimple(),s=o?_.cloneDeep(this.segments):this.curve().segments,a=-1,p=t.props.x,h=t.props.y,c=0,l=0;return _.forEach(s,function(t,o){if("Z"!=t[0])if("M"==t[0])e=t[1],r=t[2];else if("L"==t[0]?(n=Graph.curve([["M",e,r],["C",e,r,e,r,t[1],t[2]]]),e=t[1],r=t[2]):(n=Graph.curve([["M",e,r],t]),e=n.x(),r=n.y()),i=n.clone(),i.segments[1][5]=p,i.segments[1][6]=h,c+=n.length(),
(l+=i.length())<=c)return a=o,!1}),a>-1&&(o?s.splice(a,0,["L",p,h]):s.splice(a,0,["C",p,h,p,h,p,h]),this.segments=s),this},s.prototype.intersect=function(t){return o(this,t,!0)>0},s.prototype.intersection=function(t,e){var r=o(this,t);return e?r:_.map(r,function(t){var e=Graph.point(t.x,t.y);return e.segment1=t.segment1,e.segment2=t.segment2,e.bezier1=t.bezier1,e.bezier2=t.bezier2,e})},s.prototype.intersectnum=function(t){return o(this,t,!0)},s.prototype.alpha=function(t){},s.prototype.contains=function(t){var e,r,n,i,o;return i=t.props.x,o=t.props.y,e=this.bbox(),n=e.toJson(),r=new s([["M",i,o],["H",n.x2+10]]),e.contains(t)&&this.intersectnum(r)%2==1},s.prototype.nearest=function(t){var e,r,n,i,o,s=this.length(),a=20,p=1/0,h=Graph.util.taxicab;for(Graph.isPoint(t)&&(t=t.toJson()),o=0;o<s;o+=a)n=this.pointAt(o,!0),(i=h(n,t))<p&&(p=i,e=n,r=o);a/=2;for(var c,l,u,d,f,g;a>.5;)(u=r-a)>=0&&(f=h(c=this.pointAt(u,!0),t))<p?(e=c,r=u,p=f):(d=r+a)<=s&&(g=h(l=this.pointAt(d,!0),t))<p?(e=l,r=d,p=g):a/=2;return e.distance=r,e},s.prototype.isSimple=function(){var t=!0;return _.forEach(this.segments,function(e){if(!/[MLZ]/i.test(e[0]))return t=!1,!1}),t},s.prototype.moveTo=function(t,e){var r=this.segments;return r.length?(r[0][0]="M",r[0][1]=t,r[0][2]=e):r=[["M",t,e]],this},s.prototype.lineTo=function(t,e,r){var n=this.segments;if(r=_.defaultTo(r,!0),n){var i=n.length-1;"M"==n[i][0]||r?n.push(["L",t,e]):(n[i][1]=t,n[i][2]=e)}return this},s.prototype.toString=function(){return"Graph.lang.Path"},s.prototype.toValue=function(){return Graph.util.segments2path(this.segments)},s.prototype.toArray=function(){return this.segments},s.prototype.clone=function(){var t=[];return _.forEach(this.segments,function(e){t.push(e.slice())}),new s(t)},Graph.isPath=function(t){return t instanceof Graph.lang.Path},Graph.path=function(t){return new Graph.lang.Path(t)}}(),function(){var t=Graph.lang.Matrix=function(t,e,r,n,i,o){this.props={},this.props.a=_.defaultTo(t,1),this.props.b=_.defaultTo(e,0),this.props.c=_.defaultTo(r,0),this.props.d=_.defaultTo(n,1),this.props.e=_.defaultTo(i,0),this.props.f=_.defaultTo(o,0)};t.options={props:{a:1,b:0,c:0,d:1,e:0,f:0}},t.extend=Graph.lang.Class.extend,t.prototype.constructor=t,t.prototype.x=function(t,e){return t*this.props.a+e*this.props.c+this.props.e},t.prototype.y=function(t,e){return t*this.props.b+e*this.props.d+this.props.f},t.prototype.get=function(t){return+this.props[t].toFixed(4)},t.prototype.multiply=function(t,e,r,n,i,o){var s,a,p,h,c=[[],[],[]],l=[[this.props.a,this.props.c,this.props.e],[this.props.b,this.props.d,this.props.f],[0,0,1]],u=[[t,r,i],[e,n,o],[0,0,1]];for(Graph.isMatrix(t)&&(u=[[t.props.a,t.props.c,t.props.e],[t.props.b,t.props.d,t.props.f],[0,0,1]]),s=0;s<3;s++)for(a=0;a<3;a++){for(h=0,p=0;p<3;p++)h+=l[s][p]*u[p][a];c[s][a]=h}return this.props.a=c[0][0],this.props.b=c[1][0],this.props.c=c[0][1],this.props.d=c[1][1],this.props.e=c[0][2],this.props.f=c[1][2],this},t.prototype.invert=function(t){
var e,r,n,i,o,s,a=this.props.a*this.props.d-this.props.b*this.props.c;return t=_.defaultTo(t,!1),e=this.props.d/a,r=-this.props.b/a,n=-this.props.c/a,i=this.props.a/a,o=(this.props.c*this.props.f-this.props.d*this.props.e)/a,s=(this.props.b*this.props.e-this.props.a*this.props.f)/a,t?new Graph.matrix(e,r,n,i,o,s):(this.props.a=e,this.props.b=r,this.props.c=n,this.props.d=i,this.props.e=o,this.props.f=s,this)},t.prototype.translate=function(t,e){return t=_.defaultTo(t,0),e=_.defaultTo(e,0),this.multiply(1,0,0,1,t,e),this},t.prototype.rotate=function(t,e,r){if(!arguments.length){var n,i,o=this.delta(0,1);return this.delta(1,0),n=180/Math.PI*Math.atan2(o.y,o.x)-90,i=Graph.util.rad(n),{deg:n,rad:i,sin:Math.sin(i),cos:Math.cos(i)}}var s;s=Graph.util.rad(t),e=_.defaultTo(e,0),r=_.defaultTo(r,0);var a=+Math.cos(s).toFixed(9),p=+Math.sin(s).toFixed(9);return this.multiply(a,p,-p,a,e,r),this.multiply(1,0,0,1,-e,-r),this},t.prototype.scale=function(t,e,r,n){if(void 0===t){var i=this.props,t=Graph.util.hypo(i.a,i.b),e=Graph.util.hypo(i.c,i.d);return this.determinant()<0&&(t=-t),{x:t,y:e}}return e=_.defaultTo(e,t),(r||n)&&(r=_.defaultTo(r,0),n=_.defaultTo(n,0)),(r||n)&&this.multiply(1,0,0,1,r,n),this.multiply(t,0,0,e,0,0),(r||n)&&this.multiply(1,0,0,1,-r,-n),this},t.prototype.determinant=function(){return this.props.a*this.props.d-this.props.b*this.props.c},t.prototype.delta=function(t,e){return{x:t*this.props.a+e*this.props.c+0,y:t*this.props.b+e*this.props.d+0}},t.prototype.data=function(){var t=this.delta(0,1),e=this.delta(1,0),r=180/Math.PI*Math.atan2(t.y,t.x)-90,n=Graph.util.rad(r),i=Math.cos(n),o=Math.sin(n),s=Graph.util.hypo(this.props.a,this.props.b),a=Graph.util.hypo(this.props.c,this.props.d),p=Graph.util.rad(r);return this.determinant()<0&&(s=-s),{x:this.props.e,y:this.props.f,dx:(this.props.e*i+this.props.f*o)/s,dy:(this.props.f*i+this.props.e*-o)/a,skewX:-r,skewY:180/Math.PI*Math.atan2(e.y,e.x),scaleX:s,scaleY:a,rotate:this.rotate().deg,rad:p,sin:Math.sin(p),cos:Math.cos(p),a:this.props.a,b:this.props.b,c:this.props.c,d:this.props.d,e:this.props.e,f:this.props.f}},t.prototype.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get("a")+", M12="+this.get("c")+", M21="+this.get("b")+", M22="+this.get("d")+", Dx="+this.get("e")+", Dy="+this.get("f")+", sizingmethod='auto expand')"},t.prototype.toArray=function(){return[[this.get("a"),this.get("c"),this.get("e")],[this.get("b"),this.get("d"),this.get("f")],[0,0,1]]},t.prototype.toValue=function(){return _.format("matrix({0},{1},{2},{3},{4},{5})",this.get("a"),this.get("b"),this.get("c"),this.get("d"),this.get("e"),this.get("f"))},t.prototype.toString=function(){return"Graph.lang.Matrix"},t.prototype.clone=function(){return new t(this.props.a,this.props.b,this.props.c,this.props.d,this.props.e,this.props.f)},Graph.isMatrix=function(t){return t instanceof Graph.lang.Matrix},Graph.matrix=function(t,e,r,n,i,o){return new Graph.lang.Matrix(t,e,r,n,i,o)}}(),function(){
var t=Graph.collection.Point=function(t){this.items=t||[]};t.prototype.constructor=t,t.prototype.items=[],t.prototype.get=function(t){return this.items[t]},t.prototype.push=function(t){return this.items.push(t),t},t.prototype.pop=function(){return this.items.pop()},t.prototype.shift=function(){return this.items.shift()},t.prototype.first=function(){return _.head(this.items)},t.prototype.last=function(){return _.last(this.items)},t.prototype.clear=function(){return this.items=[],this},t.prototype.modify=function(t,e,r){var n=this.items[t];return n.props.x=e,n.props.y=r,n},t.prototype.each=function(t){_.forEach(this.items,t)},t.prototype.toArray=function(){return this.items},t.prototype.toJson=function(){return _.map(this.items,function(t){return t.toJson()})}}(),function(){var t=Graph.collection.Vector=function(t){this.items=_.map(t||[],function(t){return t.guid()}),t=null};t.prototype.constructor=t,t.prototype.has=function(t){var e=t.guid();return _.indexOf(this.items,e)>-1},t.prototype.not=function(e){var r=e.guid(),n=_.filter(this.items,function(t){return t!=r});return new t(n)},t.prototype.size=function(){return this.items.length},t.prototype.index=function(t){var e=t.guid();return _.indexOf(this.items,e)},t.prototype.push=function(t){var e=t.guid();return this.items.push(e),this.items.length},t.prototype.pop=function(){var t=this.items.pop();return Graph.registry.vector.get(t)},t.prototype.shift=function(){var t=this.items.shift();return Graph.registry.vector.get(t)},t.prototype.unshift=function(t){var e=t.guid();this.items.unshift(e)},t.prototype.insert=function(t,e){-1===e&&(e=0),this.items.splice(e,0,t.guid())},t.prototype.pull=function(t){var e=t.guid();_.pull(this.items,e)},t.prototype.clear=function(){this.items=[]},t.prototype.reverse=function(){return this.items.reverse(),this},t.prototype.each=function(t){_.forEach(this.items,function(e){var r=Graph.registry.vector.get(e);t.call(r,r)})},t.prototype.bbox=function(){for(var t,e,r=[],n=[],i=[],o=[],s=this.items.length-1;s>=0;s--)t=Graph.registry.vector.get(this.items[s]),e=t.bbox().toJson(),r.push(e.x),n.push(e.y),i.push(e.x+e.width),o.push(e.y+e.height);return r=_.min(r),n=_.min(n),i=_.max(i),o=_.max(o),Graph.bbox({x:r,y:n,x2:i,y2:o,width:i-r,height:o-n})},t.prototype.toArray=function(){return _.map(this.items,function(t){return Graph.registry.vector.get(t)})},t.prototype.toString=function(){return"Graph.collection.Vector"};var e=["attr","remove"];_.forEach(e,function(e){!function(e){t.prototype[e]=function(){var t=_.toArray(arguments);return this.each(function(r){r[e].apply(r,t)}),this}}(e)})}(),function(){var t=Graph.collection.Shape=function(t){this.items=_.map(t,function(t){return t.guid()}),t=null};t.prototype.constructor=t,t.prototype.keys=function(){return this.items.slice()},t.prototype.size=function(){return this.items.length},t.prototype.index=function(t){var e=t.guid();return _.indexOf(this.items,e)},t.prototype.has=function(t){var e=t.guid()
;return-1!==_.indexOf(this.items,e)},t.prototype.find=function(t){var e=this.toArray();return _.find(e,t)},t.prototype.push=function(t){var e=this;return _.isArray(t)?_.forEach(t,function(t){var r=t.guid();e.items.push(r)}):e.items.push(t.guid()),e.items.length},t.prototype.pop=function(){var t=this.items.pop();return Graph.registry.shape.get(t)},t.prototype.shift=function(){var t=this.items.shift();return Graph.registry.shape.get(t)},t.prototype.unshift=function(t){return this.items.unshift(t),t},t.prototype.pull=function(t){var e=t.guid();_.pull(this.items,e)},t.prototype.last=function(){return _.last(this.items)},t.prototype.each=function(t){var e=this;_.forEach(e.items,function(e,r){var n=Graph.registry.shape.get(e);n&&t.call(n,n,r)})},t.prototype.bbox=function(){for(var t,e,r,n=[],i=[],o=[],s=[],a=this.items.length-1;a>=0;a--)t=Graph.registry.shape.get(this.items[a]),e=t.component(),r=e.bbox().toJson(),n.push(r.x),i.push(r.y),o.push(r.x+r.width),s.push(r.y+r.height);return n=_.min(n),i=_.min(i),o=_.max(o),s=_.max(s),Graph.bbox({x:n,y:i,x2:o,y2:s,width:o-n,height:s-i})},t.prototype.toArray=function(){return _.map(this.items,function(t){return Graph.registry.shape.get(t)})},t.prototype.toString=function(){return"Graph.collection.Shape"}}(),function(){var t=Graph.collection.Tree=function(t){var e=this;e.nodes=t,e.key=function(t){return t},e.bisect=_.bisector(function(t){return e.key(t)}).left};t.prototype.get=function(t){return this.nodes[t]},t.prototype.size=function(){return this.nodes.length},t.prototype.insert=function(t){var e=this.index(t),r=this.key(t);if(!this.nodes[e]||r!=this.key(this.nodes[e]))return this.nodes.splice(e,0,t),e},t.prototype.remove=function(t){var e=this.index(t);return this.nodes.splice(e,1),e},t.prototype.keygen=function(t){return this.key=t,this},t.prototype.index=function(t){return this.bisect(this.nodes,this.key(t))},t.prototype.order=function(){return this.nodes.sort(_.ascendingKey(this.key)),this},t.prototype.root=function(){return this.nodes[0]},t.prototype.cascade=function(t,e){for(var r=this.index(t),n=this.nodes,i=this.nodes.length,o=0,s=r;s<i;s++)e(n[s],o),o++},t.prototype.bubble=function(t,e){for(var r=this.index(t),n=this.nodes,i=0,o=r;o>=0;o--)e(n[o],i),i++},t.prototype.toArray=function(){return this.nodes.slice()}}(),function(){var t=Graph.collection.Link=function(t){this.items=_.map(t,function(t){return t.guid()}),t=null};t.prototype.constructor=t,t.prototype.keys=function(){return this.items.slice()},t.prototype.size=function(){return this.items.length},t.prototype.index=function(t){var e=t.guid();return _.indexOf(this.items,e)},t.prototype.has=function(t){var e=t.guid();return-1!==_.indexOf(this.items,e)},t.prototype.find=function(t){var e=this.toArray();return _.find(e,t)},t.prototype.push=function(t){var e=this;return _.isArray(t)?_.forEach(t,function(t){var r=t.guid();e.items.push(r)}):e.items.push(t.guid()),e.items.length},t.prototype.pop=function(){var t=this.items.pop()
;return Graph.registry.link.get(t)},t.prototype.shift=function(){var t=this.items.shift();return Graph.registry.link.get(t)},t.prototype.unshift=function(t){return this.items.unshift(t),t},t.prototype.pull=function(t){var e=t.guid();_.pull(this.items,e)},t.prototype.last=function(){return _.last(this.items)},t.prototype.each=function(t){var e=this;_.forEach(e.items,function(e,r){var n=Graph.registry.link.get(e);n&&t.call(n,n,r)})},t.prototype.toArray=function(){return _.map(this.items,function(t){return Graph.registry.link.get(t)})},t.prototype.toString=function(){return"Graph.collection.link"}}(),function(t,e){var r,n=/^<(svg|g|rect|text|path|line|tspan|circle|polygon|defs|marker)/i;Graph.dom=function(i,o,s){var a,p;if(void 0===r)try{r=new DOMParser}catch(t){r=null}return s=t.defaultTo(s,!1),void 0!==o&&Graph.isElement(o)&&(o=o.node()),t.isString(i)?n.test(i)?r&&(a='<g xmlns="'+Graph.config.xmlns.svg+'">'+i+"</g>",p=r.parseFromString(a,"text/xml").documentElement.childNodes[0],a=null,p=s?e(p):p):p=s?e(i,o):e(i,o)[0]:p=Graph.isHTML(i)||Graph.isSVG(i)?s?e(i):i:Graph.isElement(i)?s?i.query:i.query[0]:s?e(i,o):i,o=null,p},Graph.dom.clone=function(t,e){return t.cloneNode(e)};var i=Graph.dom.Element=function(t){this.query=e(t)};i.prototype.is=function(t){return this.query.is(t)},i.prototype.node=function(){return this.query[0]},i.prototype.length=function(){return this.query.length},i.prototype.group=function(t){return void 0===t?this.query.data("component-group"):(this.query.data("component-group",t),this)},i.prototype.belong=function(t){return this.group()==t},i.prototype.attr=function(e,r){if(void 0===r)return this.query.attr(e);var n=this,i=this.query[0];if(Graph.isHTML(i))this.query.attr(e,r);else if(Graph.isSVG(i)){if(t.isPlainObject(e))return t.forOwn(e,function(t,e){n.attr(e,t)}),this;"xlink:"==e.substring(0,6)?i.setAttributeNS(Graph.config.xmlns.xlink,e.substring(6),t.toString(r)):i.setAttribute(e,t.toString(r))}return this},i.prototype.width=function(t){return void 0===t?this.query.width():(this.query.width(t),this)},i.prototype.outerHeight=function(t){return this.query.outerHeight(t)},i.prototype.height=function(t){return void 0===t?this.query.height():(this.query.height(t),this)},i.prototype.show=function(){return this.query.show(),this},i.prototype.hide=function(){return this.query.hide(),this},i.prototype.offset=function(){var t=this.query[0];if(Graph.isSVG(t)){var e=t.getBoundingClientRect();return{left:e.left,top:e.top,width:e.width,height:e.height}}return this.query.offset()},i.prototype.position=function(){return this.query.position()},i.prototype.css=function(t,e){return void 0===e?this.query.css(t):(this.query.css(t,e),this)},i.prototype.addClass=function(e){var r=this.query[0];if(Graph.isHTML(r))this.query.addClass(e);else if(Graph.isSVG(r)){var n=t.chain([]).concat(t.split(r.className.baseVal||""," ")).concat(t.split(e," ")).uniq().join(" ").trim().value();r.className.baseVal=n}return this},i.prototype.removeClass=function(t){
var e=this.query[0];return Graph.isHTML(e)&&this.query.removeClass(t),this},i.prototype.hasClass=function(e){var r=this.query[0];if(Graph.isHTML(r))return this.query.hasClass(e);if(Graph.isSVG(r)){return t.split(r.className.baseVal," ").indexOf(e)>-1}return!1},i.prototype.find=function(t){return new Graph.dom.Element(this.query.find(t))},i.prototype.parent=function(){return new Graph.dom.Element(this.query.parent())},i.prototype.closest=function(t){return new Graph.dom.Element(this.query.closest(t))},i.prototype.append=function(t){return void 0===t.query?this.query.append(t):this.query.append(t.query),this},i.prototype.prepend=function(t){return this.query.prepend(t.query),this},i.prototype.appendTo=function(t){return this.query.appendTo(t.query),this},i.prototype.prependTo=function(t){return this.query.prependTo(t.query),this},i.prototype.before=function(t){return this.query.before(t.query),this},i.prototype.after=function(t){return this.query.after(t.query),this},i.prototype.last=function(){return new Graph.dom.Element(this.query.last())},i.prototype.remove=function(){return this.query.remove(),this.query=null,this},i.prototype.detach=function(){return this.query=this.query.detach(),this},i.prototype.on=function(t,e,r,n,i){return this.query.on.call(this.query,t,e,r,n,i),this},i.prototype.off=function(t,e,r){return this.query.off.call(this.query,t,e,r),this},i.prototype.trigger=function(t,e){return this.query.trigger(t,e),this},i.prototype.val=function(t){return void 0===t?this.query.val():(this.query.val(t),this)},i.prototype.text=function(t){return void 0===t?this.query.text():(this.query.text(t),this)},i.prototype.html=function(t){return void 0===t?this.query.html():(this.query.html(t),this)},i.prototype.focus=function(e,r){var n,i=this.query;return r=t.defaultTo(r,0),n=void 0!==this.query.attr("contenteditable")?t.delay(function(){if(clearTimeout(n),n=null,i[0].focus(),document.createRange&&window.getSelection){var t=document.createRange();t.selectNodeContents(i[0]);var e=window.getSelection();e.removeAllRanges(),e.addRange(t)}},r):t.delay(function(){clearTimeout(n),n=null,i.focus(),e&&i.select()},r),this},i.prototype.contextmenu=function(e){(e=t.defaultTo(e,!0))||this.query.on("contextmenu",function(t){return!1})},i.prototype.each=function(t){return this.query.each(t),this},i.prototype.empty=function(){return this.query.empty(),this},i.prototype.data=function(t,e){return void 0===e?this.query.data(t):(this.query.data(t,e),this)},i.prototype.prop=function(t,e){return void 0===e?this.query.data(t):(this.query.prop(t,e),this)},i.prototype.scrollTop=function(t){return void 0===t?this.query.scrollTop():(this.query.scrollTop(t),this)},i.prototype.scrollLeft=function(t){return void 0===t?this.query.scrollLeft():(this.query.scrollLeft(t),this)},i.prototype.toString=function(){return"Graph.dom.Element"},i.guid=0,Graph.$=function(t,e){var r=Graph.dom(t,e,!0);return new Graph.dom.Element(r)}}(_,jQuery),function(){function t(e,r){
var n,i=e.children().toArray();n=r.call(e,e),(n=_.defaultTo(n,!0))&&i.length&&_.forEach(i,function(e){t(e,r)})}function e(t,r){var n,i=t.parent();n=r.call(t,t),(n=_.defaultTo(n,!0))&&i&&e(i,r)}function r(t){return t.parentNode?"svg"==t.parentNode.nodeName?t.parentNode.getBoundingClientRect():r(t.parentNode):{top:0,left:0}}var n=Graph.svg.Vector=Graph.extend({tree:{container:null,paper:null,parent:null,children:null,next:null,prev:null},props:{id:null,guid:null,type:null,text:null,rotate:0,scaleX:1,scaleY:1,traversable:!0,selectable:!0,focusable:!1,snappable:!1,selected:!1,rendered:!1,state:null},attrs:{style:null,class:null},plugins:{transformer:null,collector:null,definer:null,animator:null,resizer:null,rotator:null,reactor:null,dragger:null,dropper:null,network:null,history:null,panzoom:null,toolmgr:null,toolpad:null,snapper:null,editor:null},graph:{matrix:null,layout:null},cached:{bbox:null,bboxView:null,bboxPristine:null,bboxOriginal:null,matrixCurrent:null,matrixView:null,shapeOriginal:null,shapeView:null,position:null,offset:null},elem:null,constructor:function(t,e){var r,i=this;i.graph.matrix=Graph.matrix(),i.tree.children=new Graph.collection.Vector,r="graph-elem-"+ ++n.guid,e=_.extend({},i.attrs,e||{}),i.elem=Graph.$(document.createElementNS(Graph.config.xmlns.svg,t)),e.class?e.class=Graph.styles.VECTOR+" "+e.class:e.class=Graph.styles.VECTOR,i.attr(e),i.props.guid=i.props.id=r,i.props.type=t,r=null,i.elem.data(Graph.string.ID_VECTOR,i.props.guid),i.elem.attr("data-elem",i.props.guid),i.plugins.transformer=new Graph.plugin.Transformer(i).on("aftertranslate",_.bind(i.onTransformerAfterTranslate,i)).on("afterrotate",_.bind(i.onTransformerAfterRotate,i)).on("afterscale",_.bind(i.onTransformerAfterScale,i)),i.isPaper()&&(i.plugins.toolmgr=new Graph.plugin.ToolManager(i).on("activate",_.bind(i.onActivateTool,i)).on("deactivate",_.bind(i.onDeactivateTool,i))),Graph.registry.vector.register(this)},matrix:function(t){return void 0===t?this.graph.matrix:(this.graph.matrix=t,this)},matrixView:function(){var t=this.cached.matrixView;if(!t){var e=this.paper();if(e){var r=e.viewport(),n=r.guid();t=Graph.matrix(),this.bubble(function(e){if(e.guid()==n)return!1;t.multiply(e.matrix())})}else t=this.matrix();this.cached.matrix=t}return t},matrixCurrent:function(){var t,e=this.node().getCTM();return e?(t=new Graph.lang.Matrix(e.a,e.b,e.c,e.d,e.e,e.f),e=null):t=this.matrix().clone(),t},layout:function(t){if(void 0===t)return this.graph.layout;var e,r;return t="default"==t?"layout":t,_.isString(t)?(e=Graph.layout[_.capitalize(t)],r=Graph.factory(e,[this])):_.isPlainObject(t)&&t.name&&(e=Graph.layout[_.capitalize(t.name)],delete t.name,r=Graph.factory(e,[this,t])),r.refresh(),this.graph.layout=r,this},reset:function(){this.graph.matrix=Graph.matrix(),this.removeAttr("transform"),this.props.rotate=0,this.props.scale=0,this.dirty(!0),this.fire("reset",this.props)},invalidate:function(t){this.cached[t]=null},state:function(t){
return void 0===t?this.props.state:(this.props.state=t,this)},dirty:function(t){var e=this;if(void 0===t)return null===e.cached.bbox;if(t){for(var r in this.cached)e.cached[r]=null;var n=["resizer","rotator","network"];_.forEach(n,function(t){e.plugins[t]&&e.plugins[t].invalidate()})}return this},interactable:function(t){return this.plugins.reactor||(this.plugins.reactor=new Graph.plugin.Reactor(this,t)),this.plugins.reactor},animable:function(){var t=this;return t.plugins.animator||(t.plugins.animator=new Graph.plugin.Animator(t),t.plugins.animator.on({animstart:function(e){t.fire(e)},animating:function(e){t.fire(e)},animend:function(e){t.fire(e)}})),t.plugins.animator},resizable:function(t){return this.plugins.resizer?void 0!==t&&this.plugins.resizer.options(t):(this.plugins.resizer=new Graph.plugin.Resizer(this,t),this.plugins.resizer.on({beforeresize:_.bind(this.onResizerBeforeResize,this),afterresize:_.bind(this.onResizerAfterResize,this)})),this.plugins.resizer},rotatable:function(t){return this.plugins.rotator||(this.plugins.rotator=new Graph.plugin.Rotator(this,t),this.plugins.rotator.on({afterrotate:_.bind(this.onRotatorAfterRotate,this)})),this.plugins.rotator},draggable:function(t){return this.plugins.dragger||(this.plugins.dragger=new Graph.plugin.Dragger(this,t),this.plugins.dragger.on({beforedrag:_.bind(this.onDraggerStart,this),drag:_.bind(this.onDraggerMove,this),afterdrag:_.bind(this.onDraggerEnd,this)})),this.plugins.dragger},zoomable:function(){return this.plugins.panzoom||(this.plugins.panzoom=new Graph.plugin.Panzoom(this),this.plugins.toolmgr.register("panzoom")),this.plugins.panzoom},droppable:function(){return this.plugins.dropper||(this.plugins.dropper=new Graph.plugin.Dropper(this),this.plugins.dropper.on({dropenter:_.bind(this.onDropperEnter,this),dropleave:_.bind(this.onDropperLeave,this)})),this.plugins.dropper},connectable:function(t){return this.plugins.network?void 0!==t&&this.plugins.network.options(t):this.plugins.network=new Graph.plugin.Network(this,t),this.plugins.network},traversable:function(t){return void 0===t?this.props.traversable:(this.props.traversable=t,this)},selectable:function(t){return void 0===t?this.props.selectable:(this.props.selectable=t,this)},clickable:function(t){return void 0===t?"none"!=this.attrs["pointer-events"]:(this.attr("pointer-events",t?"":"none"),this)},editable:function(t){var e=this;return this.plugins.editor||(this.plugins.editor=new Graph.plugin.Editor(this,t),this.plugins.editor.on({beforeedit:function(t){e.fire(t)},edit:function(t){e.fire(t)}})),this.plugins.editor},snappable:function(t){var e,r=this,n=r.paper();if(t=_.isBoolean(t)?{enabled:t}:_.extend({enabled:!0},t||{}),r.props.snappable=t.enabled,n?e=n.plugins.snapper:(n=Graph.svg.Paper.getDefaultInstance(),e=n.plugins.snapper,r.on("render",function(){r.paper().plugins.snapper.setup(r,t)})),!n)throw Graph.error("Unable to install snapper plugin. Paper doesn't rendered yet!");return e},id:function(){return this.props.id
},guid:function(){return this.props.guid},node:function(){return this.elem.node()},data:function(t,e){var r=this;return _.isPlainObject(t)?(_.forOwn(t,function(t,e){r.props[e]=t}),this):void 0===t&&void 0===e?r.props:void 0===e?r.props[t]:(r.props[t]=e,this)},attr:function(t,e){var r=this,n=r.node();return _.isPlainObject(t)?(_.forOwn(t,function(t,e){!function(t,e){r.attr(e,t)}(t,e)}),r):void 0===t?r.attrs:void 0===e?r.attrs[t]||"":(r.attrs[t]=e,null!==e&&("xlink:"==t.substring(0,6)?n.setAttributeNS(Graph.config.xmlns.xlink,t.substring(6),_.toString(e)):"class"==t?n.className.baseVal=_.toString(e):n.setAttribute(t,_.toString(e))),r)},removeAttr:function(t){return this.node().removeAttribute(t),this.attrs[t]&&delete this.attrs[t],this},style:function(t,e){var r=this;return _.isPlainObject(t)?(_.forOwn(t,function(t,e){r.style(e,t)}),this):(this.elem.css(t,e),this)},cursor:function(t){this.elem.css("cursor",t)},hasClass:function(t){return _.indexOf(_.split(this.attrs.class," "),t)>-1},addClass:function(t){var e=_.chain(this.attrs.class).split(" ").concat(_.split(t," ")).uniq().join(" ").trim().value();return this.attr("class",e),this},removeClass:function(t){var e=_.split(this.attrs.class," "),r=_.isArray(t)?t:_.split(t," ");return _.pullAll(e,r),this.attr("class",_.join(e," ")),this},hide:function(){this.elem.hide()},show:function(){this.elem.show()},shape:function(){return new Graph.lang.Path([])},shapeOriginal:function(){var t=this.cached.shapeOriginal;if(!t){var e=this.matrixView(),r=e.rotate().deg;if(t=this.shape(),r){var n=e.clone(),i=this.bboxPristine().center().toJson();n.rotate(-r,i.x,i.y),t=t.transform(n)}else t=t.transform(e);this.cached.shapeOriginal=t}return t},shapeView:function(){var t=this.cached.shapeView;if(!t){var e=this.matrixView();t=this.shape().transform(e),this.cached.shapeView=t}return t},shapeRelative:function(){var t=this.parent(),e=t.matrixView().clone().invert(),r=this.matrixView().clone(),n=this.shape();return r.multiply(e),n=n.transform(r),r=e=t=null,n},vertices:function(t){var e,r,n,i;return t=_.defaultTo(t,!1),e=t?this.matrixCurrent():this.matrix(),r=this.shape().transform(e),n=r.segments,i=[],_.forEach(n,function(t){var e,r;"Z"!=t[0]&&(e=t[t.length-2],r=t[t.length-1],i.push([e,r]))}),i},dimension:function(){var t={},e=this.node();try{t=e.getBBox()}catch(r){t={x:e.clientLeft,y:e.clientTop,width:e.clientWidth,height:e.clientHeight}}finally{t=t||{}}return t},offset:function(){var t=this.node(),e=t.getBoundingClientRect();return{top:e.top,left:e.left,bottom:e.bottom,right:e.right,width:e.width,height:e.height}},position:function(){if(!this.cached.position){var t=this.node(),e=t.getBoundingClientRect(),n=r(t);this.cached.position={top:e.top-n.top,left:e.left-n.left,bottom:e.bottom-n.top,right:e.right-n.left,width:e.width,height:e.height}}return this.cached.position},bbox:function(){var t=this.cached.bbox;if(!t){var e=this.shape(),r=this.matrix();e=e.transform(r),t=e.bbox(),this.cached.bbox=t,e=r=null}return t},
bboxPristine:function(){var t=this.cached.bboxPristine;if(!t){t=this.shape().bbox(),this.cached.bboxPristine=t}return t},bboxView:function(){var t=this.cached.bboxView;if(!t){var e=this.matrixView(),r=this.shape();r=r.transform(e),t=r.bbox(),this.cached.bboxView=t}return t},bboxOriginal:function(){var t=this.cached.bboxOriginal;if(!t){var e=this.shapeOriginal(),r=this.matrixView().rotate();t=e.bbox(),t.rotate=r,this.cached.bboxOriginal=t}return t},find:function(t){var e=this.elem.find(t),r=[];return e.each(function(t,e){r.push(Graph.registry.vector.get(e))}),new Graph.collection.Vector(r)},render:function(t,e,r){var n,i=this,o=i.guid(),s=i.props.traversable;if(i.props.rendered)return i;if(t=_.defaultTo(t,i.paper()),e=_.defaultTo(e,"append"),t){switch(t.isPaper()&&(t=t.viewport()),i.tree.paper=t.tree.paper,s&&(i.tree.parent=t.guid()),e){case"before":if(!r)throw Graph.error("vector.render(): Sibling vector is undefined");r.elem.query.before(i.elem.query),s&&(n=t.children().index(r),t.children().insert(i,n));break;case"after":if(!r)throw Graph.error("vector.render(): Sibling vector is undefined");r.elem.query.after(i.elem.query),s&&(n=t.children().index(r),t.children().insert(i,n+1));break;case"append":t.elem.query.append(i.elem.query),s&&t.children().push(i);break;case"prepend":t.elem.query.prepend(i.elem.query),s&&t.children().unshift(i)}if(t.props.rendered){i.props.rendered=!0,i.fire("render");var a=t.isViewport()?t.paper():null;a&&Graph.registry.vector.setContext(o,i.tree.paper),i.cascade(function(t){t===i||t.props.rendered||(t.props.rendered=!0,t.tree.paper=i.tree.paper,t.fire("render"),a&&Graph.registry.vector.setContext(t.props.guid,i.tree.paper))})}}return i},children:function(){return this.tree.children},attach:function(t,e){if(!this.isContainer())return this;if(e=_.defaultTo(e,"append"),t.isRendered()){var r=this.isPaper()?this.viewport():this,n=t.isTraversable();if(n){var i=t.parent();i&&(i.children().pull(t),t.tree.parent=null)}if(r.elem[e](t.elem),n){switch(e){case"append":r.children().push(t);break;case"prepend":r.children().unshift(t)}t.tree.parent=this.guid()}}else t.render(this,e);return this},detach:function(){return this.elem.detach(),this},append:function(t){return this.attach(t,"append")},prepend:function(t){return this.attach(t,"prepend")},relocate:function(t){t.isPaper()&&(t=t.viewport());var e=this.matrixView().clone();this.graph.matrix=e,this.attr("transform",e.toValue()),this.dirty(!0),t.append(this);var r=t.matrixView().clone(),n=this.matrix().clone();n.multiply(r.invert()),this.graph.matrix=n,this.attr("transform",n.toValue()),r=n=null,this.dirty(!0)},ancestors:function(){var t=[],e=this.guid();return this.bubble(function(r){r.guid()!=e&&t.push(r)}),new Graph.collection.Vector(t)},descendants:function(){var t=[],e=this.guid();return this.cascade(function(r){r.guid()!=e&&t.push(r)}),new Graph.collection.Vector(t)},paper:function(){return this.isPaper()?this:Graph.registry.vector.get(this.tree.paper)},parent:function(){
return Graph.registry.vector.get(this.tree.parent)},prev:function(){return Graph.registry.vector.get(this.tree.prev)},next:function(){return Graph.registry.vector.get(this.tree.next)},cascade:function(e){t(this,e)},bubble:function(t){return e(this,t)},remove:function(){var t=this.parent();if(!this.props.removed){this.props.removed=!0,this.fire("beforedestroy"),this.deselect();for(var e in this.plugins)this.plugins[e]&&(this.plugins[e].destroy(),this.plugins[e]=null);t&&t.children().pull(this),this.elem&&(this.elem.remove(),this.elem=null),Graph.registry.vector.unregister(this),this.fire("afterdestroy"),this.listeners=null}},empty:function(){var t=this.guid();return this.cascade(function(e){e.guid()!=t&&Graph.registry.vector.unregister(e)}),this.children().clear(),this.elem.empty(),this},select:function(){var t=this.paper(),e=!1;if(t){var r=t.collector();r.add(this),0===r.index(this)&&(e=!0)}else e=!0;return this.addClass("graph-selected"),this.props.selected=!0,e&&(this.isResizable()&&this.resizable().resume(),this.isRotatable()&&this.rotatable().resume()),this.fire("select",{initial:e}),this},deselect:function(){var t=this.paper(),e=!1;if(t){var r=t.collector();e=0===r.index(this),r.remove(this)}return this.removeClass("graph-selected"),this.props.selected=!1,this.isResizable()&&this.resizable().suspend(),this.isRotatable()&&this.rotatable().suspend(),this.fire("deselect",{initial:e}),this},collector:function(){return this._collector},transform:function(t){return this.plugins.transformer.transform(t)},translate:function(t,e){return this.plugins.transformer.translate(t,e)},scale:function(t,e,r,n){return void 0===t?this.matrixCurrent().scale():this.plugins.transformer.scale(t,e,r,n)},rotate:function(t,e,r){return this.plugins.transformer.rotate(t,e,r)},animate:function(t,e,r,n){return this.plugins.animator?(this.plugins.animator.animate(t,e,r,n),this.plugins.animator):null},label:function(t){return this.elem.text(t),this},sendToFront:function(){return this.tree.paper?(this.paper().elem.append(this.elem),this):this},sendToBack:function(){return this.tree.paper?(this.paper().elem.prepend(this.elem),this):this},resize:function(t,e,r,n,i,o){return this},isContainer:function(){return this.isGroup()||this.isPaper()},isGroup:function(){return"g"==this.props.type},isPaper:function(){return"svg"==this.props.type},isViewport:function(){return!0===this.props.viewport},isTraversable:function(){return this.props.traversable},isSelectable:function(){return this.props.selectable},isDraggable:function(){return null!==this.plugins.dragger},isResizable:function(){return null!==this.plugins.resizer},isRotatable:function(){return null!==this.plugins.rotator},isConnectable:function(){return!!this.plugins.network},isSnappable:function(){return this.props.snappable},isRendered:function(){return this.props.rendered},isSelected:function(){return!0===this.props.selected},tool:function(){return this.plugins.toolmgr},toString:function(){return"Graph.svg.Vector"},
onResizerBeforeResize:function(t){this.fire(t)},onResizerAfterResize:function(t){this.dirty(!0),this.fire(t),Graph.topic.publish("vector:afterresize",t)},onDraggerStart:function(t){t.master=!0,this.fire(t);var e=this.collector();e&&e.syncBeforeDrag(this,t),this.plugins.resizer&&this.plugins.resizer.suspend(),this.plugins.rotator&&this.plugins.rotator.suspend(),this.plugins.editor&&this.plugins.editor.suspend()},onDraggerMove:function(t){t.master=!0;var e=this.collector();e&&e.syncDrag(this,t),this.fire(t)},onDraggerEnd:function(t){this.dirty(!0),t.master=!0,this.fire(t);var e=this.collector();e&&e.syncAfterDrag(this,t),Graph.topic.publish("vector:afterdrag",t)},onDropperEnter:function(t){this.fire(t)},onDropperLeave:function(t){this.fire(t)},onTransformerAfterRotate:function(t){this.dirty(!0),this.props.rotate=t.deg,this.fire("afterrotate",{deg:t.deg})},onTransformerAfterTranslate:function(t){this.dirty(!0),this.fire("aftertranslate",{dx:t.dx,dy:t.dy})},onTransformerAfterScale:function(t){if(this.dirty(!0),this.props.scaleX=t.sx,this.props.scaleY=t.sy,this.fire("afterscale",{sx:t.sx,sy:t.sy}),this.plugins.dragger){var e=this.matrixCurrent().scale();this.plugins.dragger.scale(e.x,e.y)}},onRotatorAfterRotate:function(t){this.fire(t)},onActivateTool:function(t){var e=t.originalData;this.fire("activatetool",e)},onDeactivateTool:function(t){var e=t.originalData;this.fire("deactivatetool",e)}});n.guid=0,Graph.isVector=function(t){return t instanceof Graph.svg.Vector}}(),function(){Graph.svg.Ellipse=Graph.extend(Graph.svg.Vector,{constructor:function(t,e,r,n){this.superclass.prototype.constructor.call(this,"ellipse",{cx:t,cy:e,rx:r,ry:n})},shape:function(){var t=this.attrs;return Graph.path([["M",t.cx,t.cy],["m",0,-t.ry],["a",t.rx,t.ry,0,1,1,0,2*t.ry],["a",t.rx,t.ry,0,1,1,0,-2*t.ry],["z"]])},resize:function(t,e,r,n,i,o){var s,a,p=this.graph.matrix.clone().scale(t,e,r,n),h=this.props.rotate,c=p.x(this.attrs.cx,this.attrs.cy),l=p.y(this.attrs.cx,this.attrs.cy),u=this.attrs.rx*t,d=this.attrs.ry*e;this.reset(),this.attr({cx:c,cy:l,rx:u,ry:d}),h&&this.rotate(h,c,l).commit();var f=this.bbox().toJson();return s=c-u-i,a=l-d-o,s=f.x,a=f.y,{matrix:p,translate:{dx:i,dy:o},scale:{sx:t,sy:e,cx:r,cy:n},rotate:{deg:h,cx:c,cy:l},magnify:{cx:s,cy:a}}},toString:function(){return"Graph.svg.Ellipse"}})}(),function(){Graph.svg.Circle=Graph.extend(Graph.svg.Vector,{constructor:function(t,e,r){var n=this;Graph.isPoint(t)&&(r=e,e=t.props.y,t=t.props.x),n.superclass.prototype.constructor.call(n,"circle",{cx:t,cy:e,r:r})},shape:function(){var t=this.attrs;return Graph.path([["M",t.cx,t.cy],["m",0,-t.r],["a",t.r,t.r,0,1,1,0,2*t.r],["a",t.r,t.r,0,1,1,0,-2*t.r],["z"]])},resize:function(t,e,r,n,i,o){var s,a,p,h=this.graph.matrix.clone(),c=this.props.rotate,l=this.attrs.cx,u=this.attrs.cy,d=this.attrs.r;return 1===e?(p=d*t,e=t):1===t?(p=d*e,t=e):t<e?(p=d*e,t=e):t>e&&(p=d*t,e=t),h.scale(t,e,r,n),s=h.x(l,u),a=h.y(l,u),this.reset(),this.attr({cx:s,cy:a,r:p}),
c&&this.rotate(c,s,a).commit(),{matrix:h,translate:{dx:i,dy:o},scale:{sx:t,sy:e,cx:r,cy:n},rotate:{deg:c,cx:s,cy:a}}},toString:function(){return"Graph.svg.Circle"}})}(),function(){Graph.svg.Rect=Graph.extend(Graph.svg.Vector,{constructor:function(t,e,r,n,i){var o=this;i=_.defaultTo(i,6),o.superclass.prototype.constructor.call(o,"rect",{x:_.defaultTo(t,0),y:_.defaultTo(e,0),rx:i,ry:i,width:_.defaultTo(r,0),height:_.defaultTo(n,0)}),o.origpath=o.shape()},attr:function(t,e){var r=this.superclass.prototype.attr.apply(this,[t,e]);return"rx"==t&&void 0!==e&&(this.attrs.r=this.attrs.rx),r},shape:function(){var t=this.attrs;return t.r?Graph.path([["M",t.x+t.r,t.y],["l",t.width-2*t.r,0],["a",t.r,t.r,0,0,1,t.r,t.r],["l",0,t.height-2*t.r],["a",t.r,t.r,0,0,1,-t.r,t.r],["l",2*t.r-t.width,0],["a",t.r,t.r,0,0,1,-t.r,-t.r],["l",0,2*t.r-t.height],["a",t.r,t.r,0,0,1,t.r,-t.r],["z"]]):Graph.path([["M",t.x,t.y],["l",t.width,0],["l",0,t.height],["l",-t.width,0],["z"]])},resize:function(t,e,r,n,i,o){var s,a,p,h,c=this.matrix().clone(),l=c.rotate().deg;return c.scale(t,e,r,n),this.reset(),s=c.x(this.attrs.x,this.attrs.y),a=c.y(this.attrs.x,this.attrs.y),p=this.attrs.width*t,h=this.attrs.height*e,this.attr({x:s,y:a,width:p,height:h}),l&&this.rotate(l,s,a).commit(),{matrix:c,translate:{dx:i,dy:o},scale:{sx:t,sy:e,cx:r,cy:n},rotate:{deg:l,cx:s,cy:a}}},toString:function(){return"Graph.svg.Rect"}})}(),function(){Graph.svg.Path=Graph.extend(Graph.svg.Vector,{constructor:function(t){t||(t=[["M",0,0]]),t=_.isArray(t)?Graph.path(Graph.util.segments2path(t)).absolute().toValue():t instanceof Graph.lang.Path?t.toValue():Graph.path(t).absolute().toValue(),this.superclass.prototype.constructor.call(this,"path",{d:t})},shape:function(){return Graph.path(this.attrs.d)},segments:function(){return this.shape().segments},intersection:function(t,e){return this.shape().intersection(t.shape(),e)},intersectnum:function(t){return this.shape().intersectnum(t.shape())},angle:function(){var t=_.clone(this.segments()),e=t.length-1;"Z"==t[e][0]&&(e--,t.pop()),1===t.length&&(e++,t.push(["L",t[0][1],t[0][2]]));var r=t[e][1]-t[e-1][1],n=t[e][2]-t[e-1][2];return(180+180*Math.atan2(-n,-r)/Math.PI+360)%360},slice:function(t,e){return this.shape().slice(t,e)},pointAt:function(t){return this.shape().pointAt(t)},length:function(){return this.shape().length()},addVertext:function(t){var e=this.shape();return e.addVertext(t),this.attr("d",e.command()),this},resize:function(t,e,r,n,i,o){var s=this.matrix().clone(),a=matrix.rotate(),p=a.deg,h=a.rad,c=(Math.sin(h),Math.cos(h),this.shape()),l=c.segments,u=l[0][1],d=l[0][2];return p&&s.rotate(-p,u,d),u=s.x(l[0][1],l[0][2]),d=s.y(l[0][1],l[0][2]),s.scale(t,e,r,n),_.forEach(l,function(t){var e,r,n,i;"Z"!=t[0]&&(e=t[t.length-2],r=t[t.length-1],n=s.x(e,r),i=s.y(e,r),t[t.length-2]=n,t[t.length-1]=i)}),this.reset(),this.attr("d",c.command()),p&&this.rotate(p,u,d).commit(!0),{matrix:s,x:u,y:d}},moveTo:function(t,e){var r=this.shape();return r.moveTo(t,e),
this.attr("d",r.command()),this},lineTo:function(t,e,r){var n=this.shape();return n.lineTo(t,e,r),this.attr("d",n.command()),this},tail:function(){var t=this.segments();return t.length?Graph.point(t[0][1],t[0][2]):null},head:function(){var t,e=this.segments();return e.length?(t=e.length-1,Graph.point(e[t][1],e[t][2])):null},toString:function(){return"Graph.svg.Path"}})}(),function(){Graph.svg.Polyline=Graph.extend(Graph.svg.Vector,{constructor:function(t){t=_.defaultTo(t,""),_.isArray(t)&&(t.length?(_.isPlainObject(t[0])&&(t=_.map(t,function(t){return t.x+","+t.y})),t=_.join(t,",")):t=""),this.superclass.prototype.constructor.call(this,"polyline",{points:t})},shape:function(){var t=Graph.util.polygon2path(this.attrs.points);return t=t.replace(/Z/i,""),Graph.path(t)},attr:function(t,e){return"points"==t&&_.isArray(e)&&(e=_.join(_.map(e,function(t){return t[0]+","+t[1]})," ")),this.superclass.prototype.attr.call(this,t,e)},toString:function(){return"Graph.svg.Polyline"}})}(),function(){Graph.svg.Polygon=Graph.extend(Graph.svg.Vector,{constructor:function(t){t=_.defaultTo(t,""),_.isArray(t)&&(t.length?(_.isPlainObject(t[0])&&(t=_.map(t,function(t){return t.x+","+t.y})),t=_.join(t,",")):t=""),this.superclass.prototype.constructor.call(this,"polygon",{points:t})},attr:function(t,e){return"points"==t&&_.isArray(e)&&(e=_.join(e,",")),this.superclass.prototype.attr.call(this,t,e)},shape:function(){var t=Graph.util.polygon2path(this.attrs.points);return Graph.path(t)},resize:function(t,e,r,n,i,o){var s=this.graph.matrix.clone(),a=this.graph.matrix.clone(),p=this.props.rotate,h=this.shape().segments,c=[],l=h[0][1],u=h[0][2];return p&&(a.rotate(-p,h[0][1],h[0][2]),l=a.x(h[0][1],h[0][2]),u=a.y(h[0][1],h[0][2])),a.scale(t,e,r,n),s.scale(t,e,r,n),_.forEach(h,function(t){var e,r,n,i;"Z"!=t[0]&&(e=t[t.length-2],r=t[t.length-1],n=a.x(e,r),i=a.y(e,r),c.push(n+","+i))}),c=_.join(c," "),this.reset(),this.attr("points",c),p&&this.rotate(p,l,u).commit(),{matrix:s,translate:{dx:i,dy:o},scale:{sx:t,sy:e,cx:r,cy:n},rotate:{deg:p,cx:l,cy:u}}},toString:function(){return"Graph.svg.Polygon"}})}(),function(){Graph.svg.Group=Graph.extend(Graph.svg.Vector,{attrs:{stroke:null,"stroke-width":null,class:null,fill:null,style:null},constructor:function(t,e){this.superclass.prototype.constructor.call(this,"g"),void 0!==t&&void 0!==e&&(this.graph.matrix.translate(t,e),this.attr("transform",this.graph.matrix.toValue()))},shape:function(){var t=this.dimension();return new Graph.lang.Path([["M",t.x,t.y],["l",t.width,0],["l",0,t.height],["l",-t.width,0],["z"]])},toString:function(){return"Graph.svg.Group"}})}(),function(){Graph.svg.Text=Graph.extend(Graph.svg.Vector,{attrs:{"text-anchor":"middle"},props:{id:"",guid:"",text:"",type:"text",rotate:0,lineHeight:1.1,fontSize:12,traversable:!0,focusable:!1,selectable:!0,selected:!1,rendered:!1},rows:[],constructor:function(t,e,r){this.superclass.prototype.constructor.call(this,"text",{x:_.defaultTo(t,0),y:_.defaultTo(e,0)}),this.attr({
"font-size":Graph.config.font.size}),r&&this.write(r),this.on("render",_.bind(this.onTextRender,this))},attr:function(t,e){var r=this.superclass.prototype.attr.apply(this,[t,e]);return"font-size"==t&&void 0!==e&&(this.props.fontSize=_.parseInt(e)||12),r},write:function(t){var e,r=this;if(void 0===t)return r.props.text;e=(t||"").split("\n"),r.empty(),r.rows=[],_.forEach(e,function(t,e){r.addSpan(t)}),r.props.text=t,r.cached.bbox=null},addSpan:function(t){var e,r=this;return t=_.defaultTo(t,""),e=Graph.$("<tspan/>"),e.text(t),r.elem.append(e),r.rows.push(e),e},arrange:function(){var t=this.rows,e=this.props.fontSize,r=this.props.lineHeight;this.bbox().toJson();if(t.length){for(var n=0,i=t.length;n<i;n++)n&&(t[n].attr("x",this.attrs.x),t[n].attr("dy",e*r));t[0].attr("dy",0),this.dirty(!0)}},wrap:function(t){var e,r,n=this.props.text,i=n.split(/\s+/).reverse(),o=[],s=0,a=this.props.lineHeight,p=this.attrs.x,h=this.attrs.y;for(this.empty(),this.rows=[],r=this.addSpan(),r.attr({x:p,y:h,dy:"0em"});e=i.pop();)o.push(e),r.text(o.join(" ")),r.node().getComputedTextLength()>t&&(o.pop(),r.text(o.join(" ")),o=[e],r=this.addSpan(e),r.attr({x:p,y:h,dy:++s*a+"em"}))},center:function(t){if(t){var e,r,n,i=t.bbox().toJson(),o=this.matrix().rotate();this.reset(),e=this.bbox().toJson(),r=i.width/2,n=i.height/2,e.x+e.width/2,e.y+e.height/2,o.deg?this.translate(r,n).rotate(o.deg).commit():this.translate(r,n).commit()}},shape:function(){var t=this.dimension();return new Graph.lang.Path([["M",t.x,t.y],["l",t.width,0],["l",0,t.height],["l",-t.width,0],["z"]])},toString:function(){return"Graph.svg.Text"},onTextRender:function(){this.arrange()}})}(),function(){Graph.svg.Image=Graph.extend(Graph.svg.Vector,{attrs:{preserveAspectRatio:"none"},constructor:function(t,e,r,n,i){var o=this;o.superclass.prototype.constructor.call(o,"image",{"xlink:href":t,x:_.defaultTo(e,0),y:_.defaultTo(r,0),width:_.defaultTo(n,0),height:_.defaultTo(i,0)})},align:function(t,e){if("none"==t)return this.attr("preserveAspectRatio","none"),this;var r=this.attrs.preserveAspectRatio,n="";switch(r=/(meet|slice)/.test(r)?r.replace(/(.*)\s*(meet|slice)/i,"$2"):"",e=_.defaultTo(e,r),t=t.replace(/s+/," ").toLowerCase()){case"top left":case"left top":n="xMinYMin";break;case"top center":case"center top":n="xMidYMin";break;case"top right":case"right top":n="xMaxYMin";break;case"left":n="xMinYMid";break;case"center":n="xMidYMid";break;case"right":n="xMaxYMid";break;case"bottom left":case"left bottom":n="xMinYMax";break;case"bottom center":case"center bottom":n="xMidYMax";break;case"bottom right":case"right bottom":n="xMaxYMax"}return r=n+(e?" "+e:""),this.attr("preserveAspectRatio",r),this},shape:function(){var t=this.attrs;return new Graph.lang.Path([["M",t.x,t.y],["l",t.width,0],["l",0,t.height],["l",-t.width,0],["z"]])},resize:function(t,e,r,n,i,o){var s=this.graph.matrix.clone().scale(t,e,r,n),a=this.graph.matrix.rotate();this.reset()
;var p=s.x(this.attrs.x,this.attrs.y),h=s.y(this.attrs.x,this.attrs.y),c=+this.attrs.width*t,l=+this.attrs.height*e;return this.attr({x:p,y:h,width:c,height:l}),this.rotate(a,p,h).commit(),{matrix:s,x:p,y:h}},toString:function(){return"Graph.svg.Image"}})}(),function(){Graph.svg.Line=Graph.extend(Graph.svg.Vector,{constructor:function(t,e,r,n){var i=_.toArray(arguments);if(1===i.length){var o=i[0].start().toJson(),s=i[0].end().toJson();t=o.x,e=o.y,r=s.x,n=s.y}else 2===i.length&&(Graph.isPoint(i[0])?(t=i[0].props.x,e=i[0].props.y,r=i[1].props.x,n=i[1].props.y):(t=i[0].x,e=i[0].y,r=i[1].x,n=i[1].y));this.superclass.prototype.constructor.call(this,"line",{x1:_.defaultTo(t,0),y1:_.defaultTo(e,0),x2:_.defaultTo(r,0),y2:_.defaultTo(n,0)})},toString:function(){return"Graph.svg.Line"}})}(),function(){var t=Graph.svg.Paper=Graph.extend(Graph.svg.Vector,{attrs:{class:Graph.styles.PAPER},props:{id:null,guid:null,type:"paper",text:null,rotate:0,traversable:!1,selectable:!1,selected:!1,focusable:!1,rendered:!1,showOrigin:!0,zoomable:!0},components:{viewport:null},diagram:{enabled:!0,manager:null},constructor:function(e,r,n){var i=this;i.superclass.prototype.constructor.call(i,"svg",{xmlns:Graph.config.xmlns.svg,"xmlns:link":Graph.config.xmlns.xlink,version:Graph.config.svg.version}),_.assign(i.props,n||{}),i.style({overflow:"hidden",position:"relative"}),i.interactable(),i.initLayout(),i.plugins.collector=new Graph.plugin.Collector(i),i.plugins.toolmgr.register("collector","plugin"),i.plugins.linker=new Graph.plugin.Linker(i),i.plugins.toolmgr.register("linker","plugin"),i.plugins.pencil=new Graph.plugin.Pencil(i),i.plugins.toolmgr.register("pencil","plugin"),i.plugins.definer=new Graph.plugin.Definer(i),i.plugins.snapper=new Graph.plugin.Snapper(i),i.plugins.toolpad=new Graph.plugin.Toolpad(i),i.plugins.clipper=new Graph.plugin.Clipper(i),i.diagram.enabled=!0,i.diagram.manager=new Graph.diagram.Manager(i),Graph.topic.subscribe("link:change",_.bind(i.listenLinkChange,i)),Graph.topic.subscribe("link:afterdestroy",_.bind(i.listenLinkAfterDestroy,i)),t.defaultInstance||(t.defaultInstance=i.guid())},initLayout:function(){var t=(new Graph.svg.Group).addClass(Graph.styles.VIEWPORT).selectable(!1);if(t.props.viewport=!0,this.components.viewport=t.guid(),this.props.showOrigin){var e=Graph.$('<g class="graph-elem graph-origin"><rect class="x" rx="1" ry="1" x="-16" y="-1" height="1" width="30"></rect><rect class="y" rx="1" ry="1" x="-1" y="-16" height="30" width="1"></rect><text class="t" x="-40" y="-10">(0, 0)</text></g>');e.appendTo(t.elem),e=null}t.tree.paper=t.tree.parent=this.guid(),this.elem.append(t.elem),this.children().push(t),t.on("render",function(){t.cascade(function(e){e===t||e.props.rendered||(e.props.rendered=!0,e.tree.paper=t.tree.paper,e.fire("render"))})}),this.layout("default")},layout:function(t){var e=this.viewport();return void 0===t?e.graph.layout:(e.layout(t),this)},shape:function(t,e){var r=Graph.shape(t,e);return r.render(this),r},
render:function(t){var e=this,r=e.viewport();e.guid();if(!e.props.rendered){if(t=Graph.$(t),t.append(e.elem),e.tree.container=t,e.elem.css({width:"100%",height:"100%"}),e.props.rendered=!0,e.fire("render"),r.props.rendered=!0,r.fire("render"),e.props.zoomable){e.zoomable();var n=_.debounce(function(){n.flush(),n=null,e.tool().activate("panzoom")},1e3);n()}return e}},container:function(){return this.tree.container},collector:function(){return this.plugins.collector},snapper:function(){return this.plugins.snapper},viewport:function(){return Graph.registry.vector.get(this.components.viewport)},diagram:function(){return this.diagram.manager},scale:function(t,e,r,n){return void 0===t?this.viewport().matrix().scale():this.plugins.transformer.scale(t,e,r,n)},width:function(){return this.elem.width()},height:function(){return this.elem.height()},locateLink:function(t){var e=Graph.registry.link.get(t);e&&e.select(!1)},locateShape:function(t){var e=Graph.registry.shape.get(t);e&&e.select(!1)},toString:function(){return"Graph.svg.Paper"},listenLinkChange:_.debounce(function(){this.layout().arrangeLinks()},300),listenLinkAfterDestroy:_.debounce(function(){this.layout().arrangeLinks()},10)});t.defaultInstance=null,t.getDefaultInstance=function(){return Graph.registry.vector.get(t.defaultInstance)};var e={ellipse:"Ellipse",circle:"Circle",rect:"Rect",path:"Path",polyline:"Polyline",polygon:"Polygon",group:"Group",text:"Text",image:"Image",line:"Line"};_.forOwn(e,function(e,r){!function(e,r){t.prototype[r]=function(){var t=[e].concat(_.toArray(arguments)),r=Graph.svg.apply(null,t);return r.tree.paper=this.guid(),r.render(this),t=null,r}}(e,r)})}(),function(){var t={},e={},r=function(){};r.prototype.constructor=r,r.prototype.register=function(e){var r=e.guid();this.get(r);t[r]=e},r.prototype.unregister=function(r){var n=r.guid();t[n]&&delete t[n],e[n]&&delete e[n]},r.prototype.setContext=function(r,n){t[r]&&(e[r]=n)},r.prototype.size=function(){return _.keys(t).length},r.prototype.toArray=function(){var e=_.keys(t);return _.map(e,function(e){return t[e]})},r.prototype.get=function(e){return _.isUndefined(e)?this.toArray():(e instanceof SVGElement?("tspan"==e.tagName&&(e=e.parentNode),e=Graph.$(e).data(Graph.string.ID_VECTOR)):e instanceof Graph.dom.Element&&(e=e.data(Graph.string.ID_VECTOR)),t[e])},r.prototype.collect=function(r){var n=[];for(var i in e)e[i]==r&&t[i]&&n.push(t[i]);return n},r.prototype.wipe=function(e){var r=e.guid();for(var n in t)t.hasOwnProperty(n)&&t[n].tree.paper==r&&delete t[n];t[r]&&delete t[r]},r.prototype.toString=function(){return"Graph.registry.Vector"},Graph.registry.vector=new r}(),function(){var t={},e={},r=function(){};r.prototype.constructor=r,r.prototype.register=function(e){var r=e.guid();t[r]=e},r.prototype.unregister=function(r){var n=r.guid();t[n]&&delete t[n],e[n]&&delete e[n]},r.prototype.setContext=function(r,n){t[r]&&(e[r]=n)},r.prototype.size=function(){return _.keys(t).length},r.prototype.has=function(e){
return void 0!==t[e]},r.prototype.get=function(e){return void 0===e?this.toArray():(e instanceof SVGElement?e=Graph.$(e).data(Graph.string.ID_LINK):e instanceof Graph.dom.Element?e=e.data(Graph.string.ID_LINK):e instanceof Graph.svg.Vector&&(e=e.elem.data(Graph.string.ID_LINK)),t[e])},r.prototype.collect=function(r){var n=[];for(var i in e)e[i]==r&&t[i]&&n.push(t[i]);return n},r.prototype.toArray=function(){var e=_.keys(t);return _.map(e,function(e){return t[e]})},r.prototype.toString=function(){return"Graph.registry.Link"},Graph.registry.link=new r}(),function(){var t={},e={},r=function(){};r.prototype.constructor=r,r.prototype.register=function(e){var r=e.guid();t[r]=e},r.prototype.setContext=function(r,n){t[r]&&(e[r]=n)},r.prototype.collect=function(r){var n=[];for(var i in e)e[i]==r&&t[i]&&n.push(t[i]);return n},r.prototype.unregister=function(r){var n=r.guid();t[n]&&(t[n]=null,delete t[n]),e[n]&&delete e[n]},r.prototype.size=function(){return _.keys(t).length},r.prototype.toArray=function(){var e=_.keys(t);return _.map(e,function(e){return t[e]})},r.prototype.get=function(e){return _.isUndefined(e)?this.toArray():(e instanceof SVGElement?("tspan"==e.tagName&&(e=e.parentNode),e=Graph.$(e).data(Graph.string.ID_SHAPE)):e instanceof Graph.dom.Element?e=e.data(Graph.string.ID_SHAPE):e instanceof Graph.svg.Vector&&(e=e.elem.data(Graph.string.ID_SHAPE)),t[e])},r.prototype.toString=function(){return"Graph.registry.Shape"},Graph.registry.shape=new r}(),function(){var t={},e=function(){};e.prototype.constructor=e,e.prototype.register=function(e){var r=e.guid();t[r]=e},e.prototype.unregister=function(e){var r=e.guid();t[r]&&delete t[r]},e.prototype.get=function(e){return void 0===e?this.toArray():t[e]},e.prototype.toArray=function(){var e=_.keys(t);return _.map(e,function(e){return t[e]})},e.prototype.toString=function(){return"Graph.registry.Pallet"},Graph.registry.pallet=new e}(),function(){Graph.layout.Layout=Graph.extend({props:{fit:!0,view:null,width:0,height:0,router:{type:"orthogonal"},link:{smooth:!1,smoothness:6}},view:null,cached:{offset:null,position:null},constructor:function(t,e){_.assign(this.props,e||{}),this.props.view=t.guid()},view:function(){return Graph.registry.vector.get(this.props.view)},paper:function(){return this.view().paper()},offset:function(){return this.position()},position:function(){var t,e,r=this.cached.position;return r||(t=this.view(),e=t.isViewport()?t.parent().node():t.node(),r=e.getBoundingClientRect(),this.cached.position=r),r},center:function(){var t=this.cached.center;if(!t){var e=this.position();t={x:e.width/2,y:e.height/2},this.cached.center=_.extend({},t)}return t},scale:function(){return this.view().matrix().scale()},width:function(){var t,e,r;return t=this.view(),t.isViewport()?r=this.paper().width():(e=t.bbox(),r=e.width()),t=e=null,r},height:function(){var t,e,r;return t=this.view(),t.isViewport()?r=this.paper().height():(e=t.bbox(),r=e.height()),t=e=null,r},invalidate:function(){this.cached.offset=null,
this.cached.center=null,this.cached.position=null},grabVector:function(t){var e=Graph.event.target(t);return Graph.registry.vector.get(e)},grabLink:function(t){var e=Graph.event.target(t);return Graph.registry.link.get(e)},pointerLocation:function(t){var e=t.clientX,r=t.clientY,n=this.position(),i=this.view().matrix(),o=i.clone().invert(),s=i.scale(),a={x:o.x(e,r),y:o.y(e,r)};return a.x-=n.left/s.x,a.y-=n.top/s.y,i=o=null,a},screenLocation:function(t){var e=this.view().node().getScreenCTM();matrix=Graph.matrix(e.a,e.b,e.c,e.d,e.e,e.f);var r=matrix.x(t.x,t.y),n=matrix.y(t.x,t.y);return t.x=r,t.y=n,t},dragSnapping:function(){return{mode:"anchor",x:1,y:1}},routerType:function(){return this.props.router.type},createRouter:function(t,e,r){var n;return n=Graph.router[_.capitalize(this.props.router.type)],r=_.extend({},this.props.router,r||{}),Graph.factory(n,[this.view(),t,e,r])},createLink:function(t,e){var r;return r=Graph.link[_.capitalize(this.props.router.type)],e=_.extend({},this.props.link,e||{}),Graph.factory(r,[t,e])},refresh:function(t){this.fire("refresh")},arrangeLinks:function(){var t=this.view().paper().guid(),e=Graph.registry.link.collect(t);if(e.length){var r=[];_.forEach(e,function(t){t.cached.convex&&r.push(t.guid())});var n,i,o,s=new Graph.util.Sweeplink(e),a=s.findConvex();for(n in a)i=Graph.registry.link.get(n),i.reloadConvex(a[n]),i.reset(!0),(o=_.indexOf(r,n))>-1&&r.splice(o,1);r.length&&_.forEach(r,function(t){var e=Graph.registry.link.get(t);e.removeConvex(),e.reset(!0)}),s.destroy(),s=null}},arrangeShapes:function(){},toString:function(){return"Graph.layout.Layout"}})}(),function(){var t=Graph.router.Router=Graph.extend({props:{type:"directed",domain:null,source:null,target:null},values:{start:null,end:null,waypoints:null},cached:{path:null,command:null,segments:null,bendpoints:null,bending:null,connect:null},constructor:function(t,e,r,n){_.assign(this.props,n||{}),this.props.domain=t.guid(),this.props.source=e.guid(),this.props.target=r.guid(),this.values.waypoints=[]},type:function(){return this.props.type},invalidate:function(){this.cached.path=null,this.cached.command=null,this.cached.segments=null,this.cached.bendpoints=null},domain:function(){return Graph.registry.vector.get(this.props.domain)},source:function(t){return void 0===t?Graph.registry.vector.get(this.props.source):(this.props.source=t.guid(),this)},target:function(t){return void 0===t?Graph.registry.vector.get(this.props.target):(this.props.target=t.guid(),this)},layout:function(){return this.domain().layout()},tail:function(){var t=_.first(this.values.waypoints);return t?_.extend({},t):null},head:function(){var t=_.last(this.values.waypoints);return t?_.extend({},t):null},center:function(){var t=this.path(),e=t.pointAt(t.length()/2,!0);return t=null,e},execute:function(t){this.command(t),this.fire("route",{command:this.command()})},command:function(t){var e,r;return void 0===t?(t=this.cached.command,t||(e=this.segments(),t=Graph.util.segments2path(e),
this.cached.command=t),t):(e=Graph.util.path2segments(t),r=_.map(e,function(t){return{x:t[1],y:t[2]}}),this.values.waypoints=r,this.invalidate(),e=r=null,this)},segments:function(){var t=this.cached.segments;return t||(t=[],_.forEach(this.values.waypoints,function(e,r){var n=0===r?"M":"L";t.push([n,e.x,e.y])}),this.cached.segments=t),t},waypoints:function(){return this.values.waypoints},bendpoints:function(){var t=this.cached.bendpoints;return t||(t=(this.values.waypoints||[]).slice(),this.cached.bendpoints=t),t},path:function(){var t=this.cached.path;return t||(t=Graph.path(this.command()),this.cached.path=t),t},modify:function(t,e,r){return this.values.waypoints[t].x=e,this.values.waypoints[t].y=r,this},commit:function(){return this.invalidate(),this},route:function(){return this},repair:function(t,e){},reset:function(){this.invalidate(),this.values.waypoints=null},relocate:function(t,e){return _.forEach(this.values.waypoints,function(r){r.x+=t,r.y+=e}),this.commit(),this},initTrans:function(t){},updateTrans:function(t){},bending:function(){},connecting:function(){},stopTrans:function(t){},destroy:function(){this.reset()}});t.portCentering=function(t,e,r){return"x"==r&&(t.y=e.y),"y"==r&&(t.x=e.x),t},t.porting=function(e,r,n){var i,o,s=n?0:e.length-1,a=Graph.path(Graph.util.points2path(e)),p=r.intersection(a,!0);return i=e[s],p.length&&(p=t.sortIntersection(p),o=n?p[0]:p[p.length-1]),{index:s,point:i,port:o||i}},t.isRepairable=function(t){var e=t.length;return!(e<3)&&(e>4||!_.find(t,function(e,r){var n=t[r-1];return n&&Graph.util.pointDistance(e,n)<=5}))},t.getSegmentIndex=function(t,e){var r=0;return _.forEach(t,function(n,i){if(Graph.util.isPointOnLine(n,t[i+1],e))return r=i,!1}),r},t.sortIntersection=function(t){return _.sortBy(t,function(t){var e=Math.floor(100*t.t2)||1;return e=100-e,e=(e<10?"0":"")+e,t.segment2+"#"+e})},t.getClosestIntersect=function(e,r,n){var i,o=Graph.path(Graph.util.points2path(e)),s=r.intersection(o,!0),a=1/0;return s.length&&(s=t.sortIntersection(s),_.forEach(s,function(t){var e=Graph.util.taxicab(t,n);e<=a&&(a=e,i=t)})),i},t.repairBendpoint=function(t,e,r){switch(Graph.util.pointAlign(e,t)){case"v":return{x:t.x,y:r.y};case"h":return{x:r.x,y:t.y}}return{x:t.x,y:t.y}},t.repairRoutes=function(e,r,n,i){var o=i[0],s=i.slice();return s[0]=n,s[1]=t.repairBendpoint(s[1],o,n),s},t.tidyRoutes=function(t){return _.filter(t,function(e,r){return!Graph.util.isPointOnLine(t[r-1],t[r+1],e)})}}(),function(){var t=Graph.router.Router;Graph.router.Directed=Graph.extend(t,{bendpoints:function(){var t=this.cached.bendpoints;if(!t){var e,r,n,i,o,s,a=this.path().curve().segments;t=[];for(var p=0,h=a.length;p<h;p++)e=a[p],0===p?(o=e[1],s=e[2],r=Graph.curve([["M",o,s],["C",o,s,o,s,o,s]]),i=r.pointAt(r.t(0),!0),i.index=p,i.range=[0,0],i.space=0,t.push(i)):(r=Graph.curve([["M",o,s],e]),o=e[5],s=e[6],n=r.length(),i=r.pointAt(r.t(n/2),!0),i.index=p,i.range=[p-1,p],i.space=0,t.push(i),i=r.pointAt(r.t(n),!0),i.index=p,i.range=[p-1,p+1],i.space=1,
t.push(i));this.cached.bendpoints=t}return t},route:function(t,e){var r=this.source(),n=r.connectable(),i=r.bboxOriginal(),o=i.toJson(),s=this.target(),a=s.connectable(),p=s.bboxOriginal(),h=p.toJson(),c=n.orientation(a),l=n.direction(a),u=!1,d=[];t||(t=i.center(!0)),e||(e=p.center(!0));var f,g;if(l){if("h:h"==l){switch(c){case"top-right":case"right":case"bottom-right":f={x:o.x,y:t.y},g={x:h.x+h.width,y:e.y};break;case"top-left":case"left":case"bottom-left":f={x:o.x+o.width,y:t.y},g={x:h.x,y:e.y}}u=!0}if("v:v"==l){switch(c){case"top-left":case"top":case"top-right":f={x:t.x,y:o.y+o.height},g={x:e.x,y:h.y};break;case"bottom-left":case"bottom":case"bottom-right":f={x:t.x,y:o.y},g={x:e.x,y:h.y+h.height}}u=!0}}d=u?[f,g]:[t,e];var y,v=Graph.path(Graph.util.points2path(d));return y=r.shapeView().intersection(v,!0),y.length&&(d[0]=y[0]),y=s.shapeView().intersection(v,!0),y.length&&(d[1]=y[y.length-1]),this.values.waypoints=d,this.commit(),this.fire("route",{command:this.command()}),this},repair:function(e,r){var n=this.source(),i=n.bboxOriginal(),o=this.target(),s=o.bboxOriginal(),a=this.values.waypoints,p=a.length-1;e===n?a[0]=r:e===o&&(a[p]=r);var h;h=t.getClosestIntersect(a,n.shapeView(),s.center(!0)),h&&(a[0]=h),h=t.getClosestIntersect(a,o.shapeView(),i.center(!0)),h&&(a[p]=h),this.commit(),this.fire("route",{command:this.command()})},initTrans:function(t){var e=this.source(),r=this.target(),n=e.shapeView(),i=r.shapeView(),o=this.waypoints(),s=t.range.start,a=t.range.end,p=o[s],h=o[a],c=[];"BENDING"==t.trans&&(c=[o[s],o[a]]);var l=this.layout().position();t.snap.hor=[],t.snap.ver=[],_.forEach(c,function(e){e&&(t.snap.hor.push(e.y+l.top),t.snap.ver.push(e.x+l.left))}),"BENDING"==t.trans?this.cached.bending={source:e,target:r,rangeStart:s,rangeEnd:s,segmentStart:p,segmentEnd:h,original:o.slice(),sourcePath:n,targetPath:i}:this.cached.connect={valid:!1,source:null,target:null,sourcePath:null,targetPath:null,original:o.slice()}},updateTrans:function(t,e){if("CONNECT"==t){var r=this.cached.connect,n=r.source,i=r.target;_.assign(r,e),n&&r.source?n.guid()!=r.source.guid()&&(r.sourcePath=r.source.shapeView()):!n&&r.source&&(r.sourcePath=r.source.shapeView()),i&&r.target?i.guid()!=r.target.guid()&&(r.targetPath=r.target.shapeView()):!i&&r.target&&(r.targetPath=r.target.shapeView())}},bending:function(t,e){var r=this.cached.bending,n=r.original.slice(),i=r.rangeStart,o=(r.rangeEnd,r.segmentStart),s=r.segmentEnd,a={x:t.point.x+t.delta.x,y:t.point.y+t.delta.y},p=Graph.util.pointAlign(o,a,10),h=Graph.util.pointAlign(s,a,10);"h"==p&&"v"==h?(a.x=o.x,a.y=s.y):"v"==p&&"h"==h?(a.y=o.y,a.x=s.x):"h"==p?a.x=o.x:"v"==p?a.y=o.y:"h"==h?a.x=s.x:"v"==h&&(a.y=s.y),t.event.x=a.x,t.event.y=a.y,n.splice(i+1,t.space,a),r.routes=n,this.cropBinding(t,e)},cropBinding:_.debounce(function(e,r){var n,i=this.cached.bending,o=i.routes,s=t.porting(o,i.sourcePath,!0),a=t.porting(o,i.targetPath),p=o.slice(s.index+1,a.index);p.unshift(s.port),p.push(a.port),i.waypoints=p,
r&&(n=Graph.util.points2path(p),r({command:n}))},0),connecting:function(t,e){var r,n=this.cached.connect,i=n.original.slice();r={x:t.point.x+t.delta.x,y:t.point.y+t.delta.y},i[t.index]=r,t.event.x=r.x,t.event.y=r.y,n.routes=i,this.cropConnect(t,e)},cropConnect:_.debounce(function(t,e){var r,n,i,o,s=this.cached.connect,a=s.routes;0===t.index?s.source&&(n=s.sourcePath):s.target&&(n=s.targetPath),n&&(i=Graph.path(Graph.util.points2path(a)),o=n.intersection(i,!0),o.length&&(a[t.index]=o[0])),s.waypoints=a,e&&(r=Graph.util.points2path(a),e({command:r}))},0),stopTrans:function(e){var r,n,i,o;"CONNECT"==e.trans?(r=this.cached.connect,i=r.waypoints,this.cached.connect.valid?(o=!0,this.source(r.source),this.target(r.target),this.fire("reroute",{source:r.source,target:r.target})):(i=r.original.slice(),o=!1)):"BENDING"==e.trans&&(n=this.cached.bending,i=n.waypoints,o=!0),this.values.waypoints=o?t.tidyRoutes(i):i,this.commit(),this.cached.connect=null,this.cached.bending=null},toString:function(){return"Graph.router.Directed"}})}(),function(){var t=Graph.router.Router;Graph.router.Orthogonal=Graph.extend(t,{bendpoints:function(){var t=this.cached.bendpoints;if(!t){var e,r,n,i,o,s,a=this.path().curve().segments,p=a.length-1;t=[];for(var h=0,c=a.length;h<c;h++)e=a[h],0===h?(o=e[1],s=e[2],r=Graph.curve([["M",o,s],["C",o,s,o,s,o,s]]),i=r.pointAt(r.t(0),!0),i.index=h,i.range=[h,h+1],i.space=0,t.push(i)):(r=Graph.curve([["M",o,s],e]),o=e[5],s=e[6],n=r.length(),i=r.pointAt(r.t(n/2),!0),i.index=h,i.range=[h-1,h],i.space=0,t.push(i),h===p&&(i=r.pointAt(r.t(n),!0),i.index=h,i.range=[h-1,h],i.space=0,t.push(i)));this.cached.bendpoints=t}return t},route:function(e,r){var n=this.source(),i=this.target(),o=n.connectable(),s=i.connectable(),a=n.bboxOriginal(),p=a.toJson(),h=i.bboxOriginal(),c=h.toJson(),l=o.orientation(s),u=o.direction(s),d=!1;e||(e=a.center(!0)),r||(r=h.center(!0)),this.values.start||this.values.end||(this.values.start=e,this.values.end=r);var f,g;if(u){if("h:h"==u)switch(l){case"top-right":case"right":case"bottom-right":f={x:p.x+1,y:e.y},g={x:c.x+c.width-1,y:r.y},d=!0;break;case"top-left":case"left":case"bottom-left":f={x:p.x+p.width-1,y:e.y},g={x:c.x+1,y:r.y},d=!0}if("v:v"==u)switch(l){case"top-left":case"top":case"top-right":f={x:e.x,y:p.y+p.height-1},g={x:r.x,y:c.y+1},d=!0;break;case"bottom-left":case"bottom":case"bottom-right":f={x:e.x,y:p.y+1},g={x:r.x,y:c.y+c.height-1},d=!0;break;case"left":case"right":f={x:e.x,y:p.y+1},g={x:r.x,y:c.y+1}}}var y,v,m,x,b,G;if(d)x=n.shapeView(),b=Graph.path(Graph.util.points2path([f,g])),G=x.intersection(b,!0),G.length&&(G=G[0],Graph.util.isPointEquals(G,f)||(f=G)),x=i.shapeView(),G=x.intersection(b,!0),G.length&&(G=G[G.length-1],Graph.util.isPointEquals(G,g)||(g=G)),m=Graph.util.lineBendpoints(f,g,u),v=[f].concat(m).concat([g]),this.values.waypoints=t.tidyRoutes(v);else if(f&&g){switch(l){case"left":case"right":y=Graph.util.expandBox(Graph.util.groupBox([p,c]),0,20),m=[{x:f.x,y:y.y},{x:g.x,y:y.y}]}
b=Graph.path(Graph.util.points2path([f].concat(m).concat([g]))),v=[f].concat(m).concat([g]),this.values.waypoints=t.tidyRoutes(v)}else f=e,g=r,m=Graph.util.lineBendpoints(f,g,u),b=Graph.path(Graph.util.points2path([f].concat(m).concat([g]))),x=n.shapeView(),G=x.intersection(b,!0),G.length&&(f=G[0]),x=i.shapeView(),G=x.intersection(b,!0),G.length&&(g=G[G.length-1]),v=[f].concat(m).concat([g]),this.values.waypoints=t.tidyRoutes(v);return this.commit(),this.fire("route",{command:this.command()}),this},repair:function(e,r){var n=this.values.waypoints.slice();if(!t.isRepairable(n))return this.route();var i,o,s,a,p,h,c=this.target(),l=c.bboxOriginal(),u=this.source(),d=u.bboxOriginal();e===u?(i=d.toJson(),o=l.toJson(),s=d.center(!0),a=n):(i=l.toJson(),o=d.toJson(),s=l.center(!0),a=n.slice(),a.reverse()),p="h"==Graph.util.pointAlign(a[0],a[1])?"x":"y",t.portCentering(r,s,p),h=t.repairRoutes(i,o,r,a);var f,g,y,v;if(h){if(e===c&&h.reverse(),f=h.slice(),g=t.getClosestIntersect(h,u.shapeView(),l.center(!0)),g&&(y=t.getSegmentIndex(h,g),f=f.slice(y+1),f.unshift(g)),(g=t.getClosestIntersect(f,c.shapeView(),d.center(!0)))&&(v=t.getSegmentIndex(f,g),f=f.slice(0,v+1),f.push(g),2===f.length)){var m=Graph.util.pointAlign(f[0],f[1]);"h"==m?f[1].x=f[0].x:"v"==m&&(f[1].y=f[0].y)}return this.values.waypoints=f,this.commit(),this.fire("route",{command:this.command()}),this}return this.route()},initTrans:function(e){var r=this.waypoints(),n=this.source(),i=this.target(),o=e.ranges.start,s=e.ranges.end,a=n.bboxView(),p=i.bboxView(),h=r[o],c=r[s],l=[];"BENDING"==e.trans&&(0===o&&t.portCentering(h,a.center(!0),e.axis),s===r.length-1&&t.portCentering(c,p.center(!0),e.axis),l=[r[o-1],h,c,r[s+1]],o<2&&l.unshift(a.center(!0)),s>r.length-3&&l.unshift(p.center(!0)));var u=this.layout().position(),d=[],f=[];if(e.snap.hor=[],e.snap.ver=[],_.forEach(l,function(t){t&&("y"==e.axis&&(d.push(t.y),e.snap.hor.push(t.y+u.top)),"x"==e.axis&&(f.push(t.x),e.snap.ver.push(t.x+u.left)))}),this.cached.connect=null,this.cached.bending=null,"BENDING"==e.trans)this.cached.bending={source:n,target:i,original:r,rangeStart:o,rangeEnd:s,segmentStart:h,segmentEnd:c,sourceBound:a.toJson(),targetBound:p.toJson(),sourcePath:n.shapeView(),targetPath:i.shapeView(),snapH:d,snapV:f};else{var g=r.slice(),y=Graph.util.pointAlign(h,c,10);if(2===g.length){var v,m;v={x:(h.x+c.x)/2,y:(h.y+c.y)/2},m={x:v.x,y:v.y},g.splice(1,0,v,m),0!==e.index?(o+=2,s+=2,h=g[o],c=g[s],e.index+=2,e.point=_.extend({},c),e.event=_.extend({},c)):c=g[s]}this.cached.connect={valid:!1,source:null,target:null,sourcePath:null,targetPath:null,rangeStart:o,rangeEnd:s,segmentStart:h,segmentEnd:c,segmentAlign:y,original:g}}},updateTrans:function(t,e){if("CONNECT"==t){var r=this.cached.connect,n=r.source,i=r.target;_.assign(r,e),n&&r.source?n.guid()!=r.source.guid()&&(r.sourcePath=r.source.shapeView()):!n&&r.source&&(r.sourcePath=r.source.shapeView()),
i&&r.target?i.guid()!=r.target.guid()&&(r.targetPath=r.target.shapeView()):!i&&r.target&&(r.targetPath=r.target.shapeView())}},bending:function(t,e){var r,n,i=this.cached.bending,o=i.original.slice(),s=i.segmentStart,a=i.segmentEnd,p=i.rangeStart,h=i.rangeEnd;r={x:s.x+t.delta.x,y:s.y+t.delta.y},n={x:a.x+t.delta.x,y:a.y+t.delta.y},"x"==t.axis&&(t.event.x=(r.x+n.x)/2),"y"==t.axis&&(t.event.y=(r.y+n.y)/2);var c=Graph.util.snapValue(t.event.x,i.snapV),l=Graph.util.snapValue(t.event.y,i.snapH);t.event.x=c,t.event.y=l,"x"==t.axis&&(r.x=c,n.x=c),"y"==t.axis&&(r.y=l,n.y=l),o[p]=r,o[h]=n;var u,d,f=o.length,g=0;p<2&&(u=Graph.util.boxOrientation(i.sourceBound,Graph.util.pointbox(r)),1===p?"intersect"==u&&(o.shift(),o[0]=r,g--):"intersect"!=u&&(o.unshift(s),g++)),h>f-3&&(d=Graph.util.boxOrientation(i.targetBound,Graph.util.pointbox(n)),h===f-2?"intersect"==d&&(o.pop(),o[o.length-1]=n):"intersect"!=d&&o.push(a)),i.routes=o,i.newRangeStart=p+g,this.cropBending(e)},cropBending:_.debounce(function(e){var r,n=this.cached.bending,i=n.routes,o=t.porting(i,n.sourcePath,!0),s=t.porting(i,n.targetPath),a=i.slice(o.index+1,s.index);a.unshift(o.port),a.push(s.port),n.waypoints=a,e&&(r=Graph.util.points2path(a),e({command:r}))},0),connecting:function(t,e){var r,n=this.cached.connect,i=n.original.slice(),o=n.segmentAlign,s=n.segmentStart,a=n.segmentEnd,p=n.rangeStart,h=n.rangeEnd;r={x:t.point.x+t.delta.x,y:t.point.y+t.delta.y};var c,l;0===t.index?(c={x:t.point.x+t.delta.x,y:t.point.y+t.delta.y},l="v"==o?{x:a.x,y:c.y}:{x:c.x,y:a.y}):(l={x:t.point.x+t.delta.x,y:t.point.y+t.delta.y},c="h"==o?{x:l.x,y:s.y}:{x:s.x,y:l.y}),i[p]=c,i[h]=l,t.event.x=r.x,t.event.y=r.y,n.routes=i,this.cropConnect(t,e)},cropConnect:_.debounce(function(t,e){var r=this.cached.connect,n=r.routes;if(r.valid){var i,o,s,a;0===t.index?r.source&&(o=r.sourcePath):r.target&&(o=r.targetPath),o&&(s=Graph.path(Graph.util.points2path(n)),a=o.intersection(s,!0),a.length&&(n[t.index]=a[0]))}r.waypoints=n,e&&(i=Graph.util.points2path(n),e({command:i}))},0),stopTrans:function(e){var r,n,i,o;"CONNECT"==e.trans?(r=this.cached.connect,i=r.waypoints,this.cached.connect.valid?(o=!0,this.source(r.source),this.target(r.target),this.fire("reroute",{source:r.source,target:r.target})):(i=r.original.slice(),o=!1)):"BENDING"==e.trans&&(n=this.cached.bending,i=n.waypoints,o=!0),this.values.waypoints=o?t.tidyRoutes(i):i,this.commit()},toString:function(){return"Graph.router.Orthogonal"}})}(),function(){function t(t,e,r){var n="on"+_.capitalize(e)+r,i=t[n];return n=null,i}var e=Graph.link.Link=Graph.extend({props:{id:null,name:null,guid:null,type:"normal",rendered:!1,selected:!1,label:"",labelDistance:.5,source:null,target:null,connected:!1,removed:!1,command:null,stroke:"#000",convex:1,smooth:0,smoothness:6,dataSource:null},params:[],components:{block:null,coat:null,path:null,label:null,editor:null},cached:{bendpoints:null,controls:null,convex:null},handlers:{source:null,target:null},router:null,metadata:{
icon:Graph.icons.SHAPE_LINK},constructor:function(t,r){var n;this.data(r||{}),n="graph-link-"+ ++e.guid,this.props.guid=n,this.router=t,this.initComponent(),this.initMetadata(),this.bindResource("source",t.source()),this.bindResource("target",t.target()),this.router.on("route",_.bind(this.onRouterRoute,this)),this.router.on("reroute",_.bind(this.onRouterReroute,this)),Graph.registry.link.register(this)},data:function(t,e){if(void 0===t&&void 0===e)return this.props;var r,n,i={type:!0,router_type:!0,client_id:!0,client_source:!0,client_target:!0,diagram_id:!0,source_id:!0,target_id:!0},o={label_distance:"labelDistance",data_source:"dataSource"};if(_.isPlainObject(t)){for(var r in t)i[r]||(n=o[r]||r,"params"==r?this.params=t[r]:this.props[n]=t[r]);return this}return void 0===e?this.props[t]:(i[t]||(n=o[t]||t,"params"==t?this.params=e:this.props[n]=e),this)},initComponent:function(){var t,e,r,n,i,o=this.components;t=(new Graph.svg.Group).addClass("graph-link").selectable(!1),t.elem.data(Graph.string.ID_LINK,this.props.guid),t.addClass("link-"+this.props.type),e=(new Graph.svg.Path).addClass("graph-link-coat").render(t),e.data("text",this.props.label),e.elem.data(Graph.string.ID_LINK,this.props.guid),e.draggable({ghost:!0,manual:!0,batchSync:!1}),e.editable({width:150,height:80,offset:"pointer"}),e.on("pointerdown.link",_.bind(this.onCoatClick,this)),e.on("select.link",_.bind(this.onCoatSelect,this)),e.on("deselect.link",_.bind(this.onCoatDeselect,this)),e.on("beforedrag.link",_.bind(this.onCoatBeforeDrag,this)),e.on("afterdrag.link",_.bind(this.onCoatAfterDrag,this)),e.on("edit.link",_.bind(this.onCoatEdit,this)),e.on("beforeedit.link",_.bind(this.onCoatBeforeEdit,this)),e.on("afterdestroy.link",_.bind(this.onCoatAfterDestroy,this)),r=(new Graph.svg.Path).addClass("graph-link-path").selectable(!1).clickable(!1).attr("marker-end","url(#marker-link-end)").attr("stroke",this.props.stroke||"#000000").render(t),"message"==this.props.type&&r.attr("marker-start","url(#marker-link-start-circle)"),r.elem.data(Graph.string.ID_LINK,this.props.guid),i=new Graph.svg.Text(0,0,"").addClass("graph-link-label").selectable(!1).render(t),i.draggable({ghost:!0}),i.on("render.link",_.bind(this.onLabelRender,this)),i.on("afterdrag.link",_.bind(this.onLabelAfterDrag,this)),i.interactable().vendor().on("doubletap",_.bind(this.onLabelDoubletap,this)),n=(new Graph.svg.Group).selectable(!1).render(t),o.block=t.guid(),o.coat=e.guid(),o.path=r.guid(),o.label=i.guid(),o.editor=n.guid()},initMetadata:function(){this.metadata.tools=[{name:"config",icon:Graph.icons.CONFIG,title:Graph._("Click to config link"),enabled:!0,handler:_.bind(this.onConfigToolClick,this)},{name:"sendtofront",icon:Graph.icons.SEND_TO_FRONT,title:Graph._("Send to front"),enabled:!0,handler:_.bind(this.onFrontToolClick,this)},{name:"sendtoback",icon:Graph.icons.SEND_TO_BACK,title:Graph._("Send to back"),enabled:!0,handler:_.bind(this.onBackToolClick,this)},{name:"trash",icon:Graph.icons.TRASH,
title:Graph._("Click to remove link"),enabled:!0,handler:_.bind(this.onTrashToolClick,this)}]},unbindResource:function(t){var e=this.props[t],r=this.handlers[t];if(e){var n=Graph.registry.vector.get(e);if(n&&r){var i,o;for(i in r)o=i+".link",n.off(o,r[i]),o=null}}return r=null,this},bindResource:function(e,r){var n=(this.router,this.handlers[e]);return this.unbindResource(e,r),n={},n.afterresize=_.bind(t(this,e,"AfterResize"),this),n.select=_.bind(t(this,e,"Select"),this),n.afterrotate=_.bind(t(this,e,"AfterRotate"),this),n.beforedrag=_.bind(t(this,e,"BeforeDrag"),this,_,r),n.drag=_.bind(t(this,e,"Drag"),this),n.afterdrag=_.bind(t(this,e,"AfterDrag"),this),n.beforedestroy=_.bind(t(this,e,"BeforeDestroy"),this),this.handlers[e]=n,this.props[e]=r.guid(),r.on("afterresize.link",n.afterresize),r.on("afterrotate.link",n.afterrotate),r.on("beforedestroy.link",n.beforedestroy),r.on("select.link",n.select),r.isDraggable()&&(r.on("beforedrag.link",n.beforedrag),r.draggable().ghost()?r.on("afterdrag.link",n.afterdrag):r.on("drag.link",n.drag)),this},bindSource:function(t){return this.bindResource("source",t)},bindTarget:function(t){return this.bindResource("target",t)},unbindSource:function(t){return this.unbindResource("source")},unbindTarget:function(t){return this.unbindResource("target")},component:function(t){return void 0===t?Graph.registry.vector.get(this.components.block):Graph.registry.vector.get(this.components[t])},invalidate:function(t){void 0!==t?this.cached[t]=null:this.cached.bendpoints=null},render:function(t){var e;this.component().render(t),(e=t.paper())&&Graph.registry.link.setContext(this.guid(),e.guid())},id:function(){return this.props.id},guid:function(){return this.props.guid},type:function(t){if(void 0===t)return this.props.type;this.props.type=t;var e=this.component();"message"==t?this.component("path").attr("marker-start","url(#marker-link-start-circle)"):this.component("path").attr("marker-start",""),e.removeClass("link-normal link-message"),e.addClass("link-"+t)},connect:function(t,e){this.props.connected||(this.router.route(t,e),this.props.connected=!0)},connectByCommand:function(t){this.props.connected||(this.router.execute(t),this.props.connected=!0)},disconnect:function(t){this.props.connected&&(t=_.defaultTo(t,!0),this.props.connected=!1,t&&(this.router.reset(),this.reload(this.router.command())))},redraw:function(t){},reload:function(t,e){e=_.defaultTo(e,!1),t=t||"",this.component("coat").attr("d",t).dirty(!0),this.component("path").attr("d",t),this.invalidate(),e||(this.refresh(),this.fire("change"),Graph.topic.publish("link:change"))},reloadConvex:function(t){this.cached.convex=t},removeConvex:function(){this.cached.convex=null},reset:function(t){var e=this.router.command();this.reload(e,t)},refresh:function(){if(this.props.label){var t=this.component("label");if(t.props.rendered){var e=this.router.path();if(e.segments.length){
var r=t.bbox().toJson(),n=this.props.labelDistance||.5,i=this.router.layout().scale(),e=this.router.path(),o=e.pointAt(n*e.length(),!0);"h"==Graph.util.pointAlign(o.start,o.end,10)?o.x+=r.width/2+10/i.x:o.y-=r.height-5/i.y,t.attr({x:o.x,y:o.y}),t.arrange(),e=null,o=null,t.dirty(!0)}else t.hide()}}},label:function(t){if(void 0===t)return this.props.label;this.props.label=t;var e=this.component("label"),r=this.component("coat");return e.write(t),e.arrange(),r.data("text",t),e.props.rendered&&this.refresh(),this},stroke:function(t){return t=t||"#000",this.props.stroke=t,this.component("path").attr("stroke",t),this},select:function(t){var e=this.router.source().paper();t=_.defaultTo(t,!1),t&&e&&e.collector().clearCollection(),this.component("coat").select()},deselect:function(){this.component("coat").deselect()},renderControl:function(){},resumeControl:function(){var t=this,e=t.component("editor");t.cached.bendpoints||(t.cached.bendpoints=t.router.bendpoints(),t.renderControl()),e.elem.appendTo(this.component("block").elem)},suspendControl:function(){this.component("editor").elem.detach()},sendToFront:function(){var t=this.component().parent();this.component().elem.appendTo(t.elem)},relocate:function(t,e){this.router.relocate(t,e),this.reload(this.router.command())},relocateHead:function(t,e){var r=this.router.head();r&&(r.x+=t,r.y+=e,this.router.repair(this.router.target(),r))},relocateTail:function(t,e){var r=this.router.tail();r&&(r.x+=t,r.y+=e,this.router.repair(this.router.source(),r))},remove:function(){var t,e=this;if(!this.props.removed){this.props.removed=!0,this.disconnect(!1),this.unbindSource(),this.unbindTarget(),this.fire("beforedestroy",{link:this}),e.component("label").remove(),e.cached.controls&&(_.forEach(e.cached.controls,function(t){var e=Graph.registry.vector.get(t);e&&e.remove()}),e.cached.controls=null),e.component("editor").remove(),e.component("path").remove(),e.component("block").remove();for(t in e.components)e.components[t]=null;for(t in e.cached)e.cached[t]=null;e.router.destroy(),e.router=null,e.fire("afterdestroy"),Graph.registry.link.unregister(e),Graph.topic.publish("link:afterdestroy")}},isSelected:function(){return this.props.selected},isConnected:function(){return this.props.connected},toString:function(){return"Graph.link.Link"},toJson:function(){var t=this.router.source(),e=this.router.target(),r=Graph.registry.shape.get(t),n=Graph.registry.shape.get(e);return{metadata:{},props:{id:this.props.id,name:this.props.name,guid:this.guid(),type:this.toString(),routerType:this.router.type(),command:this.router.command(),label:this.props.label,labelDistance:this.props.labelDistance,source:r?r.guid():t.guid(),sourceType:r?"shape":"vector",target:n?n.guid():e.guid(),targetType:n?"shape":"vector",convex:+this.props.convex?1:0,smooth:+this.props.smooth?1:0,smoothness:this.props.smoothness,stroke:this.props.stroke,dataSource:this.props.dataSource},params:this.params}},onRouterRoute:function(t){var e=t.command;this.reload(e)},
onRouterReroute:function(t){var e=t.source,r=t.target;this.bindResource("source",e),this.bindResource("target",r),this.sendToFront()},onLabelRender:function(t){this.props.label&&this.label(this.props.label)},onLabelAfterDrag:function(t){var e=this.component("label"),r=e.matrix(),n=e.attrs.x,i=e.attrs.y,o={x:r.x(n,i),y:r.y(n,i)};e.attr({x:o.x,y:o.y}),e.arrange();var s=this.router.path(),a=s.nearest(o);this.props.labelDistance=a.distance/s.length(),e.reset(),r=s=null},onLabelDoubletap:function(t){this.component("coat").editable().startEdit(t)},onCoatBeforeEdit:function(t){this.component("label").hide(),this.component().addClass("editing")},onCoatEdit:function(t){this.component().removeClass("editing"),this.component("label").show(),this.label(t.text,t.left,t.top)},onCoatClick:function(t){var e=this.component("coat").paper();"linking"==e.state()&&e.tool().activate("panzoom")},onCoatSelect:function(t){var e=(this.component("coat"),!1);t.initial&&(e=!0),this.props.selected=!0,this.component().addClass("selected"),e&&(this.resumeControl(),Graph.topic.publish("link:select",{link:this}))},onCoatDeselect:function(t){this.props.removed||(this.props.selected=!1,this.component().removeClass("selected"),this.suspendControl(),t.initial&&Graph.topic.publish("link:deselect",{link:this}))},onCoatBeforeDrag:function(t){this.suspendControl()},onCoatAfterDrag:function(t){this.relocate(t.dx,t.dy)},onCoatAfterDestroy:function(t){this.remove()},onSourceAfterRotate:function(t){var e=this.router.source().matrix(),r=this.router.tail(),n={x:e.x(r.x,r.y),y:e.y(r.x,r.y)},i=n.x-r.x,o=n.y-r.y;this.relocateTail(i,o)},onSourceSelect:function(t){var e=this.router.target();this.isSelected()?e.isSelected()||this.deselect():e.isSelected()&&this.select()},onSourceBeforeDrag:function(t,e){var r=this.router.target();e.isSelected()&&r.isSelected()||this.deselect(),this.cached.convex=null},onSourceDrag:function(t){console.warn("Not yet implemented")},onSourceAfterDrag:function(t){var e=this.router.source(),r=this.router.target(),n=t.tx,i=t.ty;e.isSelected()?r.isSelected()||this.relocateTail(n,i):this.relocateTail(n,i)},onSourceAfterResize:function(t){this.relocateTail(t.translate.dx,t.translate.dy)},onSourceBeforeDestroy:function(){this.props.removed||this.component("coat").remove()},onTargetAfterRotate:function(t){var e=this.router.target().matrix(),r=this.router.head(),n={x:e.x(r.x,r.y),y:e.y(r.x,r.y)},i=n.x-r.x,o=n.y-r.y;this.relocateHead(i,o)},onTargetSelect:function(t){var e=this.router.source();this.isSelected()?e.isSelected()||this.deselect():e.isSelected()&&this.select()},onTargetBeforeDrag:function(t,e){this.router.source().isSelected()&&e.isSelected()||this.deselect(),this.cached.convex=null},onTargetDrag:function(t){console.warn("Not yet implemented")},onTargetAfterDrag:function(t){var e=this.router.target(),r=this.router.source(),n=t.tx,i=t.ty;e.isSelected()?r.isSelected()||this.relocateHead(n,i):this.relocateHead(n,i)},onTargetAfterResize:function(t){
this.relocateHead(t.translate.dx,t.translate.dy)},onTargetBeforeDestroy:function(){this.props.removed||this.component("coat").remove()},onTrashToolClick:function(t){this.component("coat").remove()},onConfigToolClick:function(t){},onFrontToolClick:function(t){this.sendToFront()},onBackToolClick:function(t){},destroy:function(){}});e.guid=0}(),function(){var t=Graph.link.Link;Graph.link.Directed=Graph.extend(t,{renderControl:function(){var t=this,e=t.component("editor");t.cached.controls&&(_.forEach(t.cached.controls,function(t){t=Graph.registry.vector.get(t),t.remove()}),t.cached.controls=null);var r=this.cached.bendpoints,n=r.length-1,i=t.guid(),o=[],s=Graph.config.base+"img/"+Graph.config.resizer.image,a=Graph.config.resizer.size;_.forEach(r,function(r,p){var h=new Graph.svg.Image(s,r.x-a/2,r.y-a/2,a,a);h.selectable(!1),h.removeClass(Graph.styles.VECTOR),0===p?(h.addClass(Graph.styles.LINK_TAIL),h.elem.data("pole","tail")):p===n&&(h.addClass(Graph.styles.LINK_HEAD),h.elem.data("pole","head")),h.elem.group("graph-link"),h.elem.data(Graph.string.ID_LINK,i);var c={trans:0===p||p===n?"CONNECT":"BENDING",index:r.index,space:r.space,point:{x:r.x,y:r.y},event:{x:r.x,y:r.y},range:{start:r.range[0],end:r.range[1]},delta:{x:0,y:0},snap:{hor:[],ver:[]}};h.draggable({ghost:!1}),h.cursor("default"),h.on("beforedrag",_.bind(t.onControlStart,t,_,c,h)),h.on("drag",_.bind(t.onControlMove,t,_,c,h)),h.on("afterdrag",_.bind(t.onControlEnd,t,_,c,h)),h.render(e),o.push(h.guid())}),t.cached.controls=o,o=null},onControlStart:function(t,e,r){if(this.router.initTrans(e),"CONNECT"==e.trans){var n=this.component().paper();n&&n.addClass("linking")}var i=e.snap.hor,o=e.snap.ver;r.draggable().snap([function(t,e){return{x:Graph.util.snapValue(t,o),y:Graph.util.snapValue(e,i),range:10}}]),_.forEach(this.cached.controls,function(t){var e=Graph.registry.vector.get(t);e&&e!==r&&e.hide()}),r.show()},onControlMove:function(t,e,r){var n=this;e.delta.x+=t.dx,e.delta.y+=t.dy;var i,o,s,a;i=e.event.x,o=e.event.y,"BENDING"==e.trans?n.router.bending(e,function(t){n.reload(t.command,!0)}):n.router.connecting(e,function(t){n.reload(t.command,!0)}),s=e.event.x,a=e.event.y,t.originalData.dx=s-i,t.originalData.dy=a-o},onControlEnd:function(t,e,r){if(this.router.stopTrans(e),"CONNECT"==e.trans){var n=this.component().paper();n&&n.removeClass("linking")}this.reload(this.router.command()),this.invalidate(),this.resumeControl()}})}(),function(){Graph.link.Orthogonal=Graph.extend(Graph.link.Link,{reload:function(t,e){var r,n,i,o,s;if(e=_.defaultTo(e,!1),r=this.cached.convex,n=this.props.smooth,r){var a=this.router.waypoints();if(!a)return;o=a.slice(),o.length-1,s=[],_.forEach(o,function(t,e){var n,i=t,a=o[e+1];n=0===e?["M",t.x,t.y]:["L",t.x,t.y],s.push(n),r[e]&&_.forEach(r[e],function(t){var e=Graph.util.convexSegment(t,i,a);e&&s.push(e[0],e[1])})}),t=Graph.util.segments2path(s)}if(n){i=this.props.smoothness||6,s=s||Graph.util.path2segments(t).slice();var p,h,c,l,u;for(u=0;u<s.length;u++)if(p=s[u],
c=s[u+1],!("L"!=p[0]||!c||"Q"==c[0])&&(l={x:p[p.length-2],y:p[p.length-1]},(h=s[u-1])&&c)){var d=Graph.util.smoothSegment(l,{x:h[h.length-2],y:h[h.length-1]},{x:c[c.length-2],y:c[c.length-1]},i);d&&(s.splice(u,1,d[0],d[1]),u++)}t=Graph.util.segments2path(s)}t=t||"",this.component("coat").attr("d",t).dirty(!0),this.component("path").attr("d",t),this.invalidate(),e||(this.refresh(),this.fire("change"),Graph.topic.publish("link:change"))},renderControl:function(){var t=this,e=t.component("editor");t.cached.controls&&(_.forEach(t.cached.controls,function(t){t=Graph.registry.vector.get(t),t.remove()}),t.cached.controls=null);var r=this.cached.bendpoints,n=t.guid(),i=r.length-1,o=[],s=Graph.config.base+"img/"+Graph.config.resizer.image,a=Graph.config.resizer.size;_.forEach(r,function(r,p){var h,c,l,u,d;h=new Graph.svg.Image(s,r.x-a/2,r.y-a/2,a,a),h.selectable(!1),h.removeClass(Graph.styles.VECTOR),h.elem.group("graph-link"),h.elem.data(Graph.string.ID_LINK,n),d={ghost:!1},u=null,c="default",0===p?(h.addClass(Graph.styles.LINK_TAIL),h.elem.data("pole","tail")):p===i?(h.addClass(Graph.styles.LINK_HEAD),h.elem.data("pole","head")):(l=Graph.util.pointAlign(r.start,r.end),u="v"==l?"y":"x",c="x"==u?"ew-resize":"ns-resize",d={ghost:!1,axis:u});var f={trans:0===p||p===i?"CONNECT":"BENDING",index:r.index,axis:u,cursor:c,point:{x:r.x,y:r.y},ranges:{start:r.range[0],end:r.range[1]},event:{x:r.x,y:r.y},snap:{hor:[],ver:[]},delta:{x:0,y:0}};h.draggable(d),h.cursor(c),h.on("beforedrag",_.bind(t.onControlStart,t,_,f,h)),h.on("drag",_.bind(t.onControlMove,t,_,f)),h.on("afterdrag",_.bind(t.onControlEnd,t,_,f,h)),h.render(e),o.push(h.guid())}),t.cached.controls=o,o=null},onControlStart:function(t,e,r){if(this.component("coat").cursor(e.cursor),this.router.initTrans(e),"CONNECT"==e.trans){var n=this.component().paper();n&&n.addClass("linking")}var i=e.snap.hor,o=e.snap.ver;r.draggable().snap([function(t,e){return{x:Graph.util.snapValue(t,o),y:Graph.util.snapValue(e,i),range:10}}]),_.forEach(this.cached.controls,function(t){var e=Graph.registry.vector.get(t);e&&e!==r&&e.hide()}),r.show(),this.removeConvex()},onControlMove:function(t,e){var r=this;e.delta.x+=t.dx,e.delta.y+=t.dy;var n,i,o,s,a,p;n=e.event.x,i=e.event.y,"BENDING"==e.trans?r.router.bending(e,function(t){r.reload(t.command,!0)}):r.router.connecting(e,function(t){r.reload(t.command,!0)}),o=e.event.x,s=e.event.y,a=o-n,p=s-i,t.originalData.dx=a,t.originalData.dy=p},onControlEnd:function(t,e,r){if(this.component("coat").cursor("pointer"),this.router.stopTrans(e),"CONNECT"==e.trans){var n=this.component().paper();n&&n.removeClass("linking")}this.reload(this.router.command()),this.invalidate(),this.resumeControl()},toString:function(){return"Graph.link.Orthogonal"}})}(),function(){function t(t){var e=function(t){return t},r=_.bisector(function(t){return e(t)}).left;return t.insert=function(r){var n=t.findIndex(r),i=e(r);if(!t[n]||i!=e(t[n]))return t.splice(n,0,r),n},t.remove=function(e){var r=t.findIndex(e)
;return t.splice(r,1),r},t.findIndex=function(n){return r(t,e(n))},t.key=function(r){return e=r,t},t.swap=function(){},t.order=function(){return t.sort(_.ascendingKey(e)),t},t}var e=Graph.util.Sweeplink=function(t){var e=this;e.points=[],e.queue=[],e.lines=[],e.found=[],e.process=[],_.forEach(t,function(t){var r=e.extract(t);Array.prototype.push.apply(e.points,r)}),_.forEach(e.points,function(t,r){r%2&&e.lines.push(_.sortBy([t,e.points[r-1]],"y"))}),_.forEach(e.lines,function(t,e){t[0].x==t[1].x&&(t[0].x+=.1,t[1].x-=.1),t[0].y==t[1].y&&(t[0].y-=.1,t[1].y+=.1),t[0].line=t,t[1].line=t})};e.prototype.constructor=e,e.prototype.extract=function(t){var e=t.router.path().curve().segments,r=[];return _.forEach(e,function(n,i){var o=0===i?{x:n[1],y:n[2]}:{x:n[5],y:n[6]},s=e[i+1];s&&(s={x:s[5],y:s[6]},Graph.util.movepoint(o,s,-20),Graph.util.movepoint(s,o,-20),o.x=Math.round(o.x,3),o.y=Math.round(o.y,3),s.x=Math.round(s.x,3),s.y=Math.round(s.y,3),o.link=t,s.link=t,o.range=i,s.range=i+1,r.push(o,s))}),r},e.prototype.findConvex=function(){var e=this;e.queue=t(e.points.slice()).key(function(t){return t.y+1e-9*t.x}).order(),e.found=[],e.process=t([]);for(var r=0;r<e.queue.length&&r<1e3;r++){var n,i,o,s,a=e.queue[r];a.line&&a.line[0]==a?(a.type="insert",n=e.process.key(function(t){return e.intercept(t,a.y-1e-12)}).insert(a.line),e.validate(a.line,e.process[n+1]),e.validate(a.line,e.process[n-1])):a.line?(a.type="removal",n=e.process.findIndex(a.line),e.process.remove(a.line),e.validate(e.process[n-1],e.process[n])):a.lineA&&a.lineB&&(e.process.key(function(t){return e.intercept(t,a.y-1e-12)}),i=e.process.findIndex(a.lineA),o=e.process.findIndex(a.lineB),i==o&&(i+=1),e.process[i]=a.lineB,e.process[o]=a.lineA,s=i<o?i:o,e.validate(e.process[s-1],e.process[s]),e.validate(e.process[s+1],e.process[s+2]))}var p={};return _.forEach(this.found,function(e){var r,n,i,o,s,a,h,c,l,u,d;h=Graph.util.pointAlign(e.lineA[0],e.lineA[1],10),c=Graph.util.pointAlign(e.lineB[0],e.lineB[1],10),h!=c&&(o="v"==h?h:c,l="v"==h?e.lineA:e.lineB,u=l[0].link,d=u.guid(),r=u.router.waypoints(),n=Math.min(l[0].range,l[1].range),i=Math.max(l[0].range,l[1].range),s=r[n],a=r[i],p[d]||(p[d]={}),p[d][n]||(p[d][n]=t([]).key(function(t){return"v"==t.segmentAlign?t.segmentStart.x<t.segmentEnd.x?t.x+t.segmentStart.x:t.segmentStart.x-t.x:t.segmentStart.y<t.segmentEnd.y?t.y+t.segmentStart.y:t.segmentStart.y-t.y})),p[d][n].insert({x:e.x,y:e.y,link:u.guid(),rangeStart:n,rangeEnd:i,segmentAlign:o,segmentStart:s,segmentEnd:a}))}),p},e.prototype.intersect=function(t,e,r,n){var i=(t.x-e.x)*(r.y-n.y)-(t.y-e.y)*(r.x-n.x),o=t.x*e.y-t.y*e.x,s=r.x*n.y-r.y*n.x,a=(o*(r.x-n.x)-s*(t.x-e.x))/i,p=(o*(r.y-n.y)-s*(t.y-e.y))/i,h={x:a,y:p};return h.isOverlap=a==t.x&&p==t.y||a==e.x&&p==e.y,h.isIntersection=!(t.x<a^a<e.x)&&!(r.x<a^a<n.x)&&!h.isOverlap&&i,h},e.prototype.validate=function(t,e){if(t&&e){var r=this.intersect(t[0],t[1],e[0],e[1]);r.lineA=t,r.lineB=e,r.isIntersection&&this.found.push(r)&&this.queue.insert(r)}},
e.prototype.intercept=function(t,e){var r=t[0],n=t[1],i=(r.y-n.y)/(r.x-n.x);return(e-r.y+i*r.x)/i},e.prototype.destroy=function(){this.points=null,this.lines=null,this.found=null,this.queue=null,this.process=null}}(),function(){Graph.plugin.Plugin=Graph.extend({props:{vector:null,activator:"tool"},cached:{},options:function(t){},vector:function(){return Graph.registry.vector.get(this.props.vector)},invalidate:function(){},enable:function(t){},disable:function(){},destroy:function(){}})}(),function(){var t=Graph.plugin.Manager=function(){this.installed={}};t.prototype.get=function(t){var e=this.installed[t];return{plugin:function(){if(e){return Graph.registry.vector.get(e.target)[e.handler]()}return null},component:function(){return e?Graph.registry.vector.get(e.target):null}}},t.prototype.install=function(t,e,r){var n=this.getPluginHandler(t);n&&(r=r||{},e[n](r),this.installed[t]={handler:n,target:e.guid()})},t.prototype.uninstall=function(t){var e=this.installed[t];if(e){Graph.registry.vector.get(e.target)[handler]({destroy:!0}),delete this.installed[t]}},t.prototype.getPluginHandler=function(t){return{network:"connectable",resizer:"resizable",snapper:"snappable",dragger:"draggable",editor:"editable",rotator:"rotatable"}[t]}}(),function(){Graph.plugin.Definer=Graph.extend(Graph.plugin.Plugin,{props:{vector:null},definitions:{},components:{holder:null},constructor:function(t){this.props.vector=t.guid(),this.components.holder=Graph.$("<defs/>"),this.components.holder.prependTo(t.elem),t.isPaper()&&(this.defineArrowMarker("marker-link-end"),this.defineCircleMarker("marker-link-start-circle"))},defineArrowMarker:function(t){if(this.definitions[t])return this.definitions[t];var e=Graph.$(_.format('<marker id="{0}" refX="{1}" refY="{2}" viewBox="{3}" markerWidth="{4}" markerHeight="{5}" orient="{6}"><path d="{7}" fill="{8}" stroke-width="{9}" stroke-linecap="{10}" stroke-dasharray="{11}"></path></marker>',t,"11","10","0 0 20 20","10","10","auto","M 1 5 L 11 10 L 1 15 Z","#000000","1","round","10000, 1"));return this.definitions[t]=e,this.components.holder.append(e),e},defineCircleMarker:function(t){if(this.definitions[t])return this.definitions[t];var e=Graph.$(_.format('<marker id="{0}" refX="{1}" refY="{2}" viewBox="{3}" markerWidth="{4}" markerHeight="{5}" orient="{6}"><circle cx="6" cy="6" r="4" fill="none" stroke="#000000" stroke-width="1" /></marker>',t,"6","6","0 0 20 20","10","10","auto"));return this.definitions[t]=e,this.components.holder.append(e),e},toString:function(){return"Graph.plugin.Definer"}})}(),function(){var t={},e=Graph.plugin.Reactor=function(e,r){var n=this,i=e.node(),o=e.guid();n.props={vector:o},n.listeners=r||{};var s=t[o]=interact(i);s.on("down",function(t){Graph.event.target(t)===i&&(t.originalType="pointerdown",Graph.topic.publish("vector:pointerdown",{vector:e}),e.fire(t))},!0),e.elem.on({contextmenu:function(t){Graph.event.target(t)===i&&e.fire(t)}}),s=null};e.prototype.constructor=e,e.prototype.fire=function(t){
switch(t){case"down":({type:"mousedown"})}},e.prototype.vendor=function(){return t[this.props.vector]},e.prototype.draggable=function(t){return this.vendor().draggable(t)},e.prototype.dropzone=function(t){return this.vendor().dropzone(t)},e.prototype.gesturable=function(t){return this.vendor().gesturable(t)},e.prototype.destroy=function(){var e=this.props.vector,r=t[e];r&&r.unset(),delete t[e]},e.prototype.toString=function(){return"Graph.plugin.Reactor"}}(),function(){Graph.plugin.Transformer=Graph.extend(Graph.plugin.Plugin,{props:{scale:1,rotate:0},constructor:function(t){this.actions=[],this.props.vector=t.guid()},transform:function(t){var e=this,r=Graph.util.transform2segments(t);return _.forEach(r,function(t){var r=t.shift();e[r]&&_.isFunction(e[r])&&function(){e[r].apply(e,t)}()}),this},queue:function(){var t=_.toArray(arguments);return this.actions.push({name:t.shift(),args:t,sort:this.actions.length}),this},translate:function(t,e){return t=_.defaultTo(t,0),e=_.defaultTo(e,0),this.queue("translate",t,e),this},rotate:function(t,e,r){return _.isUndefined(e)||_.isUndefined(r)?this.queue("rotate",t):this.queue("rotate",t,e,r),this},scale:function(t,e,r,n){return e=_.defaultTo(e,t),_.isUndefined(r)||_.isUndefined(n)?this.queue("scale",t,e):this.queue("scale",t,e,r,n),this},matrix:function(t,e,r,n,i,o){return this.queue("matrix",t,e,r,n,i,o),this},commit:function(t,e){var r=this,n=r.actions,i=r.vector(),o={translate:!1,rotate:!1,scale:!1};if(n.length){t=_.defaultTo(t,!1),e=_.defaultTo(e,!1);var s=0,a=1,p=1,h=i.matrix().clone();if(_.forEach(n,function(e){var r=e.args,n=e.name,c=r.length,l=!1;t&&(l=h.invert(!0));var u,d,f,g,y;"translate"==n&&2===c?(t?(u=l.x(0,0),d=l.y(0,0),f=l.x(r[0],r[1]),g=l.y(r[0],r[1]),h.translate(f-u,g-d)):h.translate(r[0],r[1]),o.translate=!0):"rotate"==n?(1==c?(y=y||i.bboxPristine().toJson(),h.rotate(r[0],y.x+y.width/2,y.y+y.height/2),s+=r[0]):3==c&&(t?(f=l.x(r[1],r[2]),g=l.y(r[1],r[2]),h.rotate(r[0],f,g)):h.rotate(r[0],r[1],r[2]),s+=r[0]),o.rotate=!0):"scale"==n?(1===c||2===c?(y=y||i.bboxPristine().toJson(),h.scale(r[0],r[c-1],y.x+y.width/2,y.y+y.height/2),a*=r[0],p*=r[c-1]):4===c&&(t?(f=l.x(r[2],r[3]),g=l.y(r[2],r[3]),h.scale(r[0],r[1],f,g)):h.scale(r[0],r[1],r[2],r[3]),a*=r[0],p*=r[1]),o.scale=!0):"matrix"==n&&h.multiply(r[0],r[1],r[2],r[3],r[4],r[5])}),e)return this.actions=[],h;i.graph.matrix=h,i.attr("transform",h.toValue()),o.translate&&(o.translate={dx:h.e,dy:h.f},this.fire("aftertranslate",o.translate)),o.rotate&&(o.rotate={deg:s},this.fire("afterrotate",o.rotate)),o.scale&&(o.scale={sx:a,sy:p},this.fire("afterscale",o.scale)),this.actions=[]}},toString:function(){return"Graph.plugin.Transformer"}})}(),function(){function t(t,r){r=_.toString(r).replace(/\.{3}|\u2026/g,t),t=Graph.util.transform2segments(t)||[],r=Graph.util.transform2segments(r)||[];for(var n,i,o,s,a=Math.max(t.length,r.length),p=[],h=[],c=0;c<a;c++){if(o=t[c]||e(r[c]),s=r[c]||e(o),
o[0]!=s[0]||"rotate"==o[0].toLowerCase()&&(o[2]!=s[2]||o[3]!=s[3])||"scale"==o[0].toLowerCase()&&(o[3]!=s[3]||o[4]!=s[4]))return{equal:!1,from:o,to:s};for(p[c]=[],h[c]=[],n=0,i=Math.max(o.length,s.length);n<i;n++)n in o&&(p[c][n]=o[n]),n in s&&(h[c][n]=s[n])}return{equal:!0,from:p,to:h}}function e(t){var e=t[0];switch(e.toLowerCase()){case"translate":return[e,0,0];case"matrix":return[e,1,0,0,1,0,0];case"rotate":return 4==t.length?[e,0,t[2],t[3]]:[e,0];case"scale":return 5==t.length?[e,1,1,t[3],t[4]]:3==t.length?[e,1,1]:[e,1]}}var r=this,n=Graph.plugin.Animator=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,duration:1e3,easing:"linier"},stacks:[],constructor:function(t){this.props.vector=t.guid()},create:function(t,e,r,n){return new i(t,e,r,n)},animate:function(t,e,r,n){var o,s,a=this.vector(),p=_.extend({},a.attrs);return t instanceof i?s=t:(e=_.defaultTo(e,this.props.duration),_.isFunction(r)&&(n=r,r=this.props.easing),r||(r=this.props.easing),o={100:t},s=new i(o,e,r,n)),s.count()?(p.transform=a.attrs.transform,p.matrix=a.matrix().clone(),this.start(s,s.frame(0),p,null),s=null,this):void(s=null)},resume:function(){},pause:function(){},stop:function(){},start:function(e,r,o,s){var a=e.count();if(!a)return void(e=null);var p,h,c,l,u,d,f,g,y=this.vector(),v=this.stacks.length,m={},x={},b={};if(s){for(g=0;g<v;g++)if(f=this.stacks[g],f.animation==e){f.frame!=r?(this.stacks.splice(g,1),d=1):u=f,y.attr(f.reset);break}}else s=+b;for(h={animation:e,vector:y},l=e.duration(),c=e.at(a-1).frame,g=0;g<a;g++){if(p=e.at(g),p.frame==r||p.frame>s*c){h.prev=e.at(g-1),h.prev=h.prev?h.prev.frame:0,h.frame=p.frame,h.duration=l/c*(h.frame-h.prev),h.next=e.at(g+1),h.next=h.next?h.next.frame:void 0,h.last=c;break}s&&y.attr(p.params)}if(u)u.initstatus=s,u.start=new Date-u.duration*s;else{l=h.duration,_.forOwn(p.params,function(e,r){var n,o,s,a,p,h,c,u,d=i.animable[r];if(d)switch(x[r]=y.attrs[r],x[r]=_.defaultTo(x[r],d.defaults),b[r]=e,d.type){case"number":m[r]=(b[r]-x[r])/l;break;case"transform":var f=t(y.attrs[r],e);if(f.equal)for(x[r]=f.from,b[r]=f.to,m[r]=[],m[r].semantic=!0,p=0,c=x[r].length;p<c;p++)for(m[r][p]=[x[r][p][0]],h=1,u=x[r][p].length;h<u;h++)m[r][p][h]=(b[r][p][h]-x[r][p][h])/l;else n=y.plugins.transformer,a=Graph.util.transform2segments(b[r]),o=y.matrix(),x[r]=o.clone(),s=o.invert(!0),y.graph.matrix=o.multiply(s),_.forEach(a,function(t){var e=t[0],r=t.slice(1);n[e].apply(n,r)}),o=n.commit(!1,!0),b[r]=o.clone(),m[r]={a:(b[r].props.a-x[r].props.a)/l,b:(b[r].props.b-x[r].props.b)/l,c:(b[r].props.c-x[r].props.c)/l,d:(b[r].props.d-x[r].props.d)/l,e:(b[r].props.e-x[r].props.e)/l,f:(b[r].props.f-x[r].props.f)/l},a=null,n=null,o=null}});var G=+new Date;if(_.extend(h,{scene:p,timestamp:G,start:G+e.delay(),reset:o,from:x,to:b,delta:m,status:0,initstatus:s||0,stop:!1}),this.stacks.push(h),s&&!u&&!d&&(h.stop=!0,h.start=new Date-p.duration*s,1===this.stacks.length))return this.player();d&&(h.start=new Date-p.duration*s),
1===this.stacks.length&&n.play(_.bind(this.player,this))}this.fire("animstart")},player:function(){for(var t,e,r,o,s,a,p,h,c,l,u,d,u,f,g,c,y,v,m,x,b,G=+new Date,w=0;w<this.stacks.length;w++)if(e=this.stacks[w],!(e.paused||(o=G-e.start,a=e.duration,t=e.vector,l=e.scene,r=e.from,y=e.to,delta=e.delta,s=e.animation,e.initstatus?(o=(e.initstatus*e.last-e.prev)/(e.frame-e.prev)*a,e.status=e.initstatus,delete e.initstatus,e.stop&&this.stacks.splice(w--,1)):e.status=(e.prev+(e.frame-e.prev)*(o/a))/e.last,o<0)))if(o<a){ease=l.easing(o/a);for(c in r)switch(p=i.animable[c],p.type){case"number":h=+r[c]+ease*a*delta[c],t.attr(name,h);break;case"transform":if(delta[c].semantic){for(d=t.plugins.transformer,x=0,v=r[c].length;x<v;x++){for(f=r[c][x][0],g=[],b=1,m=r[c][x].length;b<m;b++)g.push(r[c][x][b]+ease*a*delta[c][x][b]);d[f].apply(d,g)}u=d.commit(!1,!0),t.attr("transform",u.toValue()),u=null,d=null}else u=Graph.matrix(r[c].props.a+ease*a*delta[c].a,r[c].props.b+ease*a*delta[c].b,r[c].props.c+ease*a*delta[c].c,r[c].props.d+ease*a*delta[c].d,r[c].props.e+ease*a*delta[c].e,r[c].props.f+ease*a*delta[c].f),t.attr("transform",u.toValue()),u=null}}else{for(c in y)switch(p=i.animable[c],p.type){case"transform":delta[c].semantic?(d=t.plugins.transformer,_.forEach(y[c],function(t){var e=t[0],r=t.slice(1);d[e].apply(d,r)}),u=d.commit(!1,!0),t.graph.matrix=u,t.attr("transform",u.toValue()),u=null,d=null):(u=y[c].clone(),t.graph.matrix=u,t.attr("transform",u.toValue()),u=null);break;default:t.attr(c,y[c])}l.played++,this.stacks.splice(w--,1);var k=s.repeat(),C=l.played;k>1&&C<k&&!e.next&&(_.forOwn(s.scenes,function(r,n){for(var i in r.params)"transform"==i?(t.graph.matrix=e.reset.matrix,t.attr("transform",e.reset.transform)):t.attr(n,e.reset[n])}),this.start(s,s.frame(0),e.reset,null)),e.next&&!e.stop&&this.start(s,e.next,e.reset,null),C>=k&&(e=null)}this.stacks.length&&n.play(_.bind(this.player,this))},toString:function(){return"Graph.plugin.Animator"}});n.play=function(t){var e=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||t.msRequestAnimationFrame||function(t){setTimeout(t,16)};return _.bind(e,t)}(r);var i=Graph.extend({props:{easing:"linier",duration:1e3,repeat:1,delay:0},scenes:{},frames:[],constructor:function(t,e,r,n){if(this.props.guid="graph-anim-"+ ++i.guid,this.props.duration=e=_.defaultTo(e,1e3),_.isFunction(r)&&(n?this.props.easing="function":(n=r,r=this.props.easing)),r||(r=this.props.easing),t){var r=_.isString(r)?i.easing[r]:r,o=(this.props.repeat,this.scenes),s=this.frames;_.forOwn(t,function(t,e){var a,p,h={};a=_.toNumber(e),h=_.pickBy(t,function(t,e){return!!i.animable[e]}),p={frame:a,params:h,easing:r,callback:n,played:0},s.push(a),o[a]=p}),s.sort(function(t,e){return t-e})}},guid:function(){return this.props.guid},duration:function(){return this.props.duration},easing:function(){return this.props.easing},delay:function(t){if(void 0===t)return this.props.delay;var e=new i
;return e.frames=this.frames,e.scenes=_.cloneDeep(this.scenes),e.props=_.cloneDeep(this.props),e.props.delay=t||0,e},repeat:function(t){if(void 0===t)return this.props.repeat;var e=new i;return e.frames=this.frames.slice(),e.scenes=_.cloneDeep(this.scenes),e.props=_.cloneDeep(this.props),e.props.repeat=Math.floor(Math.max(t,0))||1,_.forOwn(e.scenes,function(t,e){t.played=0}),e},count:function(){return this.frames.length},at:function(t){var e=this.frame(t);return this.scene(e)},frame:function(t){return this.frames[t]},scene:function(t){return this.scenes[t]},destroy:function(){this.scenes=null,this.frames=null}});_.extend(i,{guid:0,animable:{x:{type:"number",defaults:0},y:{type:"number",defaults:0},cx:{type:"number",defaults:0},cy:{type:"number",defaults:0},transform:{type:"transform",defaults:""}},easing:{linier:function(t){return t},easeIn:function(t){return Math.pow(t,1.7)},easeOut:function(t){return Math.pow(t,.48)},easeInOut:function(t){var e=.48-t/1.04,r=Math.sqrt(.1734+e*e),n=r-e,i=Math.pow(Math.abs(n),1/3)*(n<0?-1:1),o=-r-e,s=Math.pow(Math.abs(o),1/3)*(o<0?-1:1),a=i+s+.5;return 3*(1-a)*a*a+a*a*a},backIn:function(t){var e=1.70158;return t*t*((e+1)*t-e)},backOut:function(t){t-=1;var e=1.70158;return t*t*((e+1)*t+e)+1},elastic:function(t){return t==!!t?t:pow(2,-10*t)*math.sin((t-.075)*(2*PI)/.3)+1},bounce:function(t){var e,r=7.5625,n=2.75;return t<1/n?e=r*t*t:t<2/n?(t-=1.5/n,e=r*t*t+.75):t<2.5/n?(t-=2.25/n,e=r*t*t+.9375):(t-=2.625/n,e=r*t*t+.984375),e}}})}(),function(){function t(t,e){var r={x:e.x,y:e.y};switch(t.props.dir){case"n":r.x=(e.x+e.x2)/2,r.y=e.y2;break;case"e":r.x=e.x,r.y=(e.y+e.y2)/2;break;case"s":r.x=(e.x+e.x2)/2,r.y=e.y;break;case"w":r.x=e.x2,r.y=(e.y+e.y2)/2;break;case"ne":r.x=e.x,r.y=e.y2;break;case"se":r.x=e.x,r.y=e.y;break;case"sw":r.x=e.x2,r.y=e.y;break;case"nw":r.x=e.x2,r.y=e.y2}return r}Graph.plugin.Resizer=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,enabled:!0,suspended:!0,restriction:null,handleImage:null,handleSize:null,rendered:!1},components:{holder:null,helper:null,handle:null},trans:{ox:0,oy:0,ow:0,oh:0,cw:0,ch:0,dx:0,dy:0},constructor:function(t,e){var r=this,n=t.guid();e=e||{},_.assign(r.props,e),t.addClass("graph-resizable"),r.props.handleImage=Graph.config.base+"img/"+Graph.config.resizer.image,r.props.handleSize=Graph.config.resizer.size,r.props.vector=n,r.cached.snapping=null,r.cached.vertices=null,r.initComponent()},holder:function(){return Graph.registry.vector.get(this.components.holder)},helper:function(){return Graph.registry.vector.get(this.components.helper)},handle:function(t){return Graph.registry.vector.get(this.components.handle[t])},initComponent:function(){var t,e,r=this,n=r.components;t=(new Graph.svg.Group).addClass("graph-resizer").removeClass("graph-elem graph-elem-group"),t.elem.group("graph-resizer"),t.on({render:_.bind(r.onHolderRender,r)}),
e=new Graph.svg.Rect(0,0,0,0,0).addClass("graph-resizer-helper").removeClass("graph-elem graph-elem-rect").selectable(!1).clickable(!1).render(t),e.elem.group("graph-resizer"),n.handle={};var i={ne:{ghost:!1,cursor:"nesw-resize"},se:{ghost:!1,cursor:"nwse-resize"},sw:{ghost:!1,cursor:"nesw-resize"},nw:{ghost:!1,cursor:"nwse-resize"},n:{ghost:!1,cursor:"ns-resize",axis:"y"},e:{ghost:!1,cursor:"ew-resize",axis:"x"},s:{ghost:!1,cursor:"ns-resize",axis:"y"},w:{ghost:!1,cursor:"ew-resize",axis:"x"}};_.forOwn(i,function(e,i){!function(i){var o=new Graph.svg.Image(r.props.handleImage,0,0,r.props.handleSize,r.props.handleSize).selectable(!1).removeClass("graph-elem graph-elem-image").addClass("graph-resizer-handle handle-"+i);o.elem.group("graph-resizer"),o.props.dir=i,o.draggable(e),o.on("beforedrag",_.bind(r.onHandleBeforeDrag,r)),o.on("drag",_.bind(r.onHandleDrag,r)),o.on("afterdrag",_.bind(r.onHandleAfterDrag,r)),o.render(t),n.handle[i]=o.guid(),o=null}(i)}),n.holder=t.guid(),n.helper=e.guid(),t=null,e=null,i=null},invalidate:function(){this.superclass.prototype.invalidate.call(this),this.cached.vertices=null},disable:function(){this.props.enabled=!1},enable:function(){this.props.enabled=!0},render:function(){var t=this;if(t.props.rendered)return void t.redraw();t.holder().render(t.vector().parent()),t.props.rendered=!0,t.redraw()},snap:function(t){this.cached.snapping=t},vertices:function(){var t=this,e=t.vector(),r=t.cached.vertices;if(!r){var n,i,o,s,a,p,h,c,l,u,d;if(n=e.shape(),i=n.bbox().toJson(),o=e.matrix().rotate(),s=o.deg,a=0,p=0,h=i.x,c=i.y,l=t.props.handleSize/2,s){var f=Graph.matrix(),n=e.shapeRelative();a=i.x+i.width/2,p=i.y+i.height/2,f.rotate(-s,a,p),n=n.transform(f),i=n.bbox().toJson()}else{var g=e.matrix();n=n.transform(g),i=n.bbox().toJson()}u=i.width/2,d=i.height/2,r={ne:{x:i.x+i.width-l,y:i.y-l},se:{x:i.x+i.width-l,y:i.y+i.height-l},sw:{x:i.x-l,y:i.y+i.height-l},nw:{x:i.x-l,y:i.y-l},n:{x:i.x+u-l,y:i.y-l},e:{x:i.x+i.width-l,y:i.y+d-l},s:{x:i.x+u-l,y:i.y+i.height-l},w:{x:i.x-l,y:i.y+d-l},rotate:{deg:s,cx:a,cy:p},box:{x:i.x,y:i.y,width:i.width,height:i.height},offset:{x:h,y:c}},this.cached.vertices=r}return r},redraw:function(){var t,e=this,r=e.helper(),n=e.holder();n&&(t=this.vertices())&&(r.reset(),r.attr({x:t.box.x,y:t.box.y,width:t.box.width,height:t.box.height}),r.rotate(t.rotate.deg,t.rotate.cx,t.rotate.cy).commit(),_.forOwn(e.components.handle,function(r,n){!function(r,n){var i=e.handle(n);i.show(),i.reset(),i.attr(t[n]),i.rotate(t.rotate.deg,t.rotate.cx,t.rotate.cy).commit()}(0,n)}),e.trans.ox=t.offset.x,e.trans.oy=t.offset.y,e.trans.ow=this.trans.cw=t.box.width,e.trans.oh=this.trans.ch=t.box.height,e.trans.dx=0,e.trans.dy=0)},suspend:function(){this.props.suspended=!0,this.holder().elem.detach()},resume:function(){this.props.enabled&&this.props.suspended&&(this.props.suspended=!1,this.props.rendered?(this.vector().parent().elem.append(this.holder().elem),this.redraw()):this.render())},restrict:function(t){
_.assign(this.props,{restriction:t})},setupRestriction:function(e){var r,n=this,i=this.props.restriction||{},o=n.vector(),s=o.paper(),a=(s.layout(),e.props.dir),p=+i.width||0,h=+i.height||0,c=Number.MAX_SAFE_INTEGER,l={top:-c,left:-c,right:c,bottom:c};if(void 0===i.origin){r=t(e,o.bboxView().toJson())}else r=_.extend({x:0,y:0},i.origin);switch(a){case"n":l.bottom=r.y-h;break;case"e":l.left=r.x+p;break;case"s":l.top=r.y+h;break;case"w":l.right=r.x-p;break;case"ne":l.left=r.x+p,l.bottom=r.y-h;break;case"se":l.top=r.y+h,l.left=r.x+p;break;case"sw":l.right=r.x-p,l.top=r.y+h;break;case"nw":l.right=r.x-p,l.bottom=r.y-h}e.draggable().restrict(l)},onHolderRender:function(t){},onHandleBeforeDrag:function(t){var e=this,r=e.vector(),n=t.publisher;e.fire("beforeresize",{resizer:this,direction:n.props.dir}),r.isRotatable()&&r.rotatable().suspend(),_.forOwn(e.components.handle,function(t,r){var i=e.handle(r);i!==n&&i.hide()});var i=this.cached.snapping;i&&n.draggable().snap()!==i&&n.draggable().snap(i),this.props.restriction&&this.setupRestriction(n),n.show(),n.removeClass("dragging")},onHandleDrag:function(t){var e=this,r=e.helper(),n=t.publisher,i=this.trans,o=t.dx,s=t.dy;switch(n.props.dir){case"ne":i.cw+=o,i.ch-=s,e.trans.dy+=s,r.translate(0,s).commit();break;case"se":i.cw+=o,i.ch+=s;break;case"sw":i.cw-=o,i.ch+=s,e.trans.dx+=o,r.translate(o,0).commit();break;case"nw":i.cw-=o,i.ch-=s,e.trans.dx+=o,e.trans.dy+=s,r.translate(o,s).commit();break;case"n":i.cw+=0,i.ch-=s,e.trans.dy+=s,r.translate(0,s).commit();break;case"e":i.cw+=o,i.ch+=0;break;case"s":i.cw+=0,i.ch+=s;break;case"w":i.cw-=o,i.ch+=0,e.trans.dx+=o,r.translate(o,0).commit()}r.attr({width:i.cw,height:i.ch})},onHandleAfterDrag:function(t){var e,r,n,i,o,s,a=this,p=this.trans,h=t.publisher;switch(e=p.ow>0?p.cw/p.ow:1,r=p.oh>0?p.ch/p.oh:1,o=p.dx,s=p.dy,h.props.dir){case"ne":n=p.ox,i=p.oy+p.oh;break;case"se":n=p.ox,i=p.oy;break;case"sw":n=p.ox+p.ow,i=p.oy;break;case"nw":n=p.ox+p.ow,i=p.oy+p.oh;break;case"n":n=p.ox+p.ow/2,i=p.oy+p.oh;break;case"e":n=p.ox,i=p.oy+p.oh/2;break;case"s":n=p.ox+p.ow/2,i=p.oy;break;case"w":n=p.ox+p.ow,i=p.oy+p.oh/2}var c=a.vector(),l=c.bbox().center().toJson(),u=c.resize(e,r,n,i,o,s),d=c.bbox().center().toJson(),f=d.x-l.x,g=d.y-l.y;u.translate.dx=f,u.translate.dy=g,a.redraw(),a.fire("afterresize",u),c.isRotatable()&&c.rotatable().resume()},toString:function(){return"Graph.plugin.Resizer"},destroy:function(){var t=this;_.forOwn(t.components.handle,function(e,r){t.handle(r).remove()}),t.components.handle=null,t.helper().remove(),t.components.helper=null,t.holder().remove(),t.components.holder=null,t.listeners=null}})}(),function(){Graph.plugin.Rotator=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,enabled:!0,suspended:!0,handleImage:null,handleSize:null,rendered:!1},components:{helper:null,handle:null,holder:null,circle:null,radius:null},constructor:function(t,e){var r=t.guid();e=e||{},_.assign(this.props,e),this.props.vector=r,
this.props.handleImage=Graph.config.base+"img/"+Graph.config.rotator.image,this.props.handleSize=Graph.config.rotator.size,this.initComponent()},invalidate:function(){this.superclass.prototype.invalidate.call(this)},initComponent:function(){var t,e,r,n,i;t=(new Graph.svg.Group).removeClass(Graph.styles.VECTOR).addClass("graph-rotator"),t.elem.group("graph-rotator"),t.on("render.rotator",_.bind(this.setup,this)),e=new Graph.svg.Rect(0,0,0,0,0).removeClass(Graph.styles.VECTOR).addClass("graph-rotator-helper").selectable(!1).clickable(!1).render(t),r=new Graph.svg.Image(this.props.handleImage,0,0,this.props.handleSize-2,this.props.handleSize).selectable(!1).removeClass(Graph.styles.VECTOR).addClass("graph-rotator-handle").render(t),r.elem.group("graph-rotator"),i=(new Graph.svg.Line).selectable(!1).clickable(!1).removeClass(Graph.styles.VECTOR).render(t),n=new Graph.svg.Circle(0,0,5).selectable(!1).clickable(!1).removeClass(Graph.styles.VECTOR).render(t),this.components.helper=e.guid(),this.components.handle=r.guid(),this.components.holder=t.guid(),this.components.circle=n.guid(),this.components.radius=i.guid(),this.suspendHelper(),t=r=e=n=i=null},setup:function(){var t=this,e=this.vector(),r=e.paper().layout(),n=this.helper(),i=this.handle(),o=this.holder(),s=this.radius(),a=i.node(),p={scale:null,center:null,translate:null,move:null,rotate:null,snaps:null,resizing:null};i.interactable().draggable({manualStart:!0,onstart:function(s){var a,h,c=e.matrix();p.scale=r.scale(),p.origin=i.bbox().center().toJson(),p.target={x:p.origin.x,y:p.origin.y},p.move={x:0,y:0},p.rotate=c.rotate().deg,p.snaps=[0,45,90,-135,-180,-225,-90,-45],p.resizing=e.isResizable()&&!1===e.resizable().props.suspended,a=n.bbox().center().toJson(),p.center=a,h=o.matrixCurrent().rotate().rad,p.radian={sin:Math.sin(h),cos:Math.cos(h)},p.resizing&&e.resizable().suspend(),t.resumeHelper()},onmove:function(t){var e,r,o,a,h,c,l,u=t.dx,d=t.dy;p.matrix=new Graph.lang.Matrix,u/=p.scale.x,d/=p.scale.y,a=u*p.radian.cos+d*p.radian.sin,h=u*-p.radian.sin+d*p.radian.cos,p.move.x+=a,p.move.y+=h,c=p.move.x+p.origin.x,l=p.move.y+p.origin.y,p.target={x:c,y:l},r=Math.atan2(p.center.y-l,p.center.x-c),o=Math.round(180*r/Math.PI-90),o=Graph.util.snapValue(o,p.snaps,5),p.matrix.rotate(o,p.center.x,p.center.y),p.rotate=o,e=p.matrix.toValue(),i.attr("transform",e),n.attr("transform",e),s.attr("transform",e)},onend:function(){var r,n,i=e.matrix(),o=e.bboxPristine().center().toJson(),s=i.rotate().deg,a=p.rotate-s;r=o.x,n=o.y,i.rotate(a,r,n),e.attr("transform",i.toValue()),e.dirty(!0),t.redraw(),p.resizing&&e.resizable().resume(),t.fire("afterrotate",{deg:p.rotate-90,cx:r,cy:n})}}).on("down",function(t){t.preventDefault(),t.stopPropagation()}).on("move",function(e){if(t.props.enabled){var r=e.interaction;if(r.pointerIsDown&&!r.interacting()){var n={name:"drag"};r.prepared.name=n.name,r.setEventXY(r.startCoords,r.pointers),e.currentTarget===a&&r.start(n,e.interactable,a)}}})},holder:function(){
return Graph.registry.vector.get(this.components.holder)},helper:function(){return Graph.registry.vector.get(this.components.helper)},circle:function(){return Graph.registry.vector.get(this.components.circle)},radius:function(){return Graph.registry.vector.get(this.components.radius)},handle:function(){return Graph.registry.vector.get(this.components.handle)},resume:function(){this.props.enabled&&this.props.suspended&&(this.props.suspended=!1,this.props.rendered?(this.vector().parent().elem.append(this.holder().elem),this.redraw()):this.render())},resumeHelper:function(){var t,e;for(e in this.components)-1===["holder","handle"].indexOf(e)&&(t=this[e]())&&t.show()},suspend:function(){this.props.suspended=!0,this.holder().elem.detach()},suspendHelper:function(){var t,e;for(e in this.components)-1===["holder","handle"].indexOf(e)&&(t=this[e]())&&t.hide()},render:function(){if(this.props.rendered)return void this.redraw();this.props.rendered=!0,this.holder().render(this.vector().parent()),this.redraw()},redraw:function(){var t,e,r=this.vector(),n=(this.holder(),this.helper()),i=this.handle(),o=this.circle(),s=this.radius(),a=r.matrix().rotate().deg,p=r.bbox().toJson();if(a){var h=Graph.matrix(),c=r.shapeRelative();t=p.x+p.width/2,e=p.y+p.height/2,h.rotate(-a,t,e),c=c.transform(h),p=c.bbox().toJson()}else{var l=r.matrix(),u=r.shape();u=u.transform(l),p=u.bbox().toJson(),t=p.x+p.width/2,e=p.y+p.height/2}n.reset(),i.reset(),s.reset(),n.attr({x:p.x,y:p.y,width:p.width,height:p.height});var d=(this.props.handleSize-2)/2,f=this.props.handleSize/2,g=t-d,y=p.y-30-f;o.attr({cx:t,cy:e}),i.attr({x:g,y:y}),s.attr({x1:t,y1:e,x2:t,y2:p.y-30+f}),i.rotate(a,t,e).commit(),n.rotate(a,t,e).commit(),s.rotate(a,t,e).commit(),n=p=i=s=o=null},destroy:function(){var t,e;for(t in this.components)(e=this[t]())&&(e.remove(),this.components[t]=e=null)}})}(),function(){Graph.plugin.Collector=Graph.extend(Graph.plugin.Plugin,{props:{enabled:!1,suspended:!0,rendered:!1,activator:"tool",ready:!1},paper:null,collection:[],components:{rubber:null},collecting:{enabled:!1},constructor:function(t){var e=this;if(!t.isPaper())throw Graph.error("Collector tool only available for paper !");e.paper=t,e.components.rubber=Graph.$('<div class="graph-rubberband">'),e.collection=new Graph.collection.Vector,t.on("keynavdown",_.bind(e.onKeynavDown,e)),t.on("keynavup",_.bind(e.onKeynavUp,e)),e.paper.props.rendered?e.setup():e.paper.on("render",function(){e.setup()})},enable:function(t){this.props.enabled=!0,this.props.activator=t,this.paper.cursor("crosshair"),this.paper.state("collecting")},disable:function(){this.props.enabled=!1,this.paper.cursor("default")},setup:function(){var t=this;if(!t.props.ready){t.props.ready=!0;var e=t.collecting,r=t.paper,n=r.layout(),i=n.position(),o=t.components.rubber,s=r.interactable().vendor();s.styleCursor(!1),s.draggable({manualStart:!0,onstart:function(t){n.invalidate(),i=n.position();var r={x:t.clientX-i.left,y:t.clientY-i.top};_.assign(e,{enabled:!0,start:{
x:r.x,y:r.y},end:{x:r.x,y:r.y},bounds:{}}),o.query.css({width:0,height:0,transform:"translate("+e.start.x+"px, "+e.start.y+"px)"})},onmove:function(t){var r,n=e.start,s={x:t.clientX-i.left,y:t.clientY-i.top},a={x:s.x,y:s.y};r=n.x<=a.x&&n.y<a.y||n.x<a.x&&n.y<=a.y?{x:n.x,y:n.y,width:a.x-n.x,height:a.y-n.y}:n.x>=a.x&&n.y<a.y||n.x>a.x&&n.y<=a.y?{x:a.x,y:n.y,width:n.x-a.x,height:a.y-n.y}:n.x<=a.x&&n.y>a.y||n.x<a.x&&n.y>=a.y?{x:n.x,y:a.y,width:a.x-n.x,height:n.y-a.y}:n.x>=a.x&&n.y>a.y||n.x>a.x&&n.y>=a.y?{x:a.x,y:a.y,width:n.x-a.x,height:n.y-a.y}:{x:a.x,y:a.y,width:0,height:0},e.bounds=r,o.query.css({width:r.width,height:r.height,transform:"translate("+r.x+"px,"+r.y+"px)"})},onend:function(){if(e.enabled){e.enabled=!1;var o=r.guid(),s=Graph.registry.vector.collect(o),a=e.bounds,p=n.pointerLocation({clientX:a.x+i.left,clientY:a.y+i.top}),h=n.pointerLocation({clientX:a.x+i.left+a.width,clientY:a.y+i.top+a.height}),c=new Graph.lang.BBox({x:p.x,y:p.y,x2:h.x,y2:h.y,width:h.x-p.x,height:h.y-p.y});c.transform(r.viewport().matrix()),_.forEach(s,function(e){e.guid()!=o&&e.isSelectable()&&!e.isGroup()&&c.contains(e)&&t.collect(e,!0)}),"tool"==t.props.activator&&r.tool().activate("panzoom"),c=null,t.suspend()}}}).on("down",function(e){var r,n,i;r=Graph.event.target(e),n=!(e.ctrlKey||e.shiftKey),(i=Graph.registry.vector.get(r))&&(i.isSelectable()||i.elem.belong("graph-resizer")||i.elem.belong("graph-link")||i.elem.belong("graph-rotator")||n&&t.clearCollection())}).on("tap",function(e){var r,n,i;if(r=Graph.event.target(e),n=Graph.registry.vector.get(r),i=!(e.ctrlKey||e.shiftKey),n&&n.isSelectable()){if("linking"==n.paper().state())return void t.clearCollection();i&&t.clearCollection(),t.collect(n)}},!0).on("move",function(e){var n=e.interaction;if(t.props.enabled&&n.pointerIsDown&&!n.interacting()){var i={name:"drag"};n.prepared.name=i.name,n.setEventXY(n.startCoords,n.pointers),e.currentTarget===r.node()&&(t.props.suspended&&t.resume(),n.start(i,e.interactable,o.node()))}})}},render:function(){var t=this;t.props.rendered||(t.paper.container().append(t.components.rubber),t.props.rendered=!0)},size:function(){return this.collection.size()},index:function(t){return this.collection.index(t)},add:function(t){var e=this.index(t);t._collector=this,-1===e&&this.collection.push(t)},remove:function(t){delete t._collector,this.collection.pull(t)},collect:function(t){t.select(),Graph.cached.paper=this.paper.guid()},decollect:function(t){t.deselect()},clearCollection:function(){var t=this,e=t.collection.toArray().slice();_.forEach(e,function(e){t.decollect(e)}),e=null},suspend:function(){this.props.suspended=!0,this.components.rubber.detach()},resume:function(){this.props.suspended&&(this.props.suspended=!1,this.props.rendered?this.paper.container().append(this.components.rubber):this.render())},syncBeforeDrag:function(t,e){var r=this;r.collection.each(function(r){r.plugins.dragger&&r.plugins.dragger.props.enabled&&r!==t&&function(){
var t=r.matrixCurrent().rotate(),n=t.rad,i=Math.sin(n),o=Math.cos(n);r.plugins.resizer&&!r.plugins.resizer.props.suspended&&r.plugins.resizer.suspend(),r.plugins.rotator&&!r.plugins.rotator.props.suspended&&r.plugins.rotator.suspend(),r.plugins.dragger.props.ghost&&r.plugins.dragger.resume(),r.syncdrag={sin:i,cos:o,tdx:0,tdy:0},r.addClass("dragging"),r.fire("beforedrag",{dx:e.dx*o+e.dy*i,dy:e.dx*-i+e.dy*o,master:!1})}()}),r.fire("beforedrag")},syncDrag:function(t,e){this.collection.each(function(r){r.plugins.dragger&&r.plugins.dragger.props.enabled&&r!==t&&function(t,e){var r=e.tx*t.syncdrag.cos+e.ty*t.syncdrag.sin,n=e.tx*-t.syncdrag.sin+e.ty*t.syncdrag.cos;t.plugins.dragger.props.ghost?t.plugins.dragger.helper().translate(r,n).commit():t.translate(r,n).commit(),t.syncdrag.tdx+=r,t.syncdrag.tdy+=n,t.fire("drag",{dx:r,dy:n,master:!1})}(r,e)})},syncAfterDrag:function(t,e){var r=this;r.collection.each(function(e){e.plugins.dragger&&e.plugins.dragger.props.enabled&&e!==t&&function(t,e){var r=t.plugins.dragger.props.batchSync;t.plugins.dragger.props.ghost&&(r&&t.translate(t.syncdrag.tdx,t.syncdrag.tdy).commit(),t.plugins.dragger.suspend()),r||t.dirty(!0),t.fire("afterdrag",{dx:t.syncdrag.tdx,dy:t.syncdrag.tdy,batch:!0,master:!1}),t.removeClass("dragging"),delete t.syncdrag}(e)}),e.type="afterdrag",r.fire(e)},toString:function(){return"Graph.plugin.Collector"},onKeynavDown:function(t){if(t.keyCode==Graph.event.SHIFT&&"key"!=this.props.activator){var e=this.paper.tool();"collector"!=e.current()&&e.activate("collector","key")}},onKeynavUp:function(t){if(t.keyCode==Graph.event.SHIFT){var e=this.paper.tool();"collector"==e.current()&&(this.props.activator="tool",e.activate("panzoom"))}}})}(),function(){Graph.plugin.Dragger=Graph.extend(Graph.plugin.Plugin,{props:{ready:!1,manual:!1,ghost:!0,vector:null,enabled:!0,rendered:!1,suspended:!0,inertia:!1,bound:!1,grid:null,axis:!1,cursor:"move",cls:"",batchSync:!0,restriction:!1},rotation:{deg:0,rad:0,sin:0,cos:1},scaling:{x:1,y:1},dragging:{enabled:!1,vector:null,paper:null,helper:null,dx:0,dy:0,coord:null},components:{holder:null,helper:null},constructor:function(t,e){var r=this;t.addClass("graph-draggable"),r.props.vector=t.guid(),e=_.extend({inertia:!1},e||{}),_.forEach(["axis","grid","bbox","ghost"],function(t){void 0!==e[t]&&(r.props[t]=e[t])}),_.assign(r.props,e),r.cached.snapping=null,r.cached.origin=null,r.initComponent(),t.on("render.dragger",_.bind(r.onVectorRender,r)),t.props.rendered&&r.setup()},holder:function(){return Graph.registry.vector.get(this.components.holder)},helper:function(){return Graph.registry.vector.get(this.components.helper)},initComponent:function(){var t,e,r=this,n=r.components;r.props.ghost?(t=(new Graph.svg.Group).addClass("graph-dragger").removeClass("graph-elem graph-elem-group").traversable(!1).selectable(!1),
e=new Graph.svg.Rect(0,0,0,0,0).addClass("graph-dragger-helper"+(this.props.cls?" ":"")+this.props.cls).removeClass("graph-elem graph-elem-rect").traversable(!1).selectable(!1).clickable(!1).render(t),e.elem.data(Graph.string.ID_VECTOR,this.vector().guid()),n.holder=t.guid(),n.helper=e.guid(),t=null,e=null):this.props.cls&&this.vector().addClass(this.props.cls)},setup:function(){var t,e,r,n;this.props.ready||(t=this,e=t.vector(),e.paper(),n={},_.extend(n,{manualStart:!0,onstart:_.bind(t.onDragStart,t),onmove:_.bind(t.onDragMove,t),onend:_.bind(t.onDragEnd,t)}),r=e.interactable().vendor(),r.draggable(n),r.styleCursor(!1),t.cached.origin=r.origin(),t.cached.snapping=[],r.on("down",_.bind(t.onPointerDown,t)),t.props.grid&&t.snap({mode:"grid",x:t.props.grid[0],y:t.props.grid[1]}),t.props.ready=!0)},enable:function(){this.props.enabled=!0},disable:function(){this.props.enabled=!1},ghost:function(t){return void 0===t?this.props.ghost:(this.props.ghost=t,this)},render:function(){this.props.ghost&&(this.props.rendered||(this.props.rendered=!0,this.holder().render(this.vector().parent()),this.redraw()))},suspend:function(){this.props.ghost&&(this.props.suspended=!0,this.holder().elem.detach())},resume:function(){this.props.ghost&&(this.props.suspended=!1,this.props.rendered?(this.vector().parent().elem.append(this.holder().elem),this.redraw()):this.render())},redraw:function(){if(this.props.ghost){var t,e,r=this.vector(),n=this.helper(),i=r.matrix(),o=i.rotate().deg,s=r.bbox().toJson();if(o){var a=Graph.matrix(),p=r.shapeRelative();t=s.x+s.width/2,e=s.y+s.height/2,a.rotate(-o,t,e),p=p.transform(a),s=p.bbox().toJson()}n.reset(),n.attr({x:s.x,y:s.y,width:s.width,height:s.height}),o&&n.rotate(o,t,e).commit()}},origin:function(t){if(void 0===t)return this.cached.origin;this.cached.origin=t;var e=this.vector().interactable().vendor();e&&e.origin(t)},snap:function(t,e){function r(t){return _.isFunction(t)?t:(t.mode=_.defaultTo(t.mode,"anchor"),"grid"==t.mode?("x"==n.props.axis?t.y=0:"y"==n.props.axis&&(t.x=0),t=interact.createSnapGrid({x:t.x,y:t.y})):t.range=_.defaultTo(t.range,20),t)}if(void 0===t)return this.cached.snapping;void 0===e&&(e=!1);var n=this,i=[];this.cached.snapping=t,_.isArray(t)?_.forEach(t,function(t){i.push(r(t))}):i.push(r(t));var o=this.vector().interactable().vendor();o&&o.setOptions("snap",{targets:i,endOnly:e})},resetSnap:function(){this.snaps=[],this.snap({mode:"grid",x:this.props.grid[0],y:this.props.grid[1]})},restrict:function(t){this.props.restriction=t},start:function(){var t=this,e=t.vector(),r=e.interactable().vendor();t.props.manual||t.dragging.enabled||(t.dragging.enabled=!0,t.dragging.moveHandler=_.bind(t.onPointerMove,t,_,e),r.on("move",t.dragging.moveHandler))},onVectorRender:function(){this.setup()},onPointerDown:function(t){t.preventDefault(),this.start()},onPointerMove:function(t,e){var r=t.interaction;if(this.props.enabled&&r.pointerIsDown&&!r.interacting()){var n=e.paper(),i=e.node(),o={name:"drag"}
;if(r.prepared.name=o.name,r.setEventXY(r.startCoords,r.pointers),t.currentTarget===i){if(n){var s=n.state();if("collecting"==s){if(!e.elem.belong("graph-resizer"))return;n.tool().activate("panzoom")}else if("linking"==s)return}this.props.ghost?(this.props.suspended&&this.resume(),r.start(o,t.interactable,this.helper().node())):r.start(o,t.interactable,i)}}t.preventDefault()},onDragStart:function(t){var e=this.vector(),r=e.paper(),n=r.layout(),i=this.helper();e.addClass("dragging"),r.cursor(this.props.cursor),this.dragging.vector=e,this.dragging.paper=r,this.dragging.helper=i,this.dragging.dx=0,this.dragging.dy=0,this.dragging.tx=0,this.dragging.ty=0;var o=e.matrixCurrent(),s=o.rotate(),a=o.scale();this.dragging.deg=s.deg,this.dragging.rad=s.rad,this.dragging.sin=Math.sin(s.rad),this.dragging.cos=Math.cos(s.rad),this.dragging.sx=a.x,this.dragging.sy=a.y;var p={x:t.clientX,y:t.clientY,dx:0,dy:0,ghost:this.props.ghost};this.fire("beforedrag",p);var h=n.pointerLocation(t);this.dragging.coord=h},onDragMove:function(t){var e,r,n,i,o=this.dragging,s=(o.paper,o.vector),a=o.helper,p=this.props.ghost,h=this.props.axis,c=(o.deg,o.sin),l=o.cos,u=o.sx,d=o.sy,f=_.defaultTo(t.dx,0),g=_.defaultTo(t.dy,0);e=r=n=i=0,f/=u,g/=d,"x"==h?(e=f,r=0,n=f*l+0*c,i=f*-c+0*l):"y"==h?(e=0,r=g,n=0*l+g*c,i=0*-c+g*l):(e=n=f*l+g*c,r=i=f*-c+g*l);var y=this.props.restriction;if(y){var v=this.dragging.coord;v.x+=e,v.y+=r,(v.x<y.left||v.x>y.right)&&(e=n=f=0),(v.y<y.top||v.y>y.bottom)&&(r=i=g=0)}this.dragging.dx+=n,this.dragging.dy+=i,this.dragging.tx+=f,this.dragging.ty+=g;var m=_.defaultTo(t.pageX,t.x0),m=_.defaultTo(t.pageY,t.y0);m/=u,m/=d;var x={pageX:m,pageY:m,tx:f,ty:g,dx:e,dy:r,ghost:this.props.ghost};this.fire("drag",x),p?a.translate(x.dx,x.dy).commit():s.translate(x.dx,x.dy).commit()},onDragEnd:function(t){var e=this.dragging,r=e.paper,n=e.vector,i=(e.helper,this.props.ghost),o=e.dx,s=e.dy,a=e.tx,p=e.ty;i&&(n.translate(o,s).commit(),this.redraw(),this.suspend()),n.removeClass("dragging"),r.cursor("default");var h={dx:o,dy:s,tx:a,ty:p,ghost:this.props.ghost};n.interactable().vendor().off("move",this.dragging.moveHandler),this.dragging.moveHandler=null,this.dragging.enabled=!1,this.fire("afterdrag",h);for(var c in this.dragging)this.dragging[c]=null},destroy:function(){var t=this;t.components.helper&&t.helper().remove(),t.components.helper=null,t.components.holder&&t.holder().remove(),t.components.holder=null,t.listeners={}},toString:function(){return"Graph.plugin.Dragger"}})}(),function(){Graph.plugin.Dropper=Graph.extend(Graph.plugin.Plugin,{props:{overlap:"center",accept:".graph-draggable"},constructor:function(t,e){var r=this;_.assign(r.props,e||{}),t.addClass("graph-dropzone").removeClass("graph-draggable"),r.props.vector=t.guid(),t.on({render:_.bind(r.onVectorRender,r)}),t.props.rendered&&r.setup()},setup:function(){var t=this;if(!t.plugin){var e=_.extend({},t.props,{checker:_.bind(t.onDropValidate,t),ondropactivate:_.bind(t.onDropActivate,t),
ondropdeactivate:_.bind(t.onDropDeactivate,t),ondragenter:_.bind(t.onDragEnter,t),ondragleave:_.bind(t.onDragLeave,t),ondrop:_.bind(t.onDrop,t)});t.plugin=t.vector.interactable().dropzone(e)}},onDropValidate:function(t,e,r,n,i,o,s){return r},onVectorRender:function(){this.setup()},onDropActivate:function(t){this.vector().addClass("drop-activate")},onDropDeactivate:function(t){this.vector().removeClass("drop-activate")},onDragEnter:function(t){this.vector().removeClass("drop-activate").addClass("drop-enter"),t.type="dropenter",this.fire(t)},onDragLeave:function(t){this.vector().removeClass("drop-enter").addClass("drop-activate"),t.type="dropleave",this.fire(t)},onDrop:function(t){this.vector().removeClass("drop-activate drop-enter")}})}(),function(){Graph.plugin.Network=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,wiring:"h:h",tuning:!0,limitIncoming:0,limitOutgoing:0},linking:{valid:!1,router:null,source:null,target:null,link:null,pole:null},constructor:function(t,e){var r=this,n=t.guid();e=e||{},_.assign(r.props,e),r.props.vector=n,r.cached.cables={},r.cached.pairs={},t.addClass("graph-connectable"),t.interactable().vendor().dropzone({accept:_.format(".{0}, .{1}",Graph.styles.LINK_HEAD,Graph.styles.LINK_TAIL),overlap:.2}).on("dropdeactivate",function(t){var e=Graph.event.target(t),n=Graph.registry.vector.get(e);n&&n.removeClass("connect-valid connect-invalid connect-hover"),r.invalidateTrans()}).on("dropactivate",function(t){var e=Graph.event.target(t),n=Graph.registry.vector.get(e);n&&n.addClass("connect-hover"),r.invalidateTrans()}).on("dragenter",function(e){var n=Graph.registry.link.get(e.relatedTarget);if(n){var i,o,s,a=Graph.$(e.relatedTarget).data("pole");"head"==a?(o=n.router.source(),s=t):(o=t,s=n.router.target()),i=o.connectable().canConnect(s.connectable(),n),i?(t.removeClass("connect-invalid"),t.addClass("connect-valid")):(t.removeClass("connect-valid"),t.addClass("connect-invalid")),_.assign(r.linking,{valid:i,router:n.router,source:o,target:s,pole:a}),n.router.updateTrans("CONNECT",{valid:i,source:o,target:s})}}).on("dragleave",function(t){var e=Graph.event.target(t),n=Graph.registry.vector.get(e);n&&n.removeClass("connect-valid connect-invalid"),r.linking.valid=!1,"head"==r.linking.pole?r.linking.router.updateTrans("CONNECT",{valid:!1,target:null}):r.linking.router.updateTrans("CONNECT",{valid:!1,source:null})}).on("drop",function(e){var n=Graph.registry.link.get(e.relatedTarget);if(r.linking.valid)if("head"==r.linking.pole){var i=r.linking.router.target();i&&i.guid()!=t.guid()&&i.connectable().removeLink(n),r.linking.router.updateTrans("CONNECT",{target:t})}else{var o=r.linking.router.source();o&&o.guid()!=t.guid()&&o.connectable().removeLink(n),r.linking.router.updateTrans("CONNECT",{source:t})}})},invalidateTrans:function(){for(var t in this.linking)this.linking[t]=null},wiring:function(){return this.props.wiring},treshold:function(){switch(this.props.wiring){case"h:h":case"v:v":return 20;case"h:v":case"v:h":return-10}
return 0},direction:function(t){if(!this.props.tuning)return this.props.wiring;switch(this.orientation(t)){case"intersect":return null;case"top":case"bottom":return"v:v";case"left":case"right":return"h:h";default:return this.props.wiring}},orientation:function(t){var e=this.vector().bboxOriginal().toJson(),r=t.vector().bboxOriginal().toJson(),n=Graph.util.boxOrientation(e,r,this.treshold());return e=r=null,n},isSource:function(t){return t.source().guid()==this.vector().guid()},isTarget:function(t){return t.target().guid()==this.vector().guid()},connect:function(t,e,r,n){if(this.canConnect(t)){e&&!r?(n=e,e=null,r=null):(e instanceof Graph.lang.Point&&(e=e.toJson()),r instanceof Graph.lang.Point&&(r=r.toJson())),n=n||{};var i=this,o=i.vector(),s=t.vector(),a=o.paper(),p=a.layout(),h=p.createRouter(o,s),c=p.createLink(h,n);return void 0!==n.command?c.connectByCommand(n.command):c.connect(e,r),c.render(a),c.cached.beforeDestroyHandler=_.bind(this.onLinkBeforeDestroy,this),c.on("beforedestroy",c.cached.beforeDestroyHandler),i.addLink(c,"outgoing",s),t.addLink(c,"incoming",o),o.fire("connect",{link:c}),c}return!1},connectByLinker:function(t,e,r,n){"orthogonal"==this.vector().paper().layout().routerType()?this.connect(t,null,null,n):this.connect(t,e,r,n)},disconnect:function(t,e){var r=this.connections(t),n=r.length,i=0,o=[];return void 0!==e&&(o=_.isArray(e)?_.map(e,function(t){return t&&t.guid()}):e?[e.guid()]:[]),_.forEach(r,function(t){o.length?_.indexOf(o,t.guid)>-1&&(t.link.disconnect(),i++,n--):(t.link.disconnect(),n--)}),o.length?i===o.length:0===n},addLink:function(t,e,r){var n=t.guid(),i=this.cached.cables,o=this.cached.pairs;r=r.guid(),o=o||{},o[r]=o[r]||[],-1===_.indexOf(o[r],n)&&o[r].push(n),i[n]={type:e,pair:r}},removeLink:function(t){var e;e=_.isString(t)?t:t.guid();var r=this.cached.cables[e];if(r&&this.cached.pairs[r.pair]){var n=_.indexOf(this.cached.pairs[r.pair],e);n>-1&&this.cached.pairs[r.pair].splice(n,1),this.cached.pairs[r.pair].length||delete this.cached.pairs[r.pair]}delete this.cached.cables[e],r=null},repairLinks:function(){console.log("called")},hasConnection:function(t){var e=this.connections(t);return!!e.length&&e},connections:function(t){var e=this,r=Graph.registry.link,n=this.props.vector,i=[];if(void 0!==t){var o=t.vector().guid();return this.cached.pairs[o]&&_.forEach(e.cached.pairs[o],function(t){var s=r.get(t),a=e.cached.cables[t];s&&a&&i.push({guid:t,link:s,type:a.type,source:"outgoing"==a.type?n:o,target:"outgoing"==a.type?o:n})}),i}var s=e.cached.cables;return _.forOwn(s,function(t,e){var o=r.get(e);o&&i.push({guid:e,link:o,type:t.type,source:"outgoing"==t.type?n:t.pair,target:"outgoing"==t.type?t.pair:n})}),i},canConnect:function(t){if(t instanceof Graph.plugin.Network){var e,r,n,i=this.vector().guid(),o=t.vector().guid();if(this.props.limitOutgoing>0&&(e=this.connections(),r=_.filter(e,function(t){return"outgoing"==t.type}),r.length+1>this.props.limitOutgoing))return!1
;if(t.props.limitIncoming>0&&(e=t.connections(),n=_.filter(e,function(t){return"incoming"==t.type}),n.length+1>t.props.limitIncoming))return!1;if(i!=o)return!0}return!1},destroy:function(){this.cached.cables=null,this.cached.pairs=null},toString:function(){return"Graph.plugin.Network"},onLinkBeforeDestroy:function(t){var e,r=t.link;(e=r.router.source())&&e.connectable().removeLink(r),(e=r.router.target())&&e.connectable().removeLink(r),r.off("beforedestroy",r.cached.beforeDestroyHandler),r.cached.beforeDestroyHandler=null}})}(),function(){Graph.plugin.History=Graph.extend(Graph.plugin.Plugin,{props:{limit:1,index:0},items:{},constructor:function(t){this.props.vector=t.guid()},save:function(t,e){var r,n=this.props.limit;r>n&&_.drop(this.items,r-n),this.items[t]=this.items[t]||[],(r=this.items[t].length)>n-1&&this.items[t].splice(0,r-n),this.items[t].push(e)},last:function(t){},go:function(){},back:function(){},next:function(){},clear:function(){}})}(),function(){function t(t,e){return Math.max(t.min,Math.min(t.max,e))}Graph.plugin.Panzoom=Graph.extend(Graph.plugin.Plugin,{props:{panEnabled:!1,zoomEnabled:!0,showToolbox:!0,vector:null},caching:{offset:{x:0,y:0}},scrolling:{steps:10},zooming:{scale:1,zoom:1,origin:null,range:{min:.2,max:4}},components:{toolbox:null},panning:{start:{x:0,y:0},moveHandler:null,stopHandler:null},constructor:function(t){var e,r,n,i=this;if(!t.isPaper())throw Graph.error("Panzoom only available for paper !");r=t.viewport(),n=Math.round(r.matrix().scale().x,1e3),e=t.interactable().vendor(),_.assign(i.props,{vector:t.guid()}),_.assign(i.zooming,{scale:n,zoom:n}),i.initComponent(t),e.on("wheel",_.bind(i.onMouseWheel,i,_,t,r)),e.on("down",_.bind(i.onPointerDown,i,_,t,r)),t.props.rendered?(i.revalidate(t),i.props.showToolbox&&i.components.toolbox.appendTo(t.container())):t.on("render",function(){i.revalidate(t),i.props.showToolbox&&i.components.toolbox.appendTo(t.container())}),e=null,t=null},initComponent:function(t){var e,r=this;r.props.showToolbox&&(t.container(),e=r.components.toolbox=Graph.$('<div class="graph-zoom-toolbox">'),e.html('<div><a data-tool="zoom-reset" href="javascript:void(0)" title="'+Graph._("Reset zoom")+'">'+Graph.icons.ZOOM_RESET+'</a><div class="splitter"></div><a data-tool="zoom-in" href="javascript:void(0)" title="'+Graph._("Zoom in")+'">'+Graph.icons.ZOOM_IN+'</a><div class="splitter"></div><a data-tool="zoom-out" href="javascript:void(0)" title="'+Graph._("Zoom out")+'">'+Graph.icons.ZOOM_OUT+"</a></div>"),e.on("click","[data-tool]",function(t){switch(t.preventDefault(),Graph.$(this).data("tool")){case"zoom-reset":r.zoomReset();break;case"zoom-in":r.zoomIn();break;case"zoom-out":r.zoomOut()}}))},revalidate:function(t){var e=t.node().getBoundingClientRect();this.caching.offset={x:e.left,y:e.top}},enable:function(){var t=this.vector();this.props.panEnabled=!0,this.props.zoomEnabled=!0,t.cursor("default"),t.state("panning")},disable:function(){this.props.panEnabled=!1},zoomReset:function(){
var t,e=this.vector().viewport();this.zooming.zoom=1,this.zooming.scale=1,e.reset(),t=Graph.matrix(),e.attr("transform",t.toValue()),e.graph.matrix=t},zoomIn:function(){var t=this.vector().paper(),e=t.viewport(),r=t.layout().center();this.zoom(t,e,.1875,r)},zoomOut:function(){var t=this.vector().paper(),e=t.viewport(),r=t.layout().center();this.zoom(t,e,-.1875,r)},zoom:function(e,r,n,i){var o=this.zooming.range,s=this.zooming.zoom,a=n>0?"in":"out",p=Math.pow(1+Math.abs(n),"in"==a?1:-1),h=t(o,s*p),c=r.matrix(),l=c.props.a,u=1/l*h,d=c.clone();this.onBeforeZoom(e),d.scale(u,u,i.x,i.y),r.attr("transform",d.toValue()),r.graph.matrix=d,this.zooming.zoom=h,this.zooming.scale=d.props.a,"panning"==e.state()&&e.cursor("in"==a?"zoom-in":"zoom-out"),this.onZoom(e)},scroll:function(t,e,r,n){var i=e.matrix().clone(),o=this.zooming.scale;this.onBeforeScroll(t),r/=o,n/=o,i.translate(r,n),e.attr("transform",i.toValue()),e.graph.matrix=i,this.zooming.origin&&(this.zooming.origin.x+=r,this.zooming.origin.y+=n),this.onScroll()},onMouseWheel:function(t,e,r){t=Graph.event.fix(t),t.preventDefault();var n,i,o,s,a=Graph.event.hasPrimaryModifier(t),p=Graph.event.hasSecondaryModifier(t),h=Graph.event.original(t);a||p?(n=Graph.isMac()?0===h.deltaMode?1.25:50:0===h.deltaMode?1:20,i={},p?(i.dx=n*(h.deltaX||h.deltaY),i.dy=0):(i.dx=0,i.dy=n*h.deltaY),this.scroll(e,r,i.dx,i.dy)):(n=0===h.deltaMode?.025:.5,s=this.caching.offset,o={x:h.clientX-s.x,y:h.clientY-s.y},this.zooming.origin=o,this.zoom(e,r,h.deltaY*n/-8,o))},onPointerDown:function(t,e,r,n){var i,o=Graph.$(Graph.event.target(t)),s=Graph.registry.vector.get(o),n=e.interactable().vendor(),a=e.tool().current();if(this.panning.moveHandler&&(n.off("move",this.panning.moveHandler),this.panning.moveHandler=null),this.panning.stopHandler&&(n.off("up",this.panning.stopHandler),this.panning.stopHandler=null),!(" collector pencil ".indexOf(a)>-1)&&s){if(s.isDraggable())return;if(t.button||t.ctrlKey||t.shiftKey||t.altKey)return;this.revalidate(e),i=this.caching.offset,this.panning.start={x:t.clientX-i.x,y:t.clientY-i.y},this.panning.moveHandler=_.bind(this.onPointerMove,this,_,e,r),this.panning.stopHandler=_.bind(this.onPointerStop,this,_,e,r),n.on("move",this.panning.moveHandler),n.on("up",this.panning.stopHandler)}},onPointerMove:function(t,e,r){var n=this.caching.offset,i=this.panning.start,o={x:t.clientX-n.x,y:t.clientY-n.y},s=o.x-i.x,a=o.y-i.y;Graph.util.hypo(s,a);this.scroll(e,r,s,a),this.panning.start={x:t.clientX-n.x,y:t.clientY-n.y},e.cursor("move"),t.preventDefault()},onPointerStop:function(t,e){var r,n=this,i=e.interactable().vendor();r=_.delay(function(){clearTimeout(r),r=null,i.off("move",n.panning.moveHandler),i.off("up",n.panning.stopHandler),n.panning.moveHandler=null,n.panning.stopHandler=null},0),e.cursor("default")},onBeforeZoom:_.debounce(function(t){Graph.topic.publish("paper:beforezoom",null,t)},300,{leading:!0,trailing:!1}),onZoom:_.debounce(function(t){"panning"==t.state()&&t.cursor("default")},300),
onBeforeScroll:_.debounce(function(t){Graph.topic.publish("paper:beforescroll",null,t)},300,{leading:!0,trailing:!1}),onScroll:_.debounce(function(){},300),toString:function(){return"Graph.plugin.Panzoom"}})}(),function(){Graph.plugin.Linker=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,enabled:!1,suspended:!0,rendered:!1},components:{block:null,pointer:null,path:null},linking:{treshold:10,enabled:!1,moveHandler:null,stopHandler:null,source:null,start:null,target:null,end:null,visits:[]},constructor:function(t){var e,r=this;if(!t.isPaper())throw Graph.error("Linker plugin is only available for paper !");e=t.interactable().vendor(),e.on("down",_.bind(r.onPointerDown,r,_,t)),t.on("keynavdown",function(e){e.keyCode===Graph.event.ESC&&(r.invalidate(),t.tool().activate("panzoom"))}),r.props.vector=t.guid(),r.initComponent()},initComponent:function(){var t,e,r,n=this,i=n.components;t=(new Graph.svg.Group).addClass("graph-linker-path").selectable(!1),e=(new Graph.svg.Circle).addClass("graph-linker-pointer").removeClass(Graph.styles.VECTOR).selectable(!1).render(t),r=(new Graph.svg.Path).addClass("graph-linker-path").removeClass(Graph.styles.VECTOR).selectable(!1).render(t).attr("marker-end","url(#marker-link-end)"),i.block=t.guid(),i.pointer=e.guid(),i.path=r.guid()},component:function(t){return void 0===t?Graph.registry.vector.get(this.components.block):Graph.registry.vector.get(this.components[t])},render:function(){var t;this.props.rendered||(t=this.vector(),this.component().render(t),this.props.rendered=!0)},invalidate:function(){var t,e;this.linking.enabled&&(t=this.vector(),e=t.interactable().vendor(),this.linking.moveHandler&&(e.off("move",this.linking.moveHandler),this.linking.moveHandler=null),this.linking.source&&this.linking.source.removeClass("disallowed"),this.linking.target&&this.linking.target.removeClass("allowed"),_.assign(this.linking,{enabled:!1,moveHandler:null,stopHandler:null,source:null,start:null,target:null,end:null}),this.linking.visits&&_.forEach(this.linking.visits,function(t){t.removeClass("connect-valid connect-invalid")}),this.linking.visits=null)},enable:function(){var t=this.vector();this.props.enabled=!0,t.state("linking"),t.addClass("linking")},disable:function(){var t=this.vector();this.props.enabled=!1,this.invalidate(),this.suspend(),t.removeClass("linking")},suspend:function(){this.props.suspended=!0,this.component().elem.detach()},resume:function(){var t;this.props.suspended&&(t=this.vector(),this.props.suspended=!1,this.props.rendered?this.component().elem.appendTo(t.viewport().elem):this.render())},start:function(t,e){var r=this.vector(),n=r.layout();n.position();if("linker"==r.tool().current()){if(this.linking.enabled)return void(this.linking.source&&this.linking.target?this.build():(this.invalidate(),this.suspend()));if(t.isPaper())return this.invalidate(),this.suspend(),void r.tool().activate("panzoom");this.linking.visits=[];var i,o,s;if(t.isConnectable()){this.props.suspended&&this.resume()
;var a=this.component("path");this.linking.moveHandler=_.bind(this.onPointerMove,this,_,r,a),i=r.interactable().vendor(),i.on("move",this.linking.moveHandler),this.linking.visits.push(t),t.isConnectable()&&(this.linking.source||(o=t.bboxOriginal(),s=o.center(!0),this.linking.source=t,this.linking.start=s,e?a.moveTo(s.x,s.y).lineTo(e.x,e.y,!1):a.moveTo(s.x,s.y).lineTo(s.x,s.y,!1),o=s=null)),this.linking.enabled=!0}}},cropping:function(t,e){var r,n,i,o,s=this.linking.source,a=this.linking.target,p=new Graph.lang.Path([["M",t.x,t.y],["L",e.x,e.y]]);return s&&(r=s.shapeView(),n=r.intersection(p,!0)),a&&(i=a.shapeView(),o=i.intersection(p,!0)),p=r=i=null,{start:n?n[0]:null,end:o?o[0]:null}},build:function(){var t=this.component("path"),e=t.tail(),r=t.head();if(e&&r){var n=this.linking.source.connectable(),i=this.linking.target.connectable();n.connectByLinker(i,e,r)}this.invalidate(),this.suspend()},onPointerDown:function(t,e){var r=e.layout(),n=r.grabVector(t);n&&this.start(n),r=n=null},onPointerMove:function(t,e,r){if(this.linking.enabled){var n=e.layout(),i=n.grabVector(t);if(!i)return;var o=this.linking.source,s=!1;if(o){-1===this.linking.visits.indexOf(i.guid())&&this.linking.visits.push(i);var a=this.linking.start,p=n.pointerLocation(t),h=p.x,c=p.y,l=Graph.util.rad(Graph.util.theta(a,{x:h,y:c})),u=Math.sin(l),d=Math.cos(l),f=this.linking.treshold*-d,g=this.linking.treshold*u;if(h+=f,c+=g,i.isConnectable()){var y,v,m;o.connectable().canConnect(i.connectable())?(s=!0,i.removeClass("connect-invalid"),i.addClass("connect-valid"),v=i.bboxOriginal(),m=v.center(!0),this.linking.target=i,this.linking.end=m,y=this.cropping(a,m),y.start&&r.moveTo(y.start.x,y.start.y),y.end?r.lineTo(y.end.x,y.end.y,!1):r.lineTo(h,c,!1),v=m=null):(i.removeClass("connect-valid"),i.addClass("connect-invalid"))}else i.addClass("connect-invalid");s||(this.linking.target&&this.linking.target.removeClass("connect-valid connect-invalid"),this.linking.target=null,this.linking.end=null,y=this.cropping(a,{x:h,y:c}),y.start&&r.moveTo(y.start.x,y.start.y),y.end?r.lineTo(y.end.x,y.end.y,!1):r.lineTo(h,c,!1))}}t.preventDefault()},toString:function(){return"Graph.plugin.Linker"}})}(),function(){Graph.plugin.ToolManager=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,current:null},tools:{},constructor:function(t){this.props.vector=t.guid()},has:function(t){return!!this.tools[t]},get:function(t){var e=this.tools[t],r=this.vector();if(e)switch(e.type){case"plugin":return r.plugins[t];case"util":return r.utils[t]}return null},current:function(){return this.props.current},register:function(t,e){e=_.defaultTo(e,"plugin"),this.tools[t]={name:t,type:e,enabled:!1}},unregister:function(t){this.tools[t]&&delete this.tools[t]},activate:function(t,e){if(this.props.current!=t){var r,n=this.get(t);n&&(this.deactivateAll(t),this.props.current=t,r=this.tools[t],r.enabled=!0,e=_.defaultTo(e,"tool"),n.enable(e),this.fire("activate",{name:r.name,enabled:r.enabled}))}},deactivate:function(t){
var e,r=this.get(t);r&&(e=this.tools[t],e.enabled=!1,this.props.current=null,r.disable(),this.fire("deactivate",{name:e.name,enabled:e.enabled}))},deactivateAll:function(t){this.vector();for(var e in this.tools)e!=t&&this.deactivate(e)},toggle:function(t){var e=this.tools[t];e&&(e.enabled?this.deactivate(t):this.activate(t))},toString:function(){return"Graph.plugin.ToolManager"}})}(),function(){Graph.plugin.Pencil=Graph.extend(Graph.plugin.Plugin,{writing:{startHandler:null},constructor:function(t){this.props.vector=t.guid()},enable:function(t){this.props.enabled=!0,this.props.activator=t;var e=this.vector(),r=e.interactable().vendor();e.cursor("text"),e.state("writing"),this.writing.startHandler=_.bind(this.onPointerDown,this),r.on("down",this.writing.startHandler)},disable:function(){this.props.enabled=!1,this.vector().interactable().vendor().off("down",this.writing.startHandler),this.writing.startHandler=null},toString:function(){return"Graph.plugin.Pencil"},onPointerDown:function(t){var e=this.vector();if(e.isPaper()){var r,n,i;if(r=e.layout().pointerLocation(t),n={left:r.x,top:r.y},e.diagram().current()||e.diagram().create(),i=e.diagram().current().drawShape("Graph.shape.common.Label",n),i.shape)var o=_.delay(function(t){clearTimeout(o),o=null,e.tool().activate("panzoom"),i.shape.editable().plugin().startEdit()},10)}}})}(),function(){Graph.plugin.Editor=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,rendered:!1,suspended:!0,width:"auto",height:"auto",offset:"auto",align:"center"},editing:{commitHandler:null},components:{editor:null},constructor:function(t,e){var r;_.assign(this.props,e||{}),this.props.vector=t.guid(),_.assign(this.cached,{left:0,top:0,width:0,height:0}),r=t.interactable().vendor(),r.on("doubletap",_.bind(this.onDoubleTap,this)),this.initComponent()},initComponent:function(){var t=this,e=this.components;e.editor=Graph.$('<div class="graph-editor" contenteditable="true"></div>'),e.editor.css("text-align",this.props.align),e.editor.on("keydown",function(e){switch(e.keyCode){case Graph.event.ENTER:t.commit();break;case Graph.event.DELETE:case Graph.event.SHIFT:e.stopPropagation()}})},commit:function(){var t=this.components.editor.text();this.suspend(),this.vector().props.text=t,this.fire("edit",{text:t,left:this.cached.left,top:this.cached.top})},render:function(){if(this.props.rendered)return void this.redraw();this.vector().paper().container().append(this.components.editor),this.props.rendered=!0,this.redraw()},suspend:function(){this.props.suspended=!0,this.components.editor.detach(),this.editing.commitHandler&&(Graph.topic.unsubscribe("paper:beforezoom",this.editing.commitHandler),Graph.topic.unsubscribe("paper:beforescroll",this.editing.commitHandler),Graph.topic.unsubscribe("vector:pointerdown",this.editing.commitHandler),this.editing.commitHandler=null)},resume:function(){var t;this.props.rendered?(this.props.suspended&&(this.props.suspended=!1,t=this.vector().paper().container(),t.append(this.components.editor)),
this.redraw()):this.render()},redraw:function(){var t,e,r,n,i=this.components.editor,o=this.vector(),s=o.matrixCurrent(),a=s.scale(),p=o.bbox().clone().transform(s).toJson();r=p.width,n=p.height,t=p.x,e=p.y,"auto"!=this.props.width?(r=Math.max(this.props.width,150),r=Math.max(r*a.x,r),t=p.x):(r-=8*a.x,t+=4*a.x),"auto"!=this.props.height?(n=Math.max(this.props.height,50),n=Math.max(n*a.y,n),e=p.y):(n-=8*a.y,e+=4*a.y),i.css({left:t,top:e,width:r,height:n}),_.assign(this.cached,{left:t,top:e,width:r,height:n}),i.text(o.props.text||""),i.focus(),p=null},startEdit:function(t){var e=this,r=e.vector();if(r.deselect(),r.paper()&&"linker"==r.paper().tool().current()&&r.paper().tool().activate("panzoom"),e.fire("beforeedit"),e.resume(),t&&"pointer"==this.props.offset){var n,i,o,s=e.components.editor,a=r.paper(),p=a.layout();p.scale();a&&(n=a.position(),i=p.pointerLocation(t),"center"==this.props.align?(o={x:t.clientX-n.left,y:t.clientY-n.top},s.css({left:o.x-s.width()/2,top:o.y-s.height()/2})):(o=r.bboxView().toJson(),o=p.screenLocation({x:o.x,y:o.y}),s.css({left:o.x-n.left,top:o.y-n.top})),s.focus(!0),e.cached.left=i.x,e.cached.top=i.y)}e.editing.commitHandler||(e.editing.commitHandler=function(){e.commit()},Graph.topic.subscribe("paper:beforezoom",e.editing.commitHandler),Graph.topic.subscribe("paper:beforescroll",e.editing.commitHandler),Graph.topic.subscribe("vector:pointerdown",e.editing.commitHandler))},onDoubleTap:function(t){this.startEdit(t),t.preventDefault()},destroy:function(){this.editing.commitHandler&&(Graph.topic.unsubscribe("paper:beforezoom",this.editing.commitHandler),Graph.topic.unsubscribe("paper:beforescroll",this.editing.commitHandler),Graph.topic.unsubscribe("vector:pointerdown",this.editing.commitHandler),this.editing.commitHandler=null)},toString:function(){return"Graph.plugin.Editor"}})}(),function(){function t(t,e,r){r=_.defaultTo(r,10);for(var n=e.length;n--;)if(Math.abs(e[n]-t)<=r)return{snapped:!0,value:e[n]};return{snapped:!1,value:t}}Graph.plugin.Snapper=Graph.extend(Graph.plugin.Plugin,{props:{enabled:!0,suspended:!0,rendered:!1,vector:null},clients:{},components:{block:null,stubx:null,stuby:null},snapping:{coords:null,vector:null,offset:null,stubx:null,stuby:null},constructor:function(t,e){if(e=e||{},!t.isPaper())throw Graph.error("Snapper plugin only available for paper");_.assign(this.props,e),this.props.vector=t.guid(),this.initComponent(t),this.snapping.coords={}},invalidate:function(){for(var t in this.snapping)this.snapping[t]=null;this.snapping.coords={},this.clients={}},initComponent:function(t){var e,r,n;e=(new Graph.svg.Group).selectable(!1).clickable(!1).addClass("graph-snapper"),r=new Graph.svg.Path("M 0 0 L 0 0").removeClass(Graph.styles.VECTOR).selectable(!1).clickable(!1).render(e),n=new Graph.svg.Path("M 0 0 L 0 0").removeClass(Graph.styles.VECTOR).clickable(!1).selectable(!1).render(e),this.components.block=e.guid(),this.components.stuby=n.guid(),this.components.stubx=r.guid()},component:function(t){
return void 0===t?Graph.registry.vector.get(this.components.block):Graph.registry.vector.get(this.components[t])},render:function(){this.props.rendered||(this.component().render(this.vector()),this.props.rendered=!0)},enable:function(){this.props.enabled=!0},disable:function(){this.props.enabled=!1},suspend:function(){this.props.suspended=!0,this.component().elem.detach()},resume:function(){if(this.props.suspended)if(this.props.suspended=!1,this.props.rendered){var t=this.component(),e=this.vector().viewport();t.elem.appendTo(e.elem)}else this.render()},refresh:function(t){if(this.props.enabled){var e,r,n,i;if(void 0!==t){var o=this.clients[t];o&&(this.snapping.coords[o.coords]&&delete this.snapping.coords[o.coords],(r=Graph.registry.vector.get(t))&&(n=this.getClientCenter(r),i=n.x+"_"+n.y,this.snapping.coords[i]=n,this.clients[t].coords=i))}else{this.snapping.coords={};for(e in this.clients)(r=Graph.registry.vector.get(e))&&(n=this.getClientCenter(r),i=n.x+"_"+n.y,this.snapping.coords[i]=n,this.clients[e].coords=i)}}},setup:function(t,e){if(this.props.enabled){var r,n=this,i=t.guid();if(n.clients[i]&&(t.off("beforedrag",n.clients[i].beforeDragHandler),t.off("afterdrag",n.clients[i].afterDragHandler),t.off("afterdestroy",n.clients[i].afterDestroyHandler),n.clients[i].coords&&delete n.snapping.coords[n.clients[i].coords],delete n.clients[i]),e.enabled){var o=t.draggable();n.clients[i]={coords:null,osnaps:o.snap(),beforeDragHandler:_.bind(n.onClientBeforeDrag,n,_,t),afterDragHandler:_.bind(n.onClientAfterDrag,n,_,t),afterDestroyHandler:_.bind(n.onClientAfterDestroy,n,_,t)},t.on("beforedrag",n.clients[i].beforeDragHandler),t.on("afterdrag",n.clients[i].afterDragHandler),t.on("afterdestroy",n.clients[i].afterDestroyHandler);var s=n.getClientCenter(t),a=this.snapping.coords;r=s.x+"_"+s.y,a[r]||(a[r]=s,n.clients[i].coords=r),r=null}}},repairClient:function(t){console.log(t)},getClientCenter:function(t){return t.bboxView().center(!0)},showStub:function(t,e){var r,n=this.snapping;"x"==t&&(r="M "+e+" -100000 L "+e+" 100000",n.stubx.attr("d",r),n.stubx.addClass("visible")),"y"==t&&(r="M -100000 "+e+" L 100000 "+e,n.stuby.attr("d",r),n.stuby.addClass("visible")),r=null},hideStub:function(t){var e="x"==t?"stubx":"stuby";this.snapping[e].removeClass("visible")},onClientBeforeDrag:function(e,r){if(this.props.enabled){var n=this,i=n.vector(),o=i.viewport(),s=i.layout(),a=s.position(),p=n.getClientCenter(r),h=this.snapping,c=h.coords;h.stubx=this.component("stubx"),h.stuby=this.component("stuby");var l=a.left,u=a.top,d=o.matrix(),f=s.pointerLocation({clientX:e.x,clientY:e.y}),g=p.x-f.x,y=p.y-f.y,v=[],m=[];_.forOwn(c,function(t){var e,r,n,i;e=d.x(t.x-g,t.y-y),r=d.y(t.x-g,t.y-y),n=e+l,-1===_.indexOf(v,n)&&v.push(n),i=r+u,-1===_.indexOf(m,i)&&m.push(i)}),r.draggable().snap([function(e,r){var i,o,a,p,h;return i=t(e,v),o=t(r,m),a=i.value,p=o.value,h=s.pointerLocation({clientX:a,clientY:p}),i.snapped?n.showStub("x",h.x+g):n.hideStub("x"),
o.snapped?n.showStub("y",h.y+y):n.hideStub("y"),{x:a,y:p}}]),n.resume()}},onClientAfterDrag:function(t,e){if(this.props.enabled){var r=this.snapping,n=this.clients[e.guid()];if(n){var i=e.draggable();n.osnaps&&i.snap(n.osnaps);var o,s;n.coords&&delete r.coords[n.coords],s=this.getClientCenter(e),o=s.x+"_"+s.y,r.coords[o]||(r.coords[o]=s,n.coords=o),o=null,s=null}this.suspend(),_.assign(this.snapping,{stubx:null,stuby:null})}},onClientAfterDestroy:function(t,e){var r=e.guid(),n=this.clients[r],i=this.snapping;n&&(n.coords&&i.coords[n.coords]&&delete i.coords[n.coords],delete this.clients[r])},toString:function(){return"Graph.plugin.Snapper"}})}(),function(){Graph.plugin.Toolpad=Graph.extend(Graph.plugin.Plugin,{props:{vector:null,rendered:!1,suspended:!0},components:{pad:null},constructor:function(t){this.props.vector=t.guid(),this.initComponent(t),this.cached.tools=null,this.cached.shape=null,this.cached.link=null,Graph.topic.subscribe("shape:select",_.bind(this.onShapeSelect,this)),Graph.topic.subscribe("shape:deselect",_.bind(this.onShapeDeselect,this)),Graph.topic.subscribe("link:select",_.bind(this.onLinkSelect,this)),Graph.topic.subscribe("link:deselect",_.bind(this.onLinkDeselect,this))},initComponent:function(t){var e='<div class="graph-toolpad"><div class="pad-body"></div></div>';e=Graph.$(e),e.on("click","[data-shape-tool]",_.bind(this.onShapeToolClick,this)),e.on("click","[data-link-tool]",_.bind(this.onLinkToolClick,this)),this.components.pad=e},render:function(){this.props.rendered||(this.components.pad.appendTo(this.vector().container()),this.props.rendered=!0)},suspend:function(){this.props.suspended=!0,this.components.pad.detach()},resume:function(){this.props.suspended&&(this.props.suspended=!1,this.props.rendered?this.components.pad.appendTo(this.vector().container()):this.render())},onShapeSelect:function(t){var e=t.shape,r=e.metadata,n=this.components.pad,i="";_.forEach(r.tools,function(t,e){t.enabled&&(e>0&&(i+='<div class="splitter"></div>'),i+='<a data-shape-tool="'+t.name+'" href="javascript:void(0)" title="'+t.title+'">'+t.icon+"</a>")}),n.find(".pad-body").html(i),this.cached.tools=r.tools,this.cached.shape=e,this.resume()},onShapeDeselect:function(t){this.suspend()},onLinkSelect:function(t){var e=t.link,r=e.metadata,n=this.components.pad,i="";_.forEach(r.tools,function(t,e){t.enabled&&(e>0&&(i+='<div class="splitter"></div>'),i+='<a data-link-tool="'+t.name+'" href="#" title="'+t.title+'">'+t.icon+"</a>")}),n.find(".pad-body").html(i),this.cached.tools=r.tools,this.cached.link=e,this.resume()},onLinkDeselect:function(t){this.suspend()},onShapeToolClick:function(t){var e=Graph.$(t.currentTarget),r=e.data("shapeTool"),n=_.find(this.cached.tools,function(t){return t.name==r});if(n)if("config"==n.name){var i=this.vector();i.fire("shapetoolclick",{shape:this.cached.shape})}else n.handler&&n.handler(t);t.preventDefault()},onLinkToolClick:function(t){
var e=Graph.$(t.currentTarget),r=e.data("linkTool"),n=_.find(this.cached.tools,function(t){return t.name==r});if(n)if("config"==n.name){var i=this.vector();i.fire("linktoolclick",{link:this.cached.link})}else n.handler&&n.handler(t);t.preventDefault()},toString:function(){return"Graph.plugin.Toolpad"}})}(),function(){Graph.plugin.Clipper=Graph.extend(Graph.plugin.Plugin,{props:{vector:null},constructor:function(t){var e=this,r=t.guid();e.props.vector=r,t.isPaper()&&(t.on("keycopy",function(t){e.copy()}),t.on("keypaste",function(t){e.paste()})),e.cached.clips=null,e.cached.paste=1},vector:function(){return Graph.registry.vector.get(this.props.vector)},invalidate:function(){this.cached.clips=null},cut:function(){},copy:function(){var t=this,e=this.vector(),r=e.collector().collection.toArray().slice();if(t.cached.paste=1,r.length){var n=[],i={guid:!0,id:!0};_.forEach(r,function(t){var e=Graph.registry.shape.get(t);if(e){var r,o,s=e.toJson(),a={};for(r in s.props)o=s.props[r],i[r]||(a[r]=o);n.push(a)}}),this.cached.clips=n}else this.cached.clips=null},paste:function(){var t=this,e=this.cached.clips,r=this.vector(),n=r.layout().scale(),i=r.collector();e&&e.length&&(i.clearCollection(),_.forEach(e,function(e){var i=_.cloneDeep(e);void 0!==i.left&&(i.left+=20*t.cached.paste/n.x),void 0!==i.top&&(i.top+=20*t.cached.paste/n.y);var o=Graph.factory(Graph.ns(e.type),[i]);o.render(r),o.select()}),t.cached.paste++)}})}(),function(){function t(e,r){var n,i=e.children().toArray();n=r.call(e,e),(n=_.defaultTo(n,!0))&&i.length&&_.forEach(i,function(e){t(e,r)})}var e=Graph.shape.Shape=Graph.extend({props:{id:null,guid:null,mode:null,left:0,top:0,width:0,height:0,rotate:0,label:"",alias:"",fill:"rgb(255, 255, 255)",stroke:"rgb(0, 0, 0)",strokeWidth:2,dataSource:null},params:[],components:{shape:null,block:null,label:null,child:null},layout:{suspended:!1},tree:{paper:null,parent:null,children:null},metadata:{type:null,icon:Graph.icons.SHAPE,style:"graph-shape",tools:null,params:[]},cached:{},plugins:{manager:null},constructor:function(t){var r;if(this.data(t||{}),r="graph-shape-"+ ++e.guid,this.props.guid=r,this.tree.children=new Graph.collection.Shape,this.plugins.manager=new Graph.plugin.Manager,this.initComponent(),this.initMetadata(),this.components.shape){var n=Graph.styles.SHAPE,i=this.component();this.metadata.style&&(n+=" "+this.metadata.style),i.addClass(n),i.attr("data-shape",r),n=null}Graph.registry.shape.register(this),r=null},data:function(t,e){if(void 0===t&&void 0===e)return this.props;var r,n,i={type:!0,client_id:!0,client_parent:!0,client_pool:!0,diagram_id:!0,parent_id:!0},o={stroke_width:"strokeWidth",data_source:"dataSource"};if(_.isPlainObject(t)){for(n in t)i[n]||(r=o[n]||n,"params"==n?this.params=t[n]:this.props[r]=t[n]);return this}return void 0===e?this.props[t]:(i[t]||(r=o[t]||t,"params"==t?this.params=e:this.props[r]=e),this)},update:function(t){t=t||{},t.props&&this.data(t.props)},redraw:function(t){var e;t=t||{},this.suspendLayout()
;for(e in t)void 0!==this[e]&&_.isFunction(this[e])&&this[e](t[e]);this.resumeLayout(),this.refresh()},is:function(t){return this.metadata.type==t},initMetadata:function(){this.metadata.tools=[{name:"config",icon:Graph.icons.CONFIG,title:Graph._("Click to config shape"),enabled:!0,handler:_.bind(this.onConfigToolClick,this)},{name:"link",icon:Graph.icons.LINK,title:Graph._("Click to start shape linking"),enabled:!0,handler:_.bind(this.onLinkToolClick,this)},{name:"sendtofront",icon:Graph.icons.SEND_TO_FRONT,title:Graph._("Send to front"),enabled:!0,handler:_.bind(this.onFrontToolClick,this)},{name:"sendtoback",icon:Graph.icons.SEND_TO_BACK,title:Graph._("Send to back"),enabled:!0,handler:_.bind(this.onBackToolClick,this)},{name:"trash",icon:Graph.icons.TRASH,title:Graph._("Click to remove shape"),enabled:!0,handler:_.bind(this.onTrashToolClick,this)}]},initComponent:function(){var t=new Graph.svg.Group;this.components.shape=t.guid(),t=null},component:function(t){var e=Graph.registry.vector;return void 0===t?e.get(this.components.shape):e.get(this.components[t])},invalidate:function(){for(var t in this.cached)this.cached[t]=null},connectable:function(){return this.plugins.manager.get("network")},resizable:function(){return this.plugins.manager.get("resizer")},draggable:function(){return this.plugins.manager.get("dragger")},snappable:function(){return this.plugins.manager.get("snapper")},editable:function(){return this.plugins.manager.get("editor")},paper:function(){return Graph.registry.vector.get(this.tree.paper)},parent:function(){return Graph.registry.shape.get(this.tree.parent)},children:function(){return this.tree.children},hasChild:function(t){return this.children().has(t)},addChild:function(t,e){var r=this.children(),n=this.component("child"),i=this.guid(),o=this;e=_.defaultTo(e,!0),_.isArray(t)||(t=[t]);_.bind(this.onChildBeforeDestroy,this);_.forEach(t,function(t){var s=t.parent();if(s&&s.guid()!=i&&s.removeChild(t),!r.has(t)){var a=t.component();e?a.relocate(n):n.append(a),t.cached.beforeDestroyHandler=_.bind(o.onChildBeforeDestroy,o),t.cached.afterDragHandler=_.bind(o.onChildAfterDrag,o),t.cached.connectHandler=_.bind(o.onChildConnect,o),t.on("beforedestroy",t.cached.beforeDestroyHandler),t.on("afterdrag",t.cached.afterDragHandler),t.on("connect",t.cached.connectHandler),r.push(t),t.tree.parent=i;var p=a.matrix();t.data({left:p.props.e,top:p.props.f})}}),e&&this.autoResize()},removeChild:function(t){var e=this.children();e.has(t)&&(e.pull(t),t.tree.parent=null)},guid:function(){return this.props.guid},matrix:function(){return this.component().matrix()},bbox:function(){return Graph.bbox({x:this.props.left,y:this.props.top,x2:this.props.left+this.props.width,y2:this.props.top+this.props.height,width:this.props.width,height:this.props.height})},render:function(t){var e=this.guid(),r=t.guid(),n=this.component();n&&n.render(t),this.tree.paper=r,Graph.registry.shape.setContext(e,r)},select:function(t){
var e=this.component("block"),r=this.paper();t=_.defaultTo(t,!1),t&&r&&r.collector().clearCollection(),e&&e.select()},deselect:function(){var t=this.component("block");t&&t.deselect()},remove:function(){this.component("block").remove()},refresh:_.debounce(function(){if(!this.layout.suspended){var t=this.component("label"),e=this.component("block"),r=e.bbox().toJson();t.attr({x:r.x+r.width/2,y:r.x+r.height/2}),t.wrap(r.width-10)}},1),autoResize:function(){},center:function(){var t=this.component().bboxView().toJson();return{x:(t.x+t.x2)/2,y:(t.y+t.y2)/2}},translate:function(t,e){var r=this.component();r.translate(t,e).commit();var n=r.matrix(),i=n.props.e,o=n.props.f;this.data({left:i,top:o});var s=this.component("child");s&&s.dirty(!0)},cascade:function(e){t(this,e)},sendToBack:function(){var t=this.parent(),e=t?t.component("child").elem:this.paper().viewport().elem;e&&e.prepend(this.component().elem)},sendToFront:function(){var t=this.parent(),e=t?t.component("child").elem:this.paper().viewport().elem;e&&e.append(this.component().elem)},suspendLayout:function(){this.layout.suspended=!0},resumeLayout:function(){this.layout.suspended=!1},attr:function(t,e){var r=this;return _.isPlainObject(t)?(_.forOwn(t,function(t,e){r.props[e]=t}),this):void 0===e?this.props[t]:(this.props[t]=e,this)},height:function(t){if(void 0===t)return this.props.height;var e=this.component("block"),r=e.bbox().toJson(),n=t/this.props.height,i=(r.x+r.x2)/2,o=r.y,s=e.resize(1,n,i,o,0,0);return e.fire("afterresize",s),this.props.height=t,this},width:function(t){if(void 0===t)return this.props.width;var e=this.component("block"),r=e.bbox().toJson(),n=t/this.props.width,i=r.x,o=(r.y+r.y2)/2,s=e.resize(n,1,i,o,0,0);return e.fire("afterresize",s),this.props.width=t,this},left:function(t){if(void 0===t)return this.props.left;var e=this.component(),r=e.matrix(),n=t-r.props.e;return e.translate(n,0).commit(),this.props.left=t,this},top:function(t){if(void 0===t)return this.props.top;var e=this.component(),r=e.matrix(),n=t-r.props.f;return e.translate(0,n).commit(),this.props.top=t,this},rotate:function(t){var e=this.component("block");if(e&&e.isRotatable()){var r=e.bbox().toJson();e.rotate(t,r.x,r.y).commit()}},label:function(t){if(void 0===t)return this.props.label;var e=this.component("block");this.component("label").props.text=t,e.data("text",t),this.props.label=t,this.refresh()},fill:function(t){if(void 0===t)return this.props.fill;this.props.fill=t,this.component("block").elem.css("fill",t)},stroke:function(t){if(void 0===t)return this.props.stroke;this.props.stroke=t,this.component("block").elem.css("stroke",t)},strokeWidth:function(t){if(void 0===t)return this.props.strokeWidth;this.props.strokeWidth=t,this.component("block").elem.css("stroke-width",t)},connect:function(t,e,r,n){var i=this.connectable().plugin(),o=t.connectable().plugin();return!(!i||!o)&&i.connect(o,e,r,n)},disconnect:function(t,e){var r=this.connectable().plugin(),n=t.connectable().plugin()
;return!(!r||!n)&&r.disconnect(n,e)},toJson:function(){var t=(this.component("block"),this.paper(),{metadata:{},props:{id:this.props.id,type:this.toString(),mode:this.props.mode,guid:this.props.guid,pool:null,parent:this.tree.parent,label:this.props.label,left:this.props.left,top:this.props.top,width:this.props.width,height:this.props.height,rotate:this.props.rotate,fill:this.props.fill,strokeWidth:this.props.strokeWidth,stroke:this.props.stroke,dataSource:this.props.dataSource},params:this.params,links:[]}),e=this.connectable().plugin();if(e){var r=e.connections();_.forEach(r,function(e){var r=e.link.toJson();t.links.push({guid:e.guid,mode:e.type,pair:"outgoing"==e.type?r.props.target:r.props.source})})}return t},onLabelEdit:function(t){this.label(t.text)},onBeforeDrag:function(t){this.fire(t),this.paper().diagram().capture()},onAfterDrag:function(t){var e,r=this.component("block"),n=this.component("shape"),i=this.component("child"),o=r.matrix();r.reset(),n.matrix().multiply(o),n.attr("transform",n.matrix().toValue()),n.dirty(!0),i&&i.dirty(!0),e=n.matrix(),this.data({left:e.props.e,top:e.props.f}),this.fire(t)},onAfterRotate:function(t){var e=this.component("shape"),r=this.component("block"),n=this.component("child"),i=e.matrix();i.multiply(r.matrix()),e.attr("transform",i.toValue()),e.dirty(!0),n&&n.dirty(!0),r.reset(),r.rotatable().redraw(),r.isResizable()&&!1===r.resizable().props.suspended&&r.resizable().redraw();var o=i.rotate();this.props.rotate=o.deg},onSelect:function(t){this.component("shape").addClass("shape-selected"),t.initial&&Graph.topic.publish("shape:select",{shape:this})},onDeselect:function(t){this.component("shape").removeClass("shape-selected"),t.initial&&Graph.topic.publish("shape:deselect",{shape:this})},onConnect:function(t){var e=t.link,r=e.router.source(),n=e.router.target();if(r&&n){var i=Graph.registry.shape.get(r),o=Graph.registry.shape.get(n);i&&o&&this.fire("connect",{link:e,source:i,target:o})}},onAfterResize:function(){this.refresh()},onBeforeDestroy:function(){this.fire("beforedestroy",{shape:this})},onAfterDestroy:function(){this.component("label").remove(),this.component("shape").remove();for(var t in this.components)this.components[t]=null;this.fire("afterdestroy",{shape:this}),Graph.registry.shape.unregister(this)},onChildConnect:function(t){},onChildAfterDrag:function(t){var e;t.batch?t.master&&(e=this.component("child"))&&e.dirty(!0):(e=this.component("child"))&&e.dirty(!0)},onChildBeforeDestroy:function(t){var e=t.shape;this.children().pull(e),e.off("beforedestroy",e.cached.beforeDestroyHandler),e.off("afterdrag",e.cached.afterDragHandler),e.off("connect",e.cached.connectHandler),e.cached.beforeDestroyHandler=null,e.cached.afterDragHandler=null,e.cached.connectHandler=null;var r=e.component("child");r&&r.dirty(!0)},onConfigToolClick:function(t){},onTrashToolClick:function(t){this.paper().diagram().capture(),this.remove()},onLinkToolClick:function(t){var e=this.paper();if(e){
var r=e.layout(),n=e.plugins.linker,i=r.pointerLocation(t);e.tool().activate("linker"),n.start(this.connectable().component(),i)}},onFrontToolClick:function(t){this.sendToFront()},onBackToolClick:function(t){this.sendToBack()}});e.guid=0,Graph.isShape=function(t){return t instanceof Graph.shape.Shape}}(),function(){Graph.ns("Graph.shape.activity"),Graph.shape.activity.Start=Graph.extend(Graph.shape.Shape,{props:{label:"Start",width:60,height:60,left:0,top:0},metadata:{type:"activity.start",style:"graph-shape-activity-start"},initComponent:function(){var t,e,r,n=this.components,i=this.plugins.manager;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1);var o=this.props.width/2,s=this.props.height/2;e=new Graph.svg.Ellipse(o,s,o,s).addClass(Graph.styles.SHAPE_BLOCK).style({fill:this.props.fill,stroke:this.props.stroke,strokeWidth:this.props.strokeWidth}).data("text",this.props.label).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),i.install("dragger",e,{ghost:!0,cls:Graph.styles.SHAPE_DRAG}),i.install("network",e,{wiring:"h:v"}),i.install("resizer",e),i.install("editor",e),i.install("snapper",e),e.on("edit.shape",_.bind(this.onLabelEdit,this)),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("connect.shape",_.bind(this.onConnect,this)),r=new Graph.svg.Text(o,s,this.props.label).addClass(Graph.styles.SHAPE_LABEL).selectable(!1).clickable(!1).render(t),n.shape=t.guid(),n.block=e.guid(),n.label=r.guid(),t=e=r=null},refresh:function(){if(!this.layout.suspended){var t,e,r,n,i=this.component("block"),o=this.component("shape"),s=this.component("label");e=i.bbox().toJson(),t=Graph.matrix().translate(e.x,e.y),o.matrix().multiply(t),o.attr("transform",o.matrix().toValue()),r=e.width/2,n=e.height/2,i.attr({cx:r,cy:n}),i.dirty(!0),i.resizable().redraw(),s.attr({x:r,y:n}),s.wrap(e.width-10),t=o.matrix(),this.data({left:t.props.e,top:t.props.f,width:e.width,height:e.height}),e=null,t=null}},toString:function(){return"Graph.shape.activity.Start"}})}(),function(){Graph.shape.activity.Final=Graph.extend(Graph.shape.Shape,{props:{label:"End",width:60,height:60,left:0,top:0,fill:"#FF4081"},metadata:{type:"activity.final",style:"graph-shape-activity-final"},initComponent:function(){var t,e,r,n,i=this.components,o=this.plugins.manager;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1);var s=this.props.width/2,a=this.props.height/2;e=new Graph.svg.Ellipse(s,a,s,a).addClass(Graph.styles.SHAPE_BLOCK).style({stroke:this.props.stroke,strokeWidth:this.props.strokeWidth}).data("text",this.props.label).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),o.install("dragger",e,{ghost:!0,
cls:Graph.styles.SHAPE_DRAG}),o.install("network",e,{wiring:"h:v"}),o.install("resizer",e),o.install("editor",e),o.install("snapper",e),e.on("edit.shape",_.bind(this.onLabelEdit,this)),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("connect.shape",_.bind(this.onConnect,this)),r=new Graph.svg.Ellipse(s,a,s-6,a-6).addClass("comp-inner").style({fill:this.props.fill}).clickable(!1).selectable(!1).render(t),n=new Graph.svg.Text(s,a,this.props.label).addClass(Graph.styles.SHAPE_LABEL).addClass("comp-label").selectable(!1).clickable(!1).render(t),i.shape=t.guid(),i.block=e.guid(),i.label=n.guid(),i.inner=r.guid(),t=e=n=r=null},fill:function(t){return void 0===t?this.props.value:(this.component("inner").elem.css("fill",t),this.props.fill=t,this)},refresh:function(){if(!this.layout.suspended){var t,e,r,n,i=this.component("block"),o=this.component("shape"),s=this.component("inner"),a=this.component("label");e=i.bbox().toJson(),t=Graph.matrix().translate(e.x,e.y),o.matrix().multiply(t),o.attr("transform",o.matrix().toValue()),r=e.width/2,n=e.height/2,i.attr({cx:r,cy:n}),i.dirty(!0),i.resizable().redraw(),a.attr({x:r,y:n}),a.wrap(e.width-10),s.attr({cx:r,cy:n,rx:r-6,ry:n-6}),t=o.matrix(),this.data({left:t.props.e,top:t.props.f,width:e.width,height:e.height}),e=null,t=null}},toString:function(){return"Graph.shape.activity.Final"},onAfterDestroy:function(){this.component("label").remove(),this.component("inner").remove(),this.component("shape").remove();for(var t in this.components)this.components[t]=null;Graph.registry.shape.unregister(this),this.fire("afterdestroy")}})}(),function(){Graph.shape.activity.Action=Graph.extend(Graph.shape.Shape,{props:{label:"Action",width:140,height:60,left:0,top:0},metadata:{type:"activity.action",icon:Graph.icons.SHAPE_ACTION,style:"graph-shape-activity-action"},initComponent:function(){var t,e,r,n=this.components,i=this.plugins.manager,o=this.props.width/2,s=this.props.height/2;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1),e=new Graph.svg.Rect(0,0,this.props.width,this.props.height).addClass(Graph.styles.SHAPE_BLOCK).style({fill:this.props.fill,stroke:this.props.stroke,strokeWidth:this.props.strokeWidth}).data("text",this.props.label).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),i.install("dragger",e,{ghost:!0,cls:Graph.styles.SHAPE_DRAG}),i.install("resizer",e),i.install("editor",e),i.install("network",e,{wiring:"h:v"}),i.install("snapper",e),i.install("rotator",e),e.on("edit.shape",_.bind(this.onLabelEdit,this)),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),
e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("connect.shape",_.bind(this.onConnect,this)),e.on("afterrotate.shape",_.bind(this.onAfterRotate,this)),r=new Graph.svg.Text(o,s,this.props.label).addClass(Graph.styles.SHAPE_LABEL).clickable(!1).selectable(!1).render(t),n.shape=t.guid(),n.block=e.guid(),n.label=r.guid(),this.props.rotate&&this.rotate(this.props.rotate),t=e=r=null},refresh:function(){if(!this.layout.suspended){var t,e,r=this.component("block"),n=this.component("shape"),i=this.component("label");t=r.bbox().toJson(),e=Graph.matrix().translate(t.x,t.y),n.matrix().multiply(e),n.attr("transform",n.matrix().toValue()),r.attr({x:0,y:0}),r.dirty(!0),r.resizable().redraw(),i.attr({x:t.width/2,y:t.height/2}),i.wrap(t.width-10),e=n.matrix(),this.data({left:e.props.e,top:e.props.f,width:t.width,height:t.height}),t=null,e=null}},onAfterResize:function(){this.refresh()},toString:function(){return"Graph.shape.activity.Action"}})}(),function(){Graph.shape.activity.Router=Graph.extend(Graph.shape.Shape,{props:{label:"Route",mode:"xor",width:100,height:100,left:0,top:0},metadata:{type:"activity.router",icon:Graph.icons.ROUTER_NONE,style:"graph-shape-activity-router"},constructor:function(){"none"!=this.props.mode&&(this.props.width=this.props.height=50),this.superclass.prototype.constructor.apply(this,arguments)},initMetadata:function(){this.metadata.tools=[{name:"mode-none",icon:Graph.icons.ROUTER_NONE,title:Graph._("Change to default mode"),enabled:!0,handler:_.bind(this.onModeClick,this,_,"none")},{name:"mode-or",icon:Graph.icons.ROUTER_OR,title:Graph._("Change to OR mode"),enabled:!0,handler:_.bind(this.onModeClick,this,_,"or")},{name:"mode-xor",icon:Graph.icons.ROUTER_XOR,title:Graph._("Change to XOR mode"),enabled:!0,handler:_.bind(this.onModeClick,this,_,"xor")},{name:"mode-parallel",icon:Graph.icons.ROUTER_PARALLEL,title:Graph._("Change to parallel mode"),enabled:!0,handler:_.bind(this.onModeClick,this,_,"parallel")},{name:"config",icon:Graph.icons.CONFIG,title:Graph._("Click to config shape"),enabled:!0},{name:"link",icon:Graph.icons.LINK,title:Graph._("Click to start shape linking"),enabled:!0,handler:_.bind(this.onLinkToolClick,this)},{name:"sendtofront",icon:Graph.icons.SEND_TO_FRONT,title:Graph._("Send to front"),enabled:!0,handler:_.bind(this.onFrontToolClick,this)},{name:"sendtoback",icon:Graph.icons.SEND_TO_BACK,title:Graph._("Send to back"),enabled:!0,handler:_.bind(this.onBackToolClick,this)},{name:"trash",icon:Graph.icons.TRASH,title:Graph._("Click to remove shape"),enabled:!0,handler:_.bind(this.onTrashToolClick,this)}]},initComponent:function(){
var t,e,r,n=this.components,i=this.plugins.manager,o=[this.props.width/2,0,this.props.width,this.props.height/2,this.props.width/2,this.props.height,0,this.props.height/2],s=o[0],a=o[3];t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1),e=new Graph.svg.Polygon(o).addClass(Graph.styles.SHAPE_BLOCK).data("text",this.props.label).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),i.install("dragger",e,{ghost:!0,cls:Graph.styles.SHAPE_DRAG}),i.install("resizer",e),i.install("editor",e),i.install("network",e,{wiring:"v:v"}),i.install("snapper",e),e.on("edit.shape",_.bind(this.onLabelEdit,this)),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("connect.shape",_.bind(this.onConnect,this)),r=new Graph.svg.Text(s,a,this.props.label).addClass(Graph.styles.SHAPE_LABEL).clickable(!1).selectable(!1).render(t),n.shape=t.guid(),n.block=e.guid(),n.label=r.guid(),t=e=r=null,this.mode(this.props.mode)},mode:function(t){if(void 0===t)return this.props.mode;this.props.mode=t;var e;if("none"!=this.props.mode){this.component("label").hide(),this.component("block").resizable().disable(),this.components.inner&&this.component("inner").remove();var r=this.component();switch(t){case"parallel":e=new Graph.svg.Path("M 10 25 L 25 25 L 25 40 L 25 25 L 40 25 L 25 25 L 25 10");break;case"or":e=new Graph.svg.Circle(25,25,10);break;case"xor":e=new Graph.svg.Path("M 15 15 L 25 25 L 15 35 L 25 25 L 35 35 L 25 25 L 35 15")}e&&(e.addClass("comp-inner"),e.selectable(!1),e.clickable(!1),e.render(r),this.components.inner=e.guid())}else this.component("label").show(),this.component("block").resizable().enable(),(e=this.component("inner"))&&(e.remove(),this.components.inner=null);return this},width:function(t){if(void 0===t)return this.props.width;var e=this.component("block").bbox().toJson(),r=t/this.props.width,n=e.x,i=(e.y+e.y2)/2;return this.component("block").resize(r,1,n,i,0,0),this.component().dirty(!0),this.props.width=t,this},height:function(t){if(void 0===t)return this.props.height;var e=this.component("block"),r=e.bbox().toJson(),n=t/this.props.height,i=(r.x+r.x2)/2,o=r.y,s=e.resize(1,n,i,o,0,0);return e.fire("afterresize",s),this.props.height=t,this},refresh:function(){if(!this.layout.suspended){var t,e,r=this.component("block"),n=this.component("shape"),i=this.component("label");t=r.bbox().toJson(),e=Graph.matrix().translate(t.x,t.y),n.matrix().multiply(e),n.attr("transform",n.matrix().toValue());var o=[t.width/2,0,t.width,t.height/2,t.width/2,t.height,0,t.height/2];r.attr({points:_.join(o,",")}),r.dirty(!0),r.resizable().redraw(),i.attr({x:t.width/2,y:t.height/2}),i.wrap(t.width-10),e=n.matrix(),this.data({
left:e.props.e,top:e.props.f,width:t.width,height:t.height}),e=null,t=null}},toString:function(){return"Graph.shape.activity.Router"},onModeClick:function(t,e){this.mode(e)}})}(),function(){Graph.shape.activity.Fork=Graph.extend(Graph.shape.Shape,{props:{width:300,height:15,left:0,top:0},metadata:{type:"activity.fork",style:"graph-shape-activity-fork"},initComponent:function(){var t,e,r,n=this.components,i=this.plugins.manager;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1),e=new Graph.svg.Rect(0,0,this.props.width,this.props.height,0).addClass(Graph.styles.SHAPE_BLOCK).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),i.install("dragger",e,{ghost:!0,cls:Graph.styles.SHAPE_DRAG}),i.install("resizer",e),i.install("snapper",e),i.install("network",e,{wiring:"v:v",tuning:!1,limitIncoming:1,limitOutgoing:0}),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("connect.shape",_.bind(this.onConnect,this)),r=new Graph.svg.Text(0,0,this.props.label).addClass(Graph.styles.SHAPE_LABEL).clickable(!1).selectable(!1).render(t),n.shape=t.guid(),n.block=e.guid(),n.label=r.guid()},refresh:function(){if(!this.layout.suspended){var t,e,r=this.component("block"),n=this.component("shape");t=r.bbox().toJson(),e=Graph.matrix().translate(t.x,t.y),n.matrix().multiply(e),n.attr("transform",n.matrix().toValue()),r.attr({x:0,y:0}),r.dirty(!0),r.resizable().redraw(),e=n.matrix(),this.data({left:e.props.e,top:e.props.f,width:t.width,height:t.height}),t=null,e=null}},toString:function(){return"Graph.shape.activity.Join"}})}(),function(){Graph.shape.activity.Join=Graph.extend(Graph.shape.Shape,{props:{width:300,height:15,left:0,top:0},metadata:{type:"activity.join",style:"graph-shape-activity-join"},initComponent:function(){var t,e,r,n=this.components,i=this.plugins.manager;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1),e=new Graph.svg.Rect(0,0,this.props.width,this.props.height,0).addClass(Graph.styles.SHAPE_BLOCK).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),i.install("dragger",e,{ghost:!0,cls:Graph.styles.SHAPE_DRAG}),i.install("resizer",e),i.install("snapper",e),i.install("network",e,{wiring:"v:v",tuning:!1,limitIncoming:0,limitOutgoing:1}),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("connect.shape",_.bind(this.onConnect,this)),
r=new Graph.svg.Text(0,0,this.props.label).addClass(Graph.styles.SHAPE_LABEL).clickable(!1).selectable(!1).render(t),n.shape=t.guid(),n.block=e.guid(),n.label=r.guid()},refresh:function(){if(!this.layout.suspended){var t,e,r=this.component("block"),n=this.component("shape");t=r.bbox().toJson(),e=Graph.matrix().translate(t.x,t.y),n.matrix().multiply(e),n.attr("transform",n.matrix().toValue()),r.attr({x:0,y:0}),r.dirty(!0),r.resizable().redraw(),e=n.matrix(),this.data({left:e.props.e,top:e.props.f,width:t.width,height:t.height}),t=null,e=null}},toString:function(){return"Graph.shape.activity.Join"}})}(),function(){Graph.shape.activity.Lane=Graph.extend(Graph.shape.Shape,{props:{label:"Participant Role",width:1e3,height:200,left:0,top:0},components:{header:null},tree:{pool:null},transfer:null,resizing:null,metadata:{type:"activity.lane",icon:Graph.icons.SHAPE_LANE,style:"graph-shape-activity-lane"},constructor:function(t){this.superclass.prototype.constructor.call(this,t)},initMetadata:function(){this.metadata.tools=[{name:"config",icon:Graph.icons.CONFIG,title:Graph._("Click to config shape"),enabled:!0},{name:"above",icon:Graph.icons.LANE_ABOVE,title:Graph._("Add shape above"),enabled:!0,handler:_.bind(this.onAboveToolClick,this)},{name:"below",icon:Graph.icons.LANE_BELOW,title:Graph._("Add shape below"),enabled:!0,handler:_.bind(this.onBelowToolClick,this)},{name:"moveup",icon:Graph.icons.MOVE_UP,title:Graph._("Move up"),enabled:!0,handler:_.bind(this.onUpToolClick,this)},{name:"movedown",icon:Graph.icons.MOVE_DOWN,title:Graph._("Move down"),enabled:!0,handler:_.bind(this.onDownToolClick,this)},{name:"sendtofront",icon:Graph.icons.SEND_TO_FRONT,title:Graph._("Send to front"),enabled:!0,handler:_.bind(this.onFrontToolClick,this)},{name:"sendtoback",icon:Graph.icons.SEND_TO_BACK,title:Graph._("Send to back"),enabled:!0,handler:_.bind(this.onBackToolClick,this)},{name:"trash",icon:Graph.icons.TRASH,title:Graph._("Click to remove shape"),enabled:!0,handler:_.bind(this.onTrashToolClick,this)}]},initComponent:function(){var t,e,r,n,i,o=this.components,s=this.plugins.manager;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1),e=new Graph.svg.Rect(0,0,this.props.width,this.props.height,0).addClass(Graph.styles.SHAPE_BLOCK).render(t),e.elem.data(Graph.string.ID_SHAPE,this.guid()),s.install("resizer",e,{restriction:{width:200,height:100}}),s.install("dragger",e,{ghost:!0,batchSync:!1,cls:Graph.styles.SHAPE_DRAG}),e.on("beforedrag.shape",_.bind(this.onBeforeDrag,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("beforeresize.shape",_.bind(this.onBeforeResize,this)),e.on("afterresize.shape",_.bind(this.onAfterResize,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),
r=new Graph.svg.Rect(0,0,30,this.props.height,0).addClass(Graph.styles.SHAPE_HEADER).selectable(!1).render(t),r.data("text",this.props.label),s.install("editor",r,{width:200,height:100,offset:"pointer"}),r.on("edit.shape",_.bind(this.onLabelEdit,this));var a=this.props.height/2;n=new Graph.svg.Text(15,a,this.props.label).addClass(Graph.styles.SHAPE_LABEL).selectable(!1).clickable(!1).render(t),n.rotate(270,15,a).commit(),i=(new Graph.svg.Group).addClass(Graph.styles.SHAPE_CHILD).selectable(!1).render(t),i.translate(50,0).commit(),o.shape=t.guid(),o.block=e.guid(),o.header=r.guid(),o.label=n.guid(),o.child=i.guid(),this.tree.pool=new Graph.shape.activity.Pool,this.tree.pool.insert(this),t=e=r=n=null},initDropzone:function(){function t(){var r;r=_.delay(function(){clearTimeout(r),r=null,e.transfer.shape.off("afterdrag",t),e.transfer=null},0)}var e=this,r=e.component(),n=e.component("block");e.children();n.interactable().dropzone({accept:".shape-draggable",overlap:.2}).on("dragenter",function(n){var i,o,s,a=e.pool().guid,p=e.guid();if(!e.transfer&&(i=Graph.registry.vector.get(n.relatedTarget))&&(o=Graph.registry.shape.get(i))){if(o.guid()==p||o.is("activity.lane")&&o.pool().guid==a)return;e.transfer={shape:o,batch:[]},e.transfer.shape.on("afterdrag",t),e.transfer.batch=[o];var h=i.collector();h&&(s=h.collection.toArray().slice(),_.forEach(s,function(t){var r=Graph.registry.shape.get(t);r&&r.guid()!=o.guid()&&e.transfer.batch.push(r)}),s=null)}e.transfer&&r.addClass("receiving")}).on("dragleave",function(t){r.removeClass("receiving")}).on("drop",function(t){if(e.transfer){var n;n=_.delay(function(){clearTimeout(n),n=null;var t=[],r=[],i=e.pool().guid,o=e.guid();_.forEach(e.transfer.batch,function(e){e.is("activity.lane")?e.guid()!=o&&e.pool().guid!=i&&r.push(e):t.push(e)}),t.length&&e.addChild(t),r.length&&e.addSiblingBellow(r)},0)}r.removeClass("receiving")}),n=null},pool:function(){return this.tree.pool},render:function(t,e,r){var n=this.component();e=_.defaultTo(e,"prepend"),n.render(t,e,r),this.tree.paper=t.guid(),Graph.registry.shape.setContext(this.guid(),t.guid()),this.initDropzone()},sendToBack:function(){this.paper()},sendToFront:function(){this.pool().bringToFront(this)},refresh:function(){if(!this.layout.suspended){var t,e,r=this.component("block"),n=this.component("shape"),i=this.component("child"),o=this.component("header"),s=this.component("label");e=r.bbox().toJson(),t=Graph.matrix().translate(e.x,e.y),n.matrix().multiply(t),n.attr("transform",n.matrix().toValue()),n.dirty(!0),i.dirty(!0),r.attr({x:0,y:0}),r.dirty(!0),r.resizable().redraw(),o.attr({x:0,y:0,height:e.height}),o.dirty(!0);var a=e.height/2;s.graph.matrix=Graph.matrix(),s.attr("transform",""),s.attr({x:15,y:a}),s.wrap(e.height-10),s.rotate(270,15,a).commit(),t=n.matrix(),this.data({left:t.props.e,top:t.props.f,width:e.width,height:e.height}),e=null,t=null}},attr:function(t,e){var r,n,i,o=this.superclass.prototype.attr.call(this,t,e),s={width:"width",height:"height",
left:"x",top:"y"};if(_.isPlainObject(t)){r=this.component("block");for(n in t)s[n]&&(i=t[n],r.attr(s[n],i));this.refresh()}else void 0!==e&&(r=this.component("block"),s[t]&&r.attr(s[t],e),this.refresh());return o},height:function(t){if(void 0!==t){var e=this.component("child").bbox().toJson();t=Math.max(t,e.y+e.height+20)}return this.superclass.prototype.height.call(this,t)},width:function(t){if(void 0!==t){var e=this.component("child").bbox().toJson();t=Math.max(t,e.x+e.width+20)}return this.superclass.prototype.width.call(this,t)},stroke:function(t){var e=this.superclass.prototype.stroke.call(this,t);return void 0!==t&&this.component("header").elem.css("stroke",this.props.stroke),e},addChild:function(t,e){this.superclass.prototype.addChild.call(this,t,e),this.pool().invalidate()},removeChild:function(t){this.superclass.prototype.removeChild.call(this,t),this.pool().invalidate()},addSiblingBellow:function(t){_.isArray(t)||(t=[t]);var e=this.pool(),r=_.reduce(_.map(t,function(t){return t.height()}),function(t,e){return t+e},0),n=this.width(),i=this.left(),o=this.top()+this.height();e.createSpaceBellow(this,r),_.forEach(t,function(t){var s,a,p,h=t.component().bboxView().clone().toJson();t.component().reset(),t.attr({width:n,left:i,top:o}),r=t.height(),o+=r,t.tree.pool=e,e.insert(t),t.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),s=t.component().bboxView().toJson(),a=s.x-h.x,p=s.y-h.y,e.relocateLinks(a,p,t)}),e.invalidate(),this.refreshSnapper()},createSiblingAbove:function(t){var e=new Graph.shape.activity.Lane(t),r=this.paper(),n=this.pool();n.createSpaceAbove(this,e.height());var i=this.top()-e.height();return e.attr({width:this.props.width,left:this.props.left,top:i}),e.tree.pool=n,void 0!==n.insert(e)&&(e.render(r,"before",this.component()),n.invalidate(),this.refreshSnapper()),e},createSiblingBellow:function(t){var e=new Graph.shape.activity.Lane(t),r=this.paper(),n=this.pool();n.createSpaceBellow(this,e.height());var i=this.top()+this.height();return e.attr({width:this.props.width,left:this.props.left,top:i}),e.tree.pool=n,void 0!==n.insert(e)&&(e.render(r,"after",this.component()),n.invalidate(),this.refreshSnapper()),e},refreshSnapper:function(){this.paper().snapper().refresh()},autoResize:function(){var t=this.component(),e=this.component("block");e.isSelected()&&e.deselect();var r=this.bbox().toJson(),n=t.bbox().toJson(),e=this.component("block"),i={top:20,bottom:20,left:40,right:20},o=_.extend({},r);n.y+i.top-r.y<i.top&&(o.y=n.y-i.top),n.x+i.left-r.x<i.left&&(o.x=n.x-i.left),r.x2-n.x2+i.right<i.right&&(o.x2=n.x2+i.right),r.y2-n.y2+i.bottom<i.bottom&&(o.y2=n.y2+i.bottom);var s=o.x-r.x,a=o.y-r.y,p=o.x2-o.x,h=o.y2-o.y,c=this.pool(),l=(this.guid(),c.populateChildren()),u={};l.each(function(t){var e=t.component("child").bboxView().toJson();u[t.guid()]={x:e.x,y:e.y}}),this.translate(s,a),this.attr({width:p,height:h}),c.resizeBy(this),l.each(function(t){
var e=t.component("child"),r=e.bboxView().toJson(),n=u[t.guid()];if(n){var i=n.x-r.x,o=n.y-r.y;e.translate(i,o).commit()}})},toString:function(){return"Graph.shape.activity.Lane"},toJson:function(){var t=this.superclass.prototype.toJson.call(this);return t.props.pool=this.pool().guid,t},onAfterDestroy:function(){var t=this,e=this.guid();t.cascade(function(t){t.guid()!=e&&t.remove()}),this.pool().remove(this),this.component("child").remove(),this.component("label").remove(),this.component("header").remove(),this.component("shape").remove();for(var r in this.components)this.components[r]=null;Graph.registry.shape.unregister(this),this.fire("afterdestroy")},onChildConnect:function(t){var e=t.source.parent(),r=t.target.parent();if(e&&r){var n=e.pool(),i=r.pool();n.guid!=i.guid&&t.link.type("message")}},onChildBeforeDestroy:function(t){this.superclass.prototype.onChildBeforeDestroy.call(this,t),this.pool().invalidate()},onSelect:function(t){var e=this,r=e.guid(),n=_.delay(function(){clearTimeout(n),n=null,e.cascade(function(t){if(t.guid()!=r){var e,n;if(e=t.draggable().component(),e&&e.deselect(),n=t.connectable().plugin()){var i=n.connections();_.forEach(i,function(t){t.link.deselect()})}}}),e.component("shape").addClass("shape-selected"),Graph.topic.publish("shape:select",{shape:e})},0)},onBeforeDrag:function(t){if(t.master){this.fire(t),this.paper().diagram().capture();var e,r,n=this.pool().populateLinks();for(r in n.isolated)e=n.isolated[r].link,e.deselect();for(r in n.separated)e=n.separated[r].link,e.deselect()}},onAfterDrag:function(t){if(t.master){var e,r=this.component("block"),n=this.component("shape"),i=this.component("child"),o=r.matrix(),s=this.pool();r.reset(),n.matrix().multiply(o),n.attr("transform",n.matrix().toValue()),n.dirty(!0),i.dirty(!0),e=n.matrix(),this.data({left:e.props.e,top:e.props.f}),this.fire(t),s.relocateSiblings(this,t.dx,t.dy),s.refreshContents(),s.relocateLinks(t.dx,t.dy),s.refreshChildren(),this.refreshSnapper()}},onBeforeResize:function(t){this.resizing={childOffsets:{}};var e=this.component("child").bboxView().toJson(),r=this.pool().populateChildren(),n=this.resizing;r.each(function(t){var r=t.component("child"),i=r.bboxView().toJson();n.childOffsets[t.guid()]={x:i.x,y:i.y},i.x<e.x&&(e.x=i.x),e.x2<i.x2&&(e.x2=i.x2)});var i=t.resizer,o=t.direction,s={x:e.x,y:e.y},a={top:10,left:40,right:10,bottom:10};switch(o){case"n":s.x=(e.x+e.x2)/2,s.y=e.y2-a.bottom;break;case"e":s.x=e.x+a.right,s.y=(e.y+e.y2)/2;break;case"s":s.x=(e.x+e.x2)/2,s.y=e.y+a.top;break;case"w":s.x=e.x2-a.left,s.y=(e.y+e.y2)/2;break;case"ne":s.x=e.x+a.right,s.y=e.y2-a.bottom;break;case"se":s.x=e.x+a.right,s.y=e.y+a.top;break;case"sw":s.x=e.x2-a.left,s.y=e.y+a.top;break;case"nw":s.x=e.x2-a.left,s.y=e.y2-a.bottom}var p=e.x2-e.x,h=e.y2-e.y;p<=0&&(p=200),h<=0&&(h=100),i.restrict({width:p,height:h,origin:s})},onAfterResize:function(t){this.superclass.prototype.onAfterResize.call(this,t);var e=this.pool();if(e.resizeBy(this),this.resizing){
var r=e.populateChildren(),n=this.resizing;r.each(function(t){var e=t.component("child"),r=e.bboxView().toJson(),i=n.childOffsets[t.guid()];if(i){var o=i.x-r.x,s=i.y-r.y;e.translate(o,s).commit()}}),this.resizing=n=null}},onAboveToolClick:function(t){this.createSiblingAbove()},onBelowToolClick:function(t){this.createSiblingBellow()},onUpToolClick:function(t){this.pool().moveUp(this),this.refreshSnapper()},onDownToolClick:function(t){this.pool().moveDown(this),this.refreshSnapper()}})}(),function(){var t=Graph.shape.activity.Pool=function(){this.guid="pool-"+ ++t.guid,this.lanes=new Graph.collection.Tree([]).keygen(function(t){return t.bbox.y}),this.cached={nodes:{},contents:null}};t.prototype.invalidate=function(){this.cached.contents=null},t.prototype.populateChildren=function(){var t=[];return _.forEach(this.lanes.toArray(),function(e){var r=Graph.registry.shape.get(e.lane);t.push(r)}),new Graph.collection.Shape(t)},t.prototype.bbox=function(){for(var t,e=this.lanes.toArray(),r=[],n=[],i=[],o=[],s=e.length-1;s>=0;s--)t=e[s].bbox,r.push(t.x),n.push(t.y),i.push(t.x+t.width),o.push(t.y+t.height);return r=_.min(r),n=_.min(n),i=_.max(i),o=_.max(o),e=null,Graph.bbox({x:r,y:n,x2:i,y2:o,width:i-r,height:o-n})},t.prototype.get=function(t){var e=this.lanes.get(t);return e?Graph.registry.shape.get(e.lane):null},t.prototype.prev=function(t){var e=this.index(t),r=this.lanes.get(e-1);return r?Graph.registry.shape.get(r.lane):null},t.prototype.last=function(){var t=this.size()-1,e=this.lanes.get(t);return e?Graph.registry.shape.get(e.lane):null},t.prototype.createSpaceAbove=function(t,e){var r=this.index(t),n=this.lanes.get(r-1),i=this;n&&(this.lanes.bubble(n,function(t){var r=Graph.registry.shape.get(t.lane);r&&(r.translate(0,-e),t.bbox=r.bbox().toJson(),r.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),i.relocateLinks(0,-e,r))}),this.lanes.order())},t.prototype.createSpaceBellow=function(t,e){var r=this.index(t),n=this.lanes.get(r+1),i=this;n&&(this.lanes.cascade(n,function(t){var r=Graph.registry.shape.get(t.lane);r&&(r.translate(0,e),t.bbox=r.bbox().toJson(),r.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),i.relocateLinks(0,e,r))}),this.lanes.order())},t.prototype.relocateSiblings=function(t,e,r){var n=this.lanes.root(),i=t.guid();n&&this.lanes.cascade(n,function(n){if(n.lane==i)n.bbox=t.bbox().toJson();else{var o=Graph.registry.shape.get(n.lane);o&&(o.translate(e,r),n.bbox=o.bbox().toJson())}})},t.prototype.resizeBy=function(t){var e=t.guid(),r=t.bbox().toJson(),n=this.lanes.root(),i=this.index(t);if(n){var o,s,a,p,h,c;o=this.lanes.get(i-1),s=this.lanes.get(i+1),a=0,h=0,p=0,c=0,o&&(a=r.x-o.bbox.x,h=r.y-(o.bbox.y+o.bbox.height)),s&&(p=r.x-s.bbox.x,c=r.y+r.height-s.bbox.y),this.lanes.cascade(n,function(t,n){if(t.lane==e)t.bbox=r;else{var o=Graph.registry.shape.get(t.lane);if(o){var s=(o.component(),o.component("block"));i>n?o.translate(a,h):i<n&&o.translate(p,c),s.attr({width:r.width}),
s.dirty(!0),o.refresh(),t.bbox=o.bbox().toJson()}}})}r=null},t.prototype.bringToFront=function(t){var e=Graph.$('[data-pool="'+this.guid+'"]'),r=e.last();r.length()&&r.node()!=t.component().node()&&r.after(t.component().elem)},t.prototype.moveUp=function(t){var e=this.index(t),r=this.get(e-1),n=this.lanes.get(e),i=this.lanes.get(e-1);if(r){var o=t.bbox().toJson(),s=r.bbox().toJson(),a=s.y-o.y,p=o.height;n.bbox.y+=a,n.bbox.y2+=a,i.bbox.y+=p,i.bbox.y2+=p,t.translate(0,a),r.translate(0,p),this.lanes.order(),t.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),r.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),this.relocateLinks(0,a,t),this.relocateLinks(0,p,r)}},t.prototype.moveDown=function(t){var e=this.index(t),r=this.get(e+1),n=this.lanes.get(e),i=this.lanes.get(e+1);if(r){var o=t.bbox().toJson(),s=r.bbox().toJson(),a=s.height,p=o.y-s.y;n.bbox.y+=a,n.bbox.y2+=a,i.bbox.y+=p,i.bbox.y2+=p,t.translate(0,a),r.translate(0,p),this.lanes.order(),t.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),r.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),this.relocateLinks(0,a,t),this.relocateLinks(0,p,r)}},t.prototype.refreshChildren=function(){this.populateChildren().each(function(t){t.component("child").dirty(!0)})},t.prototype.populateContents=function(t){var e;return void 0!==t?e=new Graph.collection.Shape(t.children().toArray()):(e=this.cached.contents)||(e=[],_.forEach(this.lanes.toArray(),function(t){var r=Graph.registry.shape.get(t.lane);r&&(e=_.concat(e,r.children().toArray()))}),e=new Graph.collection.Shape(e),this.cached.contents=e),e},t.prototype.refreshContents=function(){this.populateContents().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)})},t.prototype.populateLinks=function(t){var e=this,r=e.populateContents(t),n=r.keys(),i={isolated:{},separated:{}};return r.each(function(t){var e,r,o=t.connectable().plugin(),s=o&&o.connections()||[];_.forEach(s,function(t){(e=Graph.registry.vector.get("incoming"==t.type?t.source:t.target))&&(r=Graph.registry.shape.get(e))&&(_.indexOf(n,r.guid())>-1?i.isolated[t.guid]||(i.isolated[t.guid]=t):i.separated[t.guid]||(i.separated[t.guid]=t))})}),i},t.prototype.relocateLinks=function(t,e,r){var n,i,o=this.populateLinks(r);for(n in o.isolated)i=o.isolated[n],i.link.invalidate("convex"),i.link.relocate(t,e);for(n in o.separated)i=o.separated[n],i.link.invalidate("convex"),"incoming"==i.type?i.link.relocateHead(t,e):(i.link.invalidate("convex"),i.link.relocateTail(t,e));o=null},t.prototype.size=function(){return this.lanes.size()},t.prototype.insert=function(t){var e,r,n=t.guid();return e={lane:n,bbox:t.bbox().toJson()},r=this.lanes.insert(e),void 0!==r&&(this.cached.nodes[n]=e,t.component().elem.attr("data-pool",this.guid)),e=null,r},t.prototype.remove=function(t){var e=t.guid(),r=this.cached.nodes[e],n=this.lanes.remove(r);if(void 0!==n){var i=(this.lanes.get(n-1),
this.lanes.get(n)),o=this;if(i){var s=-r.bbox.height;this.lanes.cascade(i,function(t){var e=Graph.registry.shape.get(t.lane);e&&(e.translate(0,s),t.bbox=e.bbox().toJson(),e.children().each(function(t){var e=t.connectable().component();e&&e.dirty(!0)}),o.relocateLinks(0,s,e))}),this.lanes.order()}delete this.cached.nodes[e]}return r=null,n},t.prototype.index=function(t){var e=t.guid(),r=this.cached.nodes[e],n=this.lanes.index(r);return r=null,n},t.guid=0}(),function(){Graph.shape.common.Label=Graph.extend(Graph.shape.Shape,{props:{label:"untitled",align:"left",fontSize:16,lineHeight:1.1},metadata:{type:"common.label",icon:"ion-android-create"},initComponent:function(){var t,e,r,n=this.plugins.manager;t=new Graph.svg.Group(this.props.left,this.props.top).selectable(!1),e=new Graph.svg.Rect(0,0,0,0,0).data("text",this.props.label).render(t),e.style({fill:"rgba(255,255,255,0)","stroke-width":0}),e.elem.data(Graph.string.ID_SHAPE,this.guid()),n.install("dragger",e,{cls:Graph.styles.SHAPE_DRAG}),n.install("editor",e,{width:300,height:75,align:"left",offset:"pointer"}),e.on("edit.shape",_.bind(this.onLabelEdit,this)),e.on("afterdrag.shape",_.bind(this.onAfterDrag,this)),e.on("select.shape",_.bind(this.onSelect,this)),e.on("deselect.shape",_.bind(this.onDeselect,this)),e.on("beforedestroy.shape",_.bind(this.onBeforeDestroy,this)),e.on("afterdestroy.shape",_.bind(this.onAfterDestroy,this)),r=new Graph.svg.Text(0,this.props.lineHeight*this.props.fontSize,this.props.label).attr("font-size",this.props.fontSize).attr("text-anchor",this.props.align).clickable(!1).selectable(!1).render(t),r.on("render.shape",_.bind(this.onLabelRender,this)),_.assign(this.components,{shape:t.guid(),block:e.guid(),label:r.guid()})},initMetadata:function(){this.metadata.tools=[{name:"sendtofront",icon:Graph.icons.SEND_TO_FRONT,title:Graph._("Send to front"),enabled:!0,handler:_.bind(this.onFrontToolClick,this)},{name:"sendtoback",icon:Graph.icons.SEND_TO_BACK,title:Graph._("Send to back"),enabled:!0,handler:_.bind(this.onBackToolClick,this)},{name:"trash",icon:Graph.icons.TRASH,title:Graph._("Click to remove shape"),enabled:!0,handler:_.bind(this.onTrashToolClick,this)}]},refresh:_.debounce(function(){if(!this.layout.suspended){var t=this.component("label"),e=this.component("block");t.write(this.props.label),t.dirty(!0);var r=t.bbox().toJson();e.attr({width:r.width}),e.dirty(!0)}},1),toString:function(){return"Graph.shape.common.Label"},onLabelRender:function(){var t=this.component("label"),e=this.component("block"),r=t.bbox().toJson();e.attr({width:r.width,height:r.height})},onLabelEdit:function(t){var e=t.text;e?(this.component("label").props.text=e,this.props.label=e,this.refresh()):this.remove()},onAfterDrag:function(t){var e,r=this.component("block"),n=this.component("shape"),i=r.matrix();r.reset(),n.matrix().multiply(i),n.attr("transform",n.matrix().toValue()),n.dirty(!0),e=n.matrix(),this.data({left:e.props.e,top:e.props.f}),this.fire(t)},onSelect:function(t){
this.component().addClass("label-selected"),t.initial&&Graph.topic.publish("shape:select",{shape:this})},onDeselect:function(t){this.component().removeClass("label-selected"),t.initial&&Graph.topic.publish("shape:deselect",{shape:this})}})}(),function(){function t(t){var e=encodeURIComponent(t);return e=e.replace(/%([0-9A-F]{2})/g,function(t,e){var r=String.fromCharCode("0x"+e);return"%"===r?"%25":r}),decodeURIComponent(e)}function e(t,e){if(navigator.msSaveOrOpenBlob){var n=r(e);navigator.msSaveOrOpenBlob(n,t),n=null}else{var i=Graph.dom("<a/>");"download"in i?(i.download=t,i.href=e,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)):window.open(e,"_download","menubar=no,toolbar=no,status=no"),i=null}}function r(t){for(var e=window.atob(t.split(",")[1]),r=t.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(e.length),i=new Uint8Array(n),o=0,s=e.length;o<s;o++)i[o]=e.charCodeAt(o);return new Blob([n],{type:r})}function n(t,e,r){var n=o(t,e),i=new Image;i.onload=function(){var t,n,o;t=document.createElement("canvas"),t.width=i.width,t.height=i.height,n=t.getContext("2d"),e.background&&(n.fillStyle=e.background,n.fillRect(0,0,t.width,t.height)),n.drawImage(i,0,0);try{o=t.toDataURL(e.encoder,e.compression)}catch(t){o=!1}t=n=null,r(o)},i.onerror=function(){r(!1)},i.src=n}function i(t,e){var r,n,i,o,p=Graph.dom("<div/>"),h=t.cloneNode(!0);"svg"==h.tagName?(h.setAttribute("width",e.width),h.setAttribute("height",e.height)):(i=Graph.dom("<svg/>"),i.setAttribute("xmlns",Graph.config.xmlns.svg),i.setAttribute("xmlns:xlink",Graph.config.xmlns.xlink),i.setAttribute("version",Graph.config.svg.version),i.setAttribute("width",e.width),i.setAttribute("height",e.height),i.appendChild(h),h=i),p.appendChild(h),r=s(t),n=Graph.dom("<style/>"),n.setAttribute("type","text/css"),n.innerHTML="<![CDATA[\n"+r+"\n]]>";var c=h.childNodes[0];return c?h.insertBefore(n,c):h.appendChild(n),o=a+p.innerHTML,p=h=null,o}function o(e,r){var n=i(e,r);return"data:image/svg+xml;base64,"+window.btoa(t(n))}function s(t){var e,r,n,i=document.styleSheets,o="";if("shadow"==Graph.config.dom)for(var s=t.parentNode;s&&s!=t.ownerDocument;){if(void 0!==s.styleSheets){i=s.styleSheets;break}s=s.parentNode}for(var a=0,p=i.length;a<p;a++)if(null!=(e=i[a].cssRules))for(var h=0,c=e.length;h<c;h++,n=null)if(r=e[h],void 0!==r.style&&r.selectorText)try{n=t.querySelector(r.selectorText),n?o+=r.selectorText+" { "+r.style.cssText+" }\n":r.cssText.match(/^@font-face/)&&(o+=r.cssText+"\n")}catch(t){continue}return o}var a='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd" [<!ENTITY nbsp "&#160;">]>',p=Graph.data.Exporter=function(t,e){this.options=_.extend({},p.defaults,e||{}),this.element=t.node();var r,n,i,o;t.isPaper()?(r=t.viewport().bbox().toJson(),i=Math.max(r.y+r.height+100,t.elem.height()),n=Math.max(r.x+r.width,t.elem.width()),
o=t.layout().scale()):(r=t.bbox().toJson(),n=r.width,i=r.height,o=t.matrixCurrent().scale()),_.assign(this.options,{width:n,height:i,scaleX:o.x,scaleY:o.y})};p.defaults={width:0,height:0,scaleX:1,scaleY:1},p.prototype.exportDataURI=function(){},p.prototype.exportSVG=function(t,e){var r=_.extend({},this.options);r.encoder="application/svg+xml",r.compression=1,r.background="#ffffff";var n,i=o(this.element,r),s=document.createElement("a");s.setAttribute("download",t),s.setAttribute("href",i),document.createEvent?(n=document.createEvent("MouseEvents"),n.initEvent("click",!0,!1),s.dispatchEvent(n)):document.createEventObject&&s.fireEvent("onclick"),s=n=null},p.prototype.exportJPEG=function(t,r){var i=_.extend({},this.options);i.encoder="image/jpeg",i.compression=r||1,i.background="#ffffff",t=_.defaultTo(t,"download.jpg"),n(this.element,i,function(r){r&&e(t,r)})},p.prototype.exportPNG=function(t,r){var i=_.extend({},this.options);t=_.defaultTo(t,"download.png"),i.encoder="image/png",i.compression=r||.8,n(this.element,i,function(r){r&&e(t,r)})},p.prototype.exportFile=function(t){var e=_.extend({},this.options);e.encoder="image/jpeg",e.compression=1,e.background="#ffffff",n(this.element,e,function(e){if(e){var n=r(e);t&&t(n)}else t&&t(!1)})},p.prototype.exportBlob=function(t){var e=_.extend({},this.options);e.encoder="image/jpeg",e.compression=1,e.background="#ffffff",n(this.element,e,function(e){if(e){var n=r(e);t&&t(n)}else t&&t(!1)})}}(),function(){Graph.diagram.Manager=Graph.extend({props:{paper:null,defaultType:"activity"},pallets:[],diagram:null,snapshoot:[],constructor:function(t){this.props.paper=t.guid(),t.on("keynavdown",_.bind(this.onKeynavDown,this))},paper:function(){return Graph.registry.vector.get(this.props.paper)},deselectAll:function(){this.paper().collector().clearCollection()},removeSelection:function(){var t=this.paper().collector().collection.toArray().slice();this.capture(),_.forEach(t,function(t){t.remove()})},capture:function(){this.diagram},undo:function(){this.snapshoot.length&&this.diagram.render(this.snapshoot[0])},redo:function(){},addPallet:function(t){var e=this,r=e.paper(),n=r.layout(),i=n.scale(),o=null;e.pallets.push(t),t.on({pick:function(s){r.tool().activate("panzoom"),e.diagram||e.create(e.props.defaultType);var a=n.pointerLocation({clientX:s.origin.x,clientY:s.origin.y}),p={left:a.x,top:a.y},h=e.diagram.drawShape(s.shape,p);h.movable?(o=h.shape,i=r.layout().scale(),o.component("block").dirty(!0),o.component().dirty(!0)):(o=null,t.stopPicking())},drag:function(t){if(o){var e=t.dx,r=t.dy;e/=i.x,r/=i.y,i.x<1&&(e+=i.x),o.translate(e,r)}},drop:function(t){o&&(o=null)}})},current:function(){return this.diagram},remove:function(){this.diagram&&(this.diagram.remove(),this.diagram=null,this.paper().fire("diagram.destroy"))},create:function(t,e,r){t=_.defaultTo(this.props.defaultType);var n=Graph.diagram.type[_.capitalize(t)],i=this.paper();return this.diagram=Graph.factory(n,[i,e]),r=_.defaultTo(r,!1),
r||i.fire("diagram.create",{diagram:this.diagram}),this.diagram},saveAsImage:function(t,e){var r=new Graph.data.Exporter(this.paper());switch(t){case"svg":r.exportSVG(e);break;case"png":r.exportPNG(e);break;case"jpg":case"jpeg":r.exportJPEG(e)}r=null},saveAsFile:function(t){var e=new Graph.data.Exporter(this.paper());e.exportFile(t),e=null},saveAsBlob:function(t){return new Graph.data.Exporter(this.paper()).exportBlob(t)},onKeynavDown:function(t){switch(t.keyCode){case Graph.event.DELETE:this.removeSelection(),t.preventDefault()}}})}(),function(){function t(e,r,n){var i,o;for(i in e)o=e[i],n(r[o.index],o.index,o.total),void 0!==o.children&&t(o.children,r,n)}var e=Graph.diagram.Parser=function(t){t=t||{},this._props=t.props||{},this._shapes=t.shapes||[],this._links=t.links||[],this._tree={},this.parse()};e.prototype.constructor=e,e.prototype.parse=function(){var t=this._shapes,e={},r={},n=t.length;_.forEach(t,function(t,e){r[t.props.id]={id:t.props.id,parent_id:t.props.parent_id,index:e,total:n}});var i,o;for(i in r)o=r[i],o.parent_id?(void 0===r[o.parent_id].children&&(r[o.parent_id].children={}),r[o.parent_id].children[o.id]=o):e[i]=o;this._tree=e},e.prototype.shapes=function(){var e=this._shapes,r=this._tree;return{total:e.length,each:function(n){t(r,e,n)}}},e.prototype.links=function(){var t=this._links;return{total:t.length,each:function(e){_.forEach(t,e)}}},e.prototype.props=function(){var t=this._props;return{each:function(e){_.forOwn(t,e)}}},e.prototype.destroy=function(){this._shapes=null,this._links=null,this._tree=null,this._props=null}}(),function(){var t=Graph.diagram.pallet.Activity=Graph.extend({props:{guid:null,rendered:!1,template:null},components:{pallet:null},cached:{},picking:{enabled:!1,target:null,matrix:null,shape:null,begin:!1,start:null},constructor:function(e){_.assign(this.props,e||{}),this.props.guid="pallet-"+ ++t,this.initComponent(),Graph.registry.pallet.register(this)},guid:function(){return this.props.guid},initComponent:function(){var t,e,r;e=this.props.template,
e||(e='<defs><marker id="marker-arrow-pallet" refX="11" refY="10" viewBox="0 0 20 20" markerWidth="10" markerHeight="10" orient="auto"><path d="M 1 5 L 11 10 L 1 15 Z" fill="#30D0C6" stroke-linecap="round" stroke-dasharray="10000, 1"/></marker></defs><g class="graph-pallet-item" data-shape="Graph.shape.activity.Start" transform="matrix(1,0,0,1,40,0)"><circle cx="32" cy="32" r="30"/><text x="32" y="36">Start</text></g><g class="graph-pallet-item" data-shape="Graph.shape.activity.Final" transform="matrix(1,0,0,1,40,80)"><circle cx="32" cy="32" r="30"/><circle cx="32" cy="32" r="24" class="full"/><text x="32" y="36">End</text></g><g class="graph-pallet-item" data-shape="Graph.shape.activity.Action" transform="matrix(1,0,0,1,40,160)"><rect x="2" y="2" width="60" height="60" rx="7" ry="7"/><text x="32" y="34">Action</text></g><g class="graph-pallet-item" data-shape="Graph.shape.activity.Router" transform="matrix(1,0,0,1,40,250)"><rect x="4" y="4" width="54" height="54" transform="rotate(45,32,32)"/><text x="30" y="34">Route</text></g><g class="graph-pallet-item" data-shape="Graph.shape.activity.Join" transform="matrix(1,0,0,1,40,340)"><rect x="2" width="60" height="58" rx="0" ry="0" style="fill: rgba(255,255,255,0); stroke-width: 0" /><rect x="2" y="28" width="60" height="6" rx="0" ry="0" pointer-events="none" class="full"/><path d="M 10  0 L 10 28" pointer-events="none" ></path><path d="M 54  0 L 54 28" pointer-events="none" ></path><path d="M 32 34 L 32 60" marker-end="url(#marker-arrow-pallet)" pointer-events="none" ></path><text x="32" y="20">Join</text></g><g class="graph-pallet-item" data-shape="Graph.shape.activity.Fork" transform="matrix(1,0,0,1,40,420)"><rect x="2" width="60" height="58" rx="0" ry="0" pointer-events="none" style="fill: rgba(255,255,255,0); stroke-width: 0" /><rect x="2" y="28" width="60" height="6" rx="0" ry="0" class="full"/><path d="M 10 34 L 10 60" marker-end="url(#marker-arrow-pallet)" pointer-events="none" ></path><path d="M 54 34 L 54 60" marker-end="url(#marker-arrow-pallet)" pointer-events="none" ></path><path d="M 32  0 L 32 28" pointer-events="none" ></path><text x="32" y="50">Fork</text></g><g class="graph-pallet-item" data-shape="Graph.shape.activity.Lane" transform="matrix(1,0,0,1,40,510)"><rect x="2" y="2" width="60" height="60" rx="0" ry="0"/><rect x="2" y="2" width="10" height="60" rx="0" ry="0"/><text x="32" y="34">Role</text></g>'),t=_.format('<svg class="graph-pallet" xmlns="{0}" xmlns:xlink="{1}" version="{2}" style="width: 100%; height: 100%">'+e+"</svg>",Graph.config.xmlns.svg,Graph.config.xmlns.xlink,Graph.config.svg.version),r=Graph.$(t),this.components.pallet=r},stopPicking:function(){this.picking.enabled&&(this.picking.target.remove(),_.assign(this.picking,{target:null,matrix:null,offset:null,enabled:!1,shape:null,start:!1}))},render:function(t){function e(t){var e=Graph.$(t.currentTarget);if(i.picking.enabled&&n(t),void 0!==e.data("shape")){var r=Graph.util.transform2segments(e.attr("transform"))
;r=r[0].slice(1),i.picking.enabled=!0,i.picking.matrix=Graph.factory(Graph.lang.Matrix,r),i.picking.target=Graph.$(t.currentTarget.cloneNode(!0)),i.picking.target.addClass("grabbing"),i.picking.shape=e.data("shape"),o.append(i.picking.target),i.fire("pick",{shape:i.picking.shape,origin:{x:t.clientX,y:t.clientY}}),r=null}}function r(t){if(t.interaction.pointerIsDown&&i.picking.target){t.preventDefault();var e={x:t.clientX,y:t.clientY};i.picking.offset||(i.picking.offset=e);var r=e.x-i.picking.offset.x,n=e.y-i.picking.offset.y;i.picking.matrix.translate(r,n),i.picking.target.attr("transform",i.picking.matrix.toValue()),i.fire("drag",{dx:r,dy:n}),i.picking.offset=e}}function n(t){i.picking.enabled&&i.fire("drop",{clientX:t.clientX,clientY:t.clientY}),i.stopPicking()}if(!this.props.rendered){var i=this,o=this.components.pallet;return this.props.rendered=!0,t=Graph.$(t),t.prepend(o),t=null,interact(".graph-pallet-item").on("down",function(t){e(t)}).on("move",function(t){r(t)}).on("up",function(t){n(t)}),o.on("mouseleave",function(t){n(t)}),this}},toString:function(){return"Graph.diagram.pallet.Activity"}});t.guid=0}(),function(){Graph.diagram.type.Diagram=Graph.extend({props:{id:null,paper:null,dirty:!1},drawing:{enabled:!1},metadata:{type:"diagram.diagram"},constructor:function(t,e){e=e||{},_.assign(this.props,e),this.props.paper=t.guid(),this.empty()},update:function(t){var e=this,r=new Graph.diagram.Parser(t);e.paper();r.props().each(function(t,r){"type"!=r&&(e.props[r]=t)}),r.shapes().each(function(t){var r;t.props.id&&(r=e.getShapeBy(function(e){return e.props.id==t.props.id})),(r=e.getShapeBy(function(e){return e.props.guid==t.props.client_id}))&&r.update(t)}),r.links().each(function(t){var r;t.props.id&&(r=e.getLinkBy(function(e){return e.props.id==t.props.id})),(r=e.getLinkBy(function(e){return e.props.guid==t.props.client_id}))&&r.data(t.props)}),r.destroy(),r=null},commit:function(){return this.props.dirty=!1,this},render:function(t){},paper:function(){return Graph.registry.vector.get(this.props.paper)},empty:function(){var t=this.getShapes();return this.paper().snapper().invalidate(),t.each(function(t){t.tree.parent||t.remove()}),t=null,this},getShapes:function(){var t=this.paper().guid(),e=Graph.registry.shape.collect(t);return new Graph.collection.Shape(e)},getLinks:function(){var t,e,r,n,i,o,s=this.getShapes().toArray(),a={},p=[];for(r=0,n=s.length;r<n;r++)if(t=s[r].connectable().plugin())for(e=t.connections(),i=0,o=e.length;i<o;i++)void 0===a[e[i].guid]&&(p.push(e[i].link),a[e[i].guid]=!0);return a=null,new Graph.collection.Link(p)},drawShape:function(t,e){},findShapeBy:function(t){var e=this.getShapes().toArray();return _.filter(e,t)},getShapeBy:function(t){var e=this.getShapes().toArray();return _.find(e,t)},getLinkBy:function(t){var e=this.getLinks().toArray();return _.find(e,t)},remove:function(){this.empty(),this.fire("afterdestroy")},toJson:function(){return{}}})}(),function(){
Graph.diagram.type.Activity=Graph.extend(Graph.diagram.type.Diagram,{props:{name:"Activity Diagram",description:"No diagram description",cover:null},rendering:{active:!1},metadata:{type:"diagram.activity"},drawShape:function(t,e){var r=this.paper();this.drawing.dragging&&(this.drawing.dragging=!1,this.drawing.shape.off("beforedrag",this.drawing.beforeDrag),this.drawing.shape.off("aferdrag",this.drawing.afterDrag),this.drawing.beforeDrag=null,this.drawing.afterDrag=null,this.drawing.shape.remove(),this.drawing.shape=null);var n,i,o;if(e=e||{},o=!0,"Graph.shape.activity.Lane"==t){var s=this.getShapes();if(s.size()&&!this.hasLane()){var a=s.bbox().toJson();e.left=a.x-40,e.top=a.y-20,o=!1,a=null}s=null}else"Graph.shape.common.Label"==t&&(o=!1);n=Graph.ns(t),i=Graph.factory(n,[e]),o&&(o=!!i.draggable().plugin());var p=this;if(this.drawing.beforeDrag=function(t){i.component().addClass("picking")},this.drawing.afterDrag=function(){var t;t=_.delay(function(e){var r=!1;if(clearTimeout(t),t=null,e.is("activity.lane"))r=!0;else if(p.hasLane()){var n=e.parent();r=n&&n.is("activity.lane")}else r=!0;r||(Graph.message("Can't drop shape outside lane or pool","warning"),e.remove(),e=null)},0,p.drawing.shape),i.component().removeClass("picking"),p.drawing.beforeDrag=null,p.drawing.afterDrag=null,p.drawing.dragging=!1,p.drawing.shape=null},o){this.drawing.dragging=!0,this.drawing.shape=i,i.render(r);var h=i.draggable().plugin(),c=i.snappable().component();if(h.start(),void 0!==e.left&&void 0!==e.top){var l=i.center(),u=e.left-l.x,d=e.top-l.y;i.translate(u,d),c&&c.dirty(!0)}i.one("beforedrag",this.drawing.beforeDrag),i.one("afterdrag",this.drawing.afterDrag)}else if(p.drawing.dragging=!1,p.drawing.shape=null,p.drawing.beforeDrag=null,p.drawing.afterDrag=null,i.is("activity.lane")){var f=p.getShapes().toArray();i.render(r),i.addChild(f),f=null}else if(i.is("common.label")){p.findShapeBy(function(t){return t.is("activity.lane")}),i.props.left,i.props.top;i.render(r)}return{movable:o,shape:i}},hasLane:function(){return 0!==this.findShapeBy(function(t){return t.is("activity.lane")}).length},render:function(t){var e=this,r=this.paper(),n=new Graph.diagram.Parser(t);this.rendering.active||(this.rendering.active=!0,this.empty(),n.props().each(function(t,r){e.props[r]=t}),function(t){var e=Graph.defer(),n={},i={},o=0,s=0;return t.shapes().each(function(t,a,p){var h,c,l=t.props,u=JSON.parse(t.params),d=Graph.ns(l.type);c=_.delay(function(t,s,a){if(clearTimeout(c),c=null,h=Graph.factory(t,[s]),h.params=a,h.render(r),s.client_pool&&(void 0===i[s.client_pool]&&(i[s.client_pool]=[]),i[s.client_pool].push(h)),void 0!==n[s.parent_id]){n[s.parent_id].addChild(h,!1);var l=h.connectable().component();l&&l.dirty(!0)}if(n[s.id]=h,++o===p){var u,d,f;for(d in i)u=i[d],f=null,u.length>1&&_.forEach(u,function(t,e){f?(t.tree.pool=f,f.insert(t)):f=t.pool()}),f&&f.invalidate();e.resolve(n)}},100*s,d,l,u),s++}),e.promise()}(n).then(function(t){n.links().each(function(e){
var r=e.props,n=JSON.parse(e.params),i=t[r.source_id],o=t[r.target_id];if(i&&o){var s=i.connectable().plugin(),a=o.connectable().plugin();if(s&&a){s.connect(a,null,null,e.props).params=n}}}),e.rendering.active=!1,n.destroy(),n=null,e.paper().snapper().refresh()}))},toString:function(){return"Graph.diagram.type.Activity"},toJson:function(){var t={props:{id:this.props.id,name:this.props.name,type:this.toString(),description:this.props.description,cover:this.props.cover},shapes:[],links:[]},e=this.getShapes(),r=this.getLinks();return e.each(function(e){var r=e.toJson();t.shapes.push({props:r.props,params:r.params})}),r.each(function(e){var r=e.toJson();t.links.push({props:r.props,params:r.params})}),e=r=null,t}})}(),function(){Graph.popup.Dialog=Graph.extend({props:{opened:!1},components:{element:null,backdrop:null},handlers:{backdrop_click:null},constructor:function(t,e){var r=this,n=r.components,i=r.handlers;n.element=Graph.$(t),e.buttons&&_.forEach(e.buttons,function(t,e){var o=Graph.$(t.element,n.element);if(o.length()){var s="button"+e,a=s+"_click";n[s]=o,_.isFunction(t.onclick)&&(i[a]=_.bind(function(e){t.onclick.call(r,e)},r),o.on("click",i[a])),s=a=null}o=null})},element:function(){return this.components.element},open:function(){this.props.opened||(this.element().addClass("open"),this.props.opened=!0,this.center(),this.backdrop())},close:function(){var t=this.components,e=this.handlers,r=t.backdrop;if(this.element().removeClass("open"),this.props.opened=!1,e.backdrop_click){r.off("click",e.backdrop_click),e.backdrop_click=null;var n=+r.data("user");n--,n<=0&&(n=0,r.detach()),r.data("user",n)}_.forOwn(e,function(r,n){var i=_.split(n,"_"),o=i[0],s=i[1];r&&t[o]&&s&&(t[o].off(s,r),e[n]=null),i=o=s=null}),this.fire("close")},center:_.debounce(function(){var t=this.element(),e=t.width(),r=t.height();t.css({top:"50%",left:"50%","margin-top":-r/2,"margin-left":-e/2})},0),backdrop:function(){var t=this,e=Graph.$(".graph-dialog-backdrop");e.length()||(e=Graph.$('<div class="graph-dialog-backdrop"/>'),e.data("user",0),e.on("click",function(t){t.stopPropagation()})),t.handlers.backdrop_click=function(){t.close()},e.on("click",t.handlers.backdrop_click);var r=+e.data("user");r++,e.data("user",r),t.components.element.before(e),t.components.backdrop=e},toString:function(){return"Graph.popup.Dialog"},destroy:function(){this.components.element=null}}),Graph.dialog=function(t,e){return new Graph.popup.Dialog(t,e)}}(),function(){var t=document;Graph(function(){var e=t,r=function(t,e,r){t.addEventListener?t.addEventListener(e,r,!1):t.attachEvent("on"+e,r)};r(e,"mousedown",function(t){var e,r,n;e=Graph.$(Graph.event.target(t)),r=e.data(Graph.string.ID_VECTOR),r&&(r=Graph.registry.vector.get(r),n=r.paper(),Graph.cached.paper=n?n.guid():null),r=n=null}),r(e,"keydown",function(t){var e;Graph.event.isNavigation(t)?(e=Graph.cached.paper)&&(e=Graph.registry.vector.get(e),t.originalType="keynavdown",
e.fire(t)):(t.ctrlKey||t.cmdKey)&&(e=Graph.cached.paper)&&(e=Graph.registry.vector.get(e),t.keyCode===Graph.event.C?(t.originalType="keycopy",e.fire(t)):t.keyCode===Graph.event.V&&(t.originalType="keypaste",e.fire(t)))}),r(e,"keyup",function(t){if(Graph.event.isNavigation(t)){var e=Graph.cached.paper;e&&(e=Graph.registry.vector.get(e),t.originalType="keynavup",e.fire(t))}})}),function(t){var e,r=function(){_.forEach(Graph.BOOTSTRAPS,function(t){t()})},n=function(){t.removeEventListener("DOMContentLoaded",n,!1),t.readyState="complete"},i=function(){"complete"!=t.readyState?e=_.delay(function(){clearTimeout(e),e=null,i()},10):r()};null==t.readyState&&t.addEventListener&&(t.addEventListener("DOMContentLoaded",n,!1),t.readyState="loading"),i()}(t)}();
//# sourceMappingURL=graph.min.js.map
